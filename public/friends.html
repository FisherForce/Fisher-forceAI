<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Amis FisherForce</title>
  <style>
    body { font-family: Arial; background: #f0fff9; padding: 20px; text-align: center; margin: 0; }
    .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,212,170,0.2); max-width: 500px; margin: 20px auto; }
    input { width: 80%; padding: 12px; border-radius: 12px; border: 2px solid #00d4aa; font-size: 16px; margin: 10px; }
    button { background: #00d4aa; color: white; padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; margin: 10px; font-weight: bold; }
    button:hover { background: #00a085; }
    .friend { background: #e6fffa; padding: 15px; border-radius: 15px; margin: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
    .pending { background: #fff3cd; }
    .status { color: #00d4aa; font-weight: bold; margin-bottom: 20px; }
    .loading { color: #00d4aa; font-style: italic; }
  </style>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBrPTS4cWiSX6-gi-NVjQ3SJYLoAWzr8Xw",
      authDomain: "fisher-forceai.firebaseapp.com",
      projectId: "fisher-forceai",
      storageBucket: "fisher-forceai.firebasestorage.app",
      messagingSenderId: "293964630939",
      appId: "1:293964630939:web:063ed88456613a33e96f3e",
      measurementId: "G-3H9E51FWXY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div class="card">
    <h1>Amis FisherForce</h1>
    <p class="status">Connecté en tant que <span id="userName">Thao</span></p>

    <input type="text" id="searchFriend" placeholder="Rechercher un pseudo...">
    <button onclick="searchFriend()">Rechercher</button>
    <div id="searchResults"></div>

    <h2>Mes amis</h2>
    <div id="friendsList">Chargement...</div>

    <h2>Demandes en attente</h2>
    <div id="pendingRequests">Aucune demande</div>
  </div>

  <script>
    let currentUser = null;

    // CHARGE LE PSEUDO
    const savedPseudo = localStorage.getItem('fisherPseudo') || 'Thao';
    document.getElementById('userName').textContent = savedPseudo;

    // ATTEND QUE FIREBASE SOIT CHARGÉ
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof firebase === 'undefined') {
        document.getElementById('searchResults').innerHTML = '<p style="color:#e74c3c;">Firebase non chargé. Recharge la page.</p>';
        return;
      }

      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          loadFriends();
          loadPendingRequests();
        } else {
          alert('Connecte-toi pour voir tes amis.');
          window.close();
        }
      });
    });

    // RECHERCHE RÉELLE DANS FIRESTORE
    function searchFriend() {
      const query = document.getElementById('searchFriend').value.trim().toLowerCase();
      if (!query || !currentUser) return alert('Tape un pseudo ou connecte-toi.');

      db.collection('users').where('displayName', '>=', query).where('displayName', '<=', query + '\uf8ff').get().then(snap => {
        const results = document.getElementById('searchResults');
        results.innerHTML = '';
        if (snap.empty) {
          results.innerHTML = '<p style="color:#e74c3c;">Aucun pêcheur trouvé</p>';
          return;
        }
        snap.forEach(doc => {
          const data = doc.data();
          if (doc.id !== currentUser.uid) {
            results.innerHTML += `
              <div class="friend">
                <div>
                  <strong>${data.displayName || 'Anonyme'}</strong> — ${data.xp || 0} XP (${data.level || 'Débutant'})
                </div>
                <button onclick="addFriend('${doc.id}', '${data.displayName || 'Anonyme'}')">Ajouter</button>
              </div>`;
          }
        });
      }).catch(err => {
        console.error("Erreur recherche :", err);
        document.getElementById('searchResults').innerHTML = '<p style="color:#e74c3c;">Erreur de recherche. Réessaye.</p>';
      });
    }

    // ENVOYER DEMANDE
    function addFriend(uid, name) {
      if (!currentUser) return alert('Connecte-toi !');
      db.collection('friendRequests').add({
        from: currentUser.uid,
        to: uid,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        fromName: localStorage.getItem('fisherPseudo') || currentUser.displayName,
        toName: name
      }).then(() => {
        alert(`Demande envoyée à ${name} !`);
        document.getElementById('searchFriend').value = '';
        searchFriend();
      }).catch(err => alert("Erreur : " + err.message));
    }

    // CHARGER AMIS
    function loadFriends() {
      db.collection('friendRequests').where('status', '==', 'accepted').where('from', '==', currentUser.uid).get().then(snap => {
        const list = document.getElementById('friendsList');
        list.innerHTML = '';
        snap.forEach(doc => {
          const data = doc.data();
          list.innerHTML += `<div class="friend"><strong>${data.toName}</strong> — ${data.toXP || 0} XP</div>`;
        });
        if (snap.empty) list.innerHTML = 'Aucun ami pour l’instant';
      }).catch(err => {
        console.error("Erreur amis :", err);
        document.getElementById('friendsList').innerHTML = 'Erreur de chargement';
      });
    }

    // CHARGER DEMANDES
    function loadPendingRequests() {
      db.collection('friendRequests').where('to', '==', currentUser.uid).where('status', '==', 'pending').get().then(snap => {
        const list = document.getElementById('pendingRequests');
        list.innerHTML = '';
        snap.forEach(doc => {
          const data = doc.data();
          list.innerHTML += `<div class="pending">
            <strong>${data.fromName}</strong> demande d'amitié
            <button onclick="acceptRequest('${doc.id}')">Accepter</button>
            <button onclick="rejectRequest('${doc.id}')">Refuser</button>
          </div>`;
        });
        if (snap.empty) list.innerHTML = 'Aucune demande';
      }).catch(err => {
        console.error("Erreur demandes :", err);
        document.getElementById('pendingRequests').innerHTML = 'Erreur de chargement';
      });
    }

    function acceptRequest(reqId) {
      db.collection('friendRequests').doc(reqId).update({ status: 'accepted' }).then(() => {
        alert('Ami ajouté !');
        loadFriends();
        loadPendingRequests();
      }).catch(err => alert("Erreur : " + err.message));
    }

    function rejectRequest(reqId) {
      db.collection('friendRequests').doc(reqId).delete().then(() => {
        alert('Demande refusée.');
        loadPendingRequests();
      });
    }
  </script>
</body>
</html>
