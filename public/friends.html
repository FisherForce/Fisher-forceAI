<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Amis FisherForce</title>
  <style>
    body { font-family: Arial; background: #f0fff9; padding: 20px; text-align: center; margin: 0; }
    .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,212,170,0.2); max-width: 500px; margin: 20px auto; }
    input { width: 80%; padding: 12px; border-radius: 12px; border: 2px solid #00d4aa; font-size: 16px; margin: 10px; }
    button { background: #00d4aa; color: white; padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; margin: 10px; font-weight: bold; }
    button:hover { background: #00a085; }
    .friend { background: #e6fffa; padding: 15px; border-radius: 15px; margin: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
    .pending { background: #fff3cd; }
    .status { color: #00d4aa; font-weight: bold; margin-bottom: 20px; }
  </style>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBrPTS4cWiSX6-gi-NVjQ3SJYLoAWzr8Xw",
    authDomain: "fisher-forceai.firebaseapp.com",
    projectId: "fisher-forceai",
    storageBucket: "fisher-forceai.firebasestorage.app",
    messagingSenderId: "293964630939",
    appId: "1:293964630939:web:063ed88456613a33e96f3e"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore(); // CORRECT
  const storage = firebase.storage();
</script>
</head>
<body>
  <h2>Spots dominés par les amis</h2>
<div id="spotMasters">Chargement des territoires...</div>

<script>
  // CHARGE LES SPOTS + MAÎTRES
  function loadSpotMasters() {
    db.collection('catches').onSnapshot(snap => {
      const masters = {};
      const spotNames = {};

      snap.forEach(doc => {
        const d = doc.data();
        const key = d.spotKey;
        if (!masters[key]) masters[key] = {};
        masters[key][d.uid] = (masters[key][d.uid] || 0) + 1;
        spotNames[key] = `Spot ${key}`;
      });

      const list = document.getElementById('spotMasters');
      list.innerHTML = '';

      Object.keys(masters).forEach(key => {
        const counts = masters[key];
        const masterUid = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        const masterCount = counts[masterUid];

        // Récupère le pseudo du maître
        db.collection('users').doc(masterUid).get().then(doc => {
          if (doc.exists) {
            const pseudo = doc.data().displayName;
            list.innerHTML += `
              <div class="friend" style="background:#fffacd;">
                <strong>${pseudo}</strong> domine le <strong>Spot ${key}</strong><br>
                <small>${masterCount} prises</small>
              </div>`;
          }
        });
      });

      if (Object.keys(masters).length === 0) {
        list.innerHTML = 'Aucun spot conquis pour l’instant';
      }
    });
  }

  // APPELLE ÇA APRÈS auth.onAuthStateChanged
  auth.onAuthStateChanged(user => {
    if (user) {
      // ... ton code existant ...
      loadSpotMasters();
    }
  });
</script>
  <div class="card">
    <h1>Amis FisherForce</h1>
    <p class="status">Connecté en tant que <span id="userName">Thao</span></p>

    <input type="text" id="searchFriend" placeholder="Rechercher un pseudo...">
    <button onclick="searchFriend()">Rechercher</button>
    <div id="searchResults"></div>

    <h2>Mes amis</h2>
    <div id="friendsList">Chargement...</div>

    <h2>Demandes en attente</h2>
    <div id="pendingRequests">Aucune demande</div>
  </div>

  <script>
    let currentUser = null;
    let currentPseudo = 'Thao';

    // CHARGE LE PSEUDO
    document.getElementById('userName').textContent = localStorage.getItem('fisherPseudo') || 'Thao';

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        currentPseudo = localStorage.getItem('fisherPseudo') || user.displayName.split(' ')[0];
        document.getElementById('userName').textContent = currentPseudo;

        // Crée le profil dans RTDB
        db.ref('users/' + user.uid).set({
          name: currentPseudo,
          xp: 0,
          level: 'Débutant'
        });

        loadFriends();
        loadPendingRequests();
      } else {
        alert('Connecte-toi !');
        window.close();
      }
    });

    // RECHERCHE DANS RTDB
    function searchFriend() {
      const query = document.getElementById('searchFriend').value.trim().toLowerCase();
      if (!query) return;

      db.ref('users').orderByChild('name').startAt(query).endAt(query + '\uf8ff').once('value', snap => {
        const results = document.getElementById('searchResults');
        results.innerHTML = '';
        if (!snap.exists()) {
          results.innerHTML = '<p style="color:#e74c3c;">Aucun pêcheur trouvé</p>';
          return;
        }
        snap.forEach(child => {
          const data = child.val();
          if (child.key !== currentUser.uid) {
            results.innerHTML += `
              <div class="friend">
                <div><strong>${data.name}</strong> — ${data.xp} XP</div>
                <button onclick="sendRequest('${child.key}', '${data.name}')">Ajouter</button>
              </div>`;
          }
        });
      });
    }

    // ENVOYER DEMANDE
    function sendRequest(uid, name) {
      const reqId = db.ref('requests').push().key;
      db.ref('requests/' + reqId).set({
        from: currentUser.uid,
        fromName: currentPseudo,
        to: uid,
        toName: name,
        status: 'pending'
      }).then(() => {
        alert(`Demande envoyée à ${name} !`);
        document.getElementById('searchFriend').value = '';
      });
    }

    // CHARGER AMIS
    function loadFriends() {
      db.ref('requests').orderByChild('status').equalTo('accepted').on('value', snap => {
        const list = document.getElementById('friendsList');
        list.innerHTML = '';
        let hasFriends = false;
        snap.forEach(child => {
          const r = child.val();
          if (r.from === currentUser.uid || r.to === currentUser.uid) {
            hasFriends = true;
            const friendName = r.from === currentUser.uid ? r.toName : r.fromName;
            list.innerHTML += `<div class="friend"><strong>${friendName}</strong></div>`;
          }
        });
        if (!hasFriends) list.innerHTML = 'Aucun ami pour l’instant';
      });
    }

    // CHARGER DEMANDES
    function loadPendingRequests() {
      db.ref('requests').orderByChild('to').equalTo(currentUser.uid).on('value', snap => {
        const list = document.getElementById('pendingRequests');
        list.innerHTML = '';
        let hasPending = false;
        snap.forEach(child => {
          const r = child.val();
          if (r.status === 'pending') {
            hasPending = true;
            list.innerHTML += `<div class="pending">
              <strong>${r.fromName}</strong> veut être ton ami
              <button onclick="acceptRequest('${child.key}')">Accepter</button>
            </div>`;
          }
        });
        if (!hasPending) list.innerHTML = 'Aucune demande';
      });
    }

    // ACCEPTER
    function acceptRequest(reqId) {
      db.ref('requests/' + reqId).update({ status: 'accepted' }).then(() => {
        alert('Ami ajouté !');
      });
    }
  </script>
</body>
</html>
