<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Amis FisherForce</title>
  <style>
    body { font-family: Arial; background: #f0fff9; padding: 20px; text-align: center; margin: 0; }
    .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,212,170,0.2); max-width: 500px; margin: 20px auto; }
    input { width: 80%; padding: 12px; border-radius: 12px; border: 2px solid #00d4aa; font-size: 16px; margin: 10px; }
    button { background: #00d4aa; color: white; padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; margin: 10px; font-weight: bold; }
    button:hover { background: #00a085; }
    .friend { background: #e6fffa; padding: 15px; border-radius: 15px; margin: 10px; text-align: left; }
    .pending { background: #fff3cd; }
    .loading { color: #00d4aa; font-style: italic; }
  </style>

  <!-- FIREBASE (identique à index.html) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // TA CONFIG FIREBASE (identique à index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyBrPTS4cWiSX6-gi-NVjQ3SJYLoAWzr8Xw",
      authDomain: "fisher-forceai.firebaseapp.com",
      projectId: "fisher-forceai",
      storageBucket: "fisher-forceai.firebasestorage.app",
      messagingSenderId: "293964630939",
      appId: "1:293964630939:web:063ed88456613a33e96f3e",
      measurementId: "G-3H9E51FWXY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div class="card">
    <h1>Amis FisherForce</h1>
    <p id="loading" class="loading">Connexion en cours...</p>
    <input type="text" id="searchFriend" placeholder="Rechercher un pseudo...">
    <button onclick="searchFriend()">Rechercher</button>
    <div id="searchResults"></div>

    <h2>Mes amis</h2>
    <div id="friendsList">Chargement...</div>

    <h2>Demandes en attente</h2>
    <div id="pendingRequests"></div>
  </div>

  <script>
    let currentUser = null;

    // ATTEND QUE FIREBASE SOIT CHARGÉ
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof firebase === 'undefined') {
        document.getElementById('loading').textContent = 'Firebase non chargé. Recharge la page.';
        return;
      }

      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          document.getElementById('loading').style.display = 'none';
          loadFriends();
          loadPendingRequests();
        } else {
          document.getElementById('loading').textContent = 'Connecte-toi pour voir tes amis.';
        }
      });
    });

    function searchFriend() {
      const pseudo = document.getElementById('searchFriend').value.trim();
      if (!pseudo || !currentUser) return alert('Connecte-toi ou tape un pseudo.');

      db.collection('users').where('displayName', '>=', pseudo).where('displayName', '<=', pseudo + '\uf8ff').get().then(snap => {
        const results = document.getElementById('searchResults');
        results.innerHTML = '';
        snap.forEach(doc => {
          const data = doc.data();
          if (doc.id !== currentUser.uid) {
            results.innerHTML += `<div class="friend">
              <strong>${data.displayName || 'Anonyme'}</strong> — ${data.xp || 0} XP (${data.level || 'Débutant'})
              <button onclick="addFriend('${doc.id}', '${data.displayName}')">Ajouter</button>
            </div>`;
          }
        });
      }).catch(err => console.error("Erreur recherche :", err));
    }

    function addFriend(uid, name) {
      if (!currentUser) return alert('Connecte-toi !');
      db.collection('friendRequests').add({
        from: currentUser.uid,
        to: uid,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        fromName: currentUser.displayName,
        toName: name
      }).then(() => {
        alert(`Demande envoyée à ${name} !`);
      }).catch(err => alert("Erreur : " + err.message));
    }

    function loadFriends() {
      db.collection('friendRequests').where('status', '==', 'accepted').where('from', '==', currentUser.uid).get().then(snap => {
        const list = document.getElementById('friendsList');
        list.innerHTML = '';
        snap.forEach(doc => {
          const data = doc.data();
          list.innerHTML += `<div class="friend"><strong>${data.toName}</strong> — ${data.toXP || 0} XP</div>`;
        });
      });
    }

    function loadPendingRequests() {
      db.collection('friendRequests').where('to', '==', currentUser.uid).where('status', '==', 'pending').get().then(snap => {
        const list = document.getElementById('pendingRequests');
        list.innerHTML = '';
        snap.forEach(doc => {
          const data = doc.data();
          list.innerHTML += `<div class="pending"><strong>${data.fromName}</strong> demande d'amitié <button onclick="acceptRequest('${doc.id}')">Accepter</button></div>`;
        });
      });
    }

    function acceptRequest(reqId) {
      db.collection('friendRequests').doc(reqId).update({ status: 'accepted' }).then(() => {
        alert('Ami ajouté !');
        loadFriends();
        loadPendingRequests();
      });
    }
  </script>
</body>
</html>
