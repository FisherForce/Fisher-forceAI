<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Résultat Pêche</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { margin:0; font-family:Arial; background:#f0fff9; }
    #map { width:100%; height:60vh; }
    .form { padding:20px; text-align:center; }
    input, button { margin:5px; padding:10px; font-size:16px; border-radius:10px; }
    button { background:#00d4aa; color:white; border:none; cursor:pointer; }
    .photo { margin:10px; }
    #photoPreview { max-width:100%; border-radius:10px; }
  </style>

  <!-- LEAFLET (gratuit, sans clé) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBrPTS4cWiSX6-gi-NVjQ3SJYLoAWzr8Xw",
      authDomain: "fisher-forceai.firebaseapp.com",
      projectId: "fisher-forceai",
      storageBucket: "fisher-forceai.firebasestorage.app",
      messagingSenderId: "293964630939",
      appId: "1:293964630939:web:063ed88456613a33e96f3e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div id="map"></div>
  <div class="form">
    <h2>Enregistre ta prise</h2>
    <input type="text" id="species" placeholder="Espèce (ex: Brochet)">
    <input type="number" id="weight" placeholder="Poids (kg)" step="0.1">
    <input type="file" id="photo" accept="image/*">
    <img id="photoPreview" style="display:none;">
    <button onclick="saveCatch()">Valider la prise</button>
  </div>

  <script>
    let map, marker, currentPos;
    const SPOT_RADIUS = 25; // ~500m²

    // INIT CARTE
    function initMap() {
      map = L.map('map').setView([47.2, -1.55], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      map.on('click', e => {
        currentPos = e.latlng;
        if (marker) marker.setLatLng(currentPos);
        else marker = L.marker(currentPos).addTo(map);
        alert("Spot sélectionné ! Prends une photo et valide.");
      });
    }

    // SAUVEGARDE PRISE
    function saveCatch() {
      if (!currentPos) return alert("Clique sur la carte !");
      const species = document.getElementById('species').value.trim();
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const photoFile = document.getElementById('photo').files[0];

      auth.onAuthStateChanged(user => {
        if (!user) return alert("Connecte-toi !");

        const spotKey = `${Math.round(currentPos.lat*1000)},${Math.round(currentPos.lng*1000)}`;
        const catchData = {
          uid: user.uid,
          pseudo: localStorage.getItem('fisherPseudo') || user.displayName.split(' ')[0],
          species,
          weight,
          lat: currentPos.lat,
          lng: currentPos.lng,
          spotKey,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // UPLOAD PHOTO
        if (photoFile) {
          const ref = firebase.storage().ref(`catches/${user.uid}/${Date.now()}`);
          ref.put(photoFile).then(snap => {
            snap.ref.getDownloadURL().then(url => {
              catchData.photoURL = url;
              saveToDB(catchData);
            });
          });
        } else {
          saveToDB(catchData);
        }
      });
    }

    function saveToDB(data) {
      db.collection('catches').add(data)
        .then(doc => {
          // ENVOIE À LA PAGE PRINCIPALE
          window.opener.postMessage({
            type: 'ADD_XP',
            success: true,
            speciesName: data.species,
            spotName: data.spotKey
          }, '*');
          alert("Prise enregistrée ! +10 XP (nouveau spot) ou +5 XP");
          window.close();
        });
    }

    // CHARGE LES SPOTS DES AMIS
    function loadFriendsSpots() {
      db.collection('catches').onSnapshot(snap => {
        snap.forEach(doc => {
          const d = doc.data();
          L.circle([d.lat, d.lng], { radius: SPOT_RADIUS, color: '#00d4aa' })
            .addTo(map)
            .bindPopup(`${d.pseudo}: ${d.species} (${d.weight}kg)`);
        });
      });
    }

    initMap();
    auth.onAuthStateChanged(user => { if (user) loadFriendsSpots(); });
  </script>
</body>
</html>
