<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Résultat Pêche - FisherForce AI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { margin:0; font-family:Arial; background:#f0fff9; }
    #map { width:100%; height:60vh; }
    .form { padding:20px; text-align:center; background:white; }
    input, button, select { margin:5px; padding:12px; font-size:16px; border-radius:12px; border:2px solid #00d4aa; width:90%; }
    button { background:#00d4aa; color:white; font-weight:bold; cursor:pointer; }
    button:hover { background:#00a085; }
    .photo { margin:15px 0; }
    #photoPreview { max-width:90%; border-radius:12px; margin-top:10px; display:none; }
    .spot-info { background:#e6fffa; padding:15px; border-radius:12px; margin:10px; }
  </style>

  <!-- LEAFLET (gratuit, sans clé) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBrPTS4cWiSX6-gi-NVjQ3SJYLoAWzr8Xw",
      authDomain: "fisher-forceai.firebaseapp.com",
      projectId: "fisher-forceai",
      storageBucket: "fisher-forceai.firebasestorage.app",
      messagingSenderId: "293964630939",
      appId: "1:293964630939:web:063ed88456613a33e96f3e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
</head>
<body>
  <div id="map"></div>
  <div class="form">
    <div class="spot-info" id="spotInfo">Clique sur la carte pour placer ton spot</div>
    <select id="species">
      <option value="">Espèce pêchée...</option>
      <option>Brochet</option>
      <option>Perche</option>
      <option>Sandre</option>
      <option>Carpe</option>
      <option>Truite</option>
      <option>Black-bass</option>
    </select>
    <input type="number" id="weight" placeholder="Poids (kg)" step="0.1">
    <div class="photo">
      <input type="file" id="photo" accept="image/*">
      <img id="photoPreview">
    </div>
    <button onclick="saveCatch()">VALIDER LA PRISE</button>
  </div>

  <script>
    let map, marker, currentPos;
    const SPOT_RADIUS = 25; // ~500m²

    // INIT CARTE
    function initMap() {
      map = L.map('map').setView([47.2, -1.55], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
      }).addTo(map);

      map.on('click', e => {
        currentPos = e.latlng;
        if (marker) marker.setLatLng(currentPos);
        else marker = L.marker(currentPos).addTo(map);
        document.getElementById('spotInfo').innerHTML = `
          <strong>Spot sélectionné !</strong><br>
          Lat: ${currentPos.lat.toFixed(4)}, Lng: ${currentPos.lng.toFixed(4)}
        `;
      });
    }

    // PREVIEW PHOTO
    document.getElementById('photo').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = document.getElementById('photoPreview');
          img.src = ev.target.result;
          img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // SAUVEGARDE PRISE
    function saveCatch() {
      if (!currentPos) return alert("Clique sur la carte d'abord !");
      const species = document.getElementById('species').value;
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const photoFile = document.getElementById('photo').files[0];

      if (!species) return alert("Choisis une espèce !");

      auth.onAuthStateChanged(user => {
        if (!user) return alert("Connecte-toi d'abord !");

        const spotKey = `${Math.round(currentPos.lat * 1000)},${Math.round(currentPos.lng * 1000)}`;
        const pseudo = localStorage.getItem('fisherPseudo') || user.displayName.split(' ')[0];

        const catchData = {
          uid: user.uid,
          pseudo: pseudo,
          species,
          weight,
          lat: currentPos.lat,
          lng: currentPos.lng,
          spotKey,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // UPLOAD PHOTO
        if (photoFile) {
          const ref = storage.ref(`catches/${user.uid}/${Date.now()}_${photoFile.name}`);
          const task = ref.put(photoFile);
          task.on('state_changed', 
            () => {}, 
            err => alert("Erreur photo : " + err.message),
            () => {
              task.snapshot.ref.getDownloadURL().then(url => {
                catchData.photoURL = url;
                saveToDB(catchData, spotKey);
              });
            }
          );
        } else {
          saveToDB(catchData, spotKey);
        }
      });
    }

    function saveToDB(data, spotKey) {
      db.collection('catches').add(data)
        .then(() => {
          window.opener.postMessage({
            type: 'ADD_XP',
            success: true,
            speciesName: data.species,
            spotKey: spotKey
          }, '*');
          alert("Prise enregistrée ! +10 XP si nouveau spot !");
          window.close();
        })
        .catch(err => alert("Erreur : " + err.message));
    }

    initMap();
  </script>
</body>
</html>
