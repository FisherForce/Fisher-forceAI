<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Résultat - FisherForce AI</title>
  <style>
    body { font-family: Arial; background: #f0fff9; padding: 20px; text-align: center; margin: 0; }
    .container { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,212,170,0.2); }
    label { display: block; margin: 15px 0 5px; text-align: left; font-weight: bold; }
    input, select { width: 100%; padding: 12px; border: 2px solid #00d4aa; border-radius: 10px; box-sizing: border-box; }
    button { width: 100%; padding: 15px; background: #00d4aa; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    button:hover { background: #00a085; }
    #successBtn { background: #27ae60; }
    #failBtn { background: #e74c3c; }
    #successBtn:hover { background: #229954; }
    #failBtn:hover { background: #c0392b; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Enregistrer ta session</h1>
    <p id="spotInfo">Spot : <strong id="spotName">Spot inconnu</strong></p>

    <label style="font-size:18px; color:#00d4aa;">
      <input type="checkbox" id="success"> J'ai pris un poisson !
    </label>

    <div id="details" style="display:none; margin-top:20px;">
      <label>Espèce pêchée</label>
      <input type="text" id="species" placeholder="Ex: brochet, perche, sandre..." required>

      <label>Leurre utilisé</label>
      <input type="text" id="lure" placeholder="Ex: Jerkbait 11cm, Texas rig 10g...">

      <label>Poids (en grammes)</label>
      <input type="number" id="weight" placeholder="Ex: 2850 (pour 2,85 kg)" step="10" min="0">
      <small style="color:#666; text-align:left; display:block; margin-top:5px;">
        500g = perche correcte • 3000g = beau brochet • 8000g = monstre
      </small>
    </div>

    <button id="successBtn" onclick="sendResult(true)">OUI ! Enregistrer la prise</button>
    <button id="failBtn" onclick="sendResult(false)">NON, bredouille</button>
  </div>

  <script>
    // Récupère le spot depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const spot = decodeURIComponent(urlParams.get('spot') || "Spot inconnu");
    document.getElementById('spotName').textContent = spot;

    // Affiche/masque les détails
    document.getElementById('success').addEventListener('change', function() {
      document.getElementById('details').style.display = this.checked ? 'block' : 'none';
    });

    function sendResult(success) {
      if (success) {
        const species = document.getElementById('species').value.trim();
        const lure = document.getElementById('lure').value.trim();
        const weightInput = document.getElementById('weight').value.trim();
        const poidsGramme = weightInput ? parseInt(weightInput, 10) : 0;

        if (!species) {
          alert("Tu as oublié l'espèce !");
          return;
        }
        if (!weightInput || poidsGramme <= 0) {
          alert("Entre un poids en grammes (ex: 2850 pour 2,85 kg) !");
          return;
        }

        // Envoi complet vers index.html (app.js)
        window.opener.postMessage({
          type: 'ADD_XP',
          success: true,
          speciesName: species,
          poids: poidsGramme,        // ← en grammes (ex: 2850)
          spotName: spot,
          lure: lure || "Inconnu"
        }, '*');

        const poidsKg = (poidsGramme / 1000).toFixed(2);
        alert(`${species.toUpperCase()} de ${poidsKg} kg enregistré ! L'IA arrive avec un message pour toi...`);
      } else {
        // Bredouille
        window.opener.postMessage({
          type: 'ADD_XP',
          success: false,
          speciesName: null,
          poids: 0,
          spotName: spot,
          lure: null
        }, '*');
        alert("Session bredouille enregistrée. Courage, la prochaine sera la bonne !");
      }

      // Ferme la popup
      setTimeout(() => window.close(), 600);
    }
  </script>
</body>
</html>
