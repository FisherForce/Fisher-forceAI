<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©sultat Session - FisherForce AI</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #000811; color: white; margin: 0; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; background: #001122; padding: 30px; border-radius: 20px; box-shadow: 0 15px 50px rgba(0,212,170,0.3); }
    h1 { color: #00ff9d; text-align: center; font-size: 32px; margin-bottom: 30px; }
    label { display: block; margin: 20px 0 10px; font-size: 20px; color: #00d4aa; }
    input, select { width: 100%; padding: 15px; border-radius: 12px; border: none; background: #003366; color: white; font-size: 18px; }
    .photo-preview { margin: 20px 0; text-align: center; }
    .photo-preview img { max-width: 100%; max-height: 400px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    button { width: 100%; padding: 20px; margin-top: 30px; background: #ffd700; color: black; border: none; border-radius: 50px; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 10px 30px rgba(255,215,0,0.4); }
    button:hover { background: #ffeb3b; }
    .success-btn { background: #00ff9d; }
    .success-btn:hover { background: #00ff80; }
    .bredouille-btn { background: #e74c3c; }
    .bredouille-btn:hover { background: #ff6b6b; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì∏ Enregistre ta session</h1>

    <label>Spot de p√™che</label>
    <input type="text" id="spotName" placeholder="Ex: √âtang de la for√™t">

    <label>R√©sultat</label>
    <div style="display:flex;gap:15px;margin:20px 0;">
      <button class="success-btn" onclick="setResult(true)">üé£ Prise !</button>
      <button class="bredouille-btn" onclick="setResult(false)">üòî Bredouille</button>
    </div>

    <div id="successFields" style="display:none;">
      <label>Esp√®ce p√™ch√©e</label>
      <select id="species">
        <option value="">Choisis...</option>
        <option>Brochet</option>
        <option>Perche</option>
        <option>Sandre</option>
        <option>Carpe</option>
        <option>Truite</option>
        <option>Black-bass</option>
        <option>Silure</option>
        <option>Autre</option>
      </select>

      <label>Poids (en grammes)</label>
      <input type="number" id="poids" placeholder="Ex: 2500 pour 2,5 kg">

      <label>Leurre utilis√©</label>
      <input type="text" id="lure" placeholder="Ex: Shad blanc 12cm">
    </div>

    <!-- PHOTO FACULTATIVE -->
    <label>Photo de la prise (facultatif)</label>
    <p style="color:#aaa;font-size:16px;margin:10px 0 20px;">Ajoute une photo pour immortaliser ton poisson !</p>
    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none;">
    <button type="button" onclick="document.getElementById('photoInput').click()" style="width:100%;padding:18px;background:#003366;color:#00ff9d;border:2px dashed #00d4aa;border-radius:15px;font-size:18px;">
      üì∑ Ajouter une photo
    </button>

    <div class="photo-preview" id="photoPreview" style="display:none;">
      <p style="color:#00ff9d;margin:20px 0 10px;">Aper√ßu :</p>
      <img id="previewImg">
      <button onclick="removePhoto()" style="margin-top:15px;background:#e74c3c;padding:10px 20px;border:none;border-radius:50px;color:white;font-weight:bold;">
        Supprimer la photo
      </button>
    </div>

    <button onclick="saveResult()">üíæ Enregistrer la session</button>
  </div>

  <script>
    let isSuccess = null;
    let photoData = null;

    function setResult(success) {
      isSuccess = success;
      document.getElementById('successFields').style.display = success ? 'block' : 'none';
      // R√©initialise les champs si bredouille
      if (!success) {
        document.getElementById('species').value = '';
        document.getElementById('poids').value = '';
        document.getElementById('lure').value = '';
      }
    }

    // Gestion photo
    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          photoData = ev.target.result;
          document.getElementById('previewImg').src = photoData;
          document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    function removePhoto() {
      photoData = null;
      document.getElementById('photoInput').value = '';
      document.getElementById('photoPreview').style.display = 'none';
    }

function saveResult() {
  if (isSuccess === null) {
    alert("Choisis Prise ou Bredouille !");
    return;
  }

  const spotName = document.getElementById('spotName').value.trim() || "Spot inconnu";
  const lure = document.getElementById('lure').value.trim() || "Inconnu";
  let speciesName = "";
  let poids = 0;

  if (isSuccess) {
    speciesName = document.getElementById('species').value.trim();
    poids = parseInt(document.getElementById('poids').value) || 0;
    if (!speciesName || poids === 0) {
      alert("Remplis l'esp√®ce et le poids pour une prise !");
      return;
    }
  }

  // ENVOI CORRECT AU PARENT AVEC PHOTO
  window.opener.postMessage({
    type: 'ADD_XP',
    success: isSuccess,
    speciesName: speciesName || null,
    spotName: spotName,
    lure: lure,
    poids: poids,
    photo: photoData  // ‚Üê photo bien envoy√©e (base64 ou null)
  }, window.location.origin);

  alert(isSuccess ? "Prise enregistr√©e avec succ√®s ! üé£" : "Session enregistr√©e. On reviendra plus fort ! üí™");
  window.close();
}

    // R√©cup√®re le spot depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const spot = urlParams.get('spot');
    if (spot) {
      document.getElementById('spotName').value = decodeURIComponent(spot);
    }
  </script>
</body>
</html>

