<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI — La 1ère IA de pêche 100% Française</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .badge-ia { position: fixed; top: 15px; right: 15px; background: #00d4aa; color: white; padding: 8px 16px; border-radius: 50px; font-weight: bold; font-size: 13px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); z-index: 9999; animation: pulse 2s infinite; }
    .live-badge { position: fixed; top: 15px; left: 15px; background: #00d4aa; color: white; padding: 10px 16px; border-radius: 50px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(0,212,170,0.4); z-index: 9999; display: flex; align-items: center; gap: 8px; animation: pulse 2s infinite; }
    .live-dot { width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: blink 1.5s infinite; }
    .dashboard { background: linear-gradient(135deg, #00d4aa, #00a085); color: white; padding: 18px; border-radius: 16px; margin: 20px 0; text-align: center; box-shadow: 0 8px 20px rgba(0,212,170,0.3); }
    .level-badge { background: #ffd700; color: #000; padding: 6px 14px; border-radius: 30px; font-weight: bold; }
  </style>
</head>
<body>

  <div class="live-badge"><span class="live-dot"></span> IA en direct : <span id="patternCount">42</span> patterns appris</div>

  <!-- AUTH + BOUTON AMIS -->
  <div id="authContainer" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.4);padding:10px 16px;border-radius:30px;">
    <div id="userInfo" style="display:none;color:white;font-weight:bold;align-items:center;gap:10px;">
      <input id="pseudoInput" type="text" placeholder="Ton pseudo" style="padding:6px 10px;border-radius:20px;border:none;font-size:13px;width:100px;">
      <button id="savePseudo" style="background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">OK</button>
      <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:8px 14px;border-radius:25px;font-size:12px;cursor:pointer;">Déco</button>
    </div>
    <button id="loginBtn" style="background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;">Connexion Google</button>

    <!-- BOUTON AMIS -->
    <button id="friendsBtn" style="background:#ffd700;color:#000;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;font-size:14px;">
      Amis (<span id="friendCount">0</span>)
    </button>
  </div>

  <!-- MODALE AMIS -->
  <div id="friendsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:9999;overflow-y:auto;padding:20px;">
    <div style="max-width:420px;margin:0 auto;background:#112233;border-radius:20px;padding:20px;position:relative;">
      <button onclick="document.getElementById('friendsModal').style.display='none'" style="position:absolute;top:10px;right:10px;background:#e74c3c;color:white;border:none;padding:10px 16px;border-radius:50%;font-size:18px;cursor:pointer;">X</button>
      <h2 style="text-align:center;color:#00d4aa;margin:0 0 20px;">Amis FisherForce</h2>
      <div style="background:#333;padding:15px;border-radius:12px;margin-bottom:20px;">
        <input type="text" id="searchFriend" placeholder="Pseudo exact de ton pote" style="width:100%;padding:12px;border:none;border-radius:10px;margin-bottom:10px;">
        <button onclick="addFriendByPseudo()" style="width:100%;background:#00d4aa;color:white;padding:12px;border:none;border-radius:10px;font-weight:bold;">Ajouter cet ami</button>
      </div>
      <div id="friendsList" style="color:white;">Chargement…</div>
    </div>
  </div>

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1ère IA de pêche 100% Française</p>
    </div>
  </header>

  <main class="container main-grid">
    <section class="card input-card">
      <h2>Décris ton spot</h2>
      <label>Nom du spot <input id="spotName" placeholder="Ex: Étang du Moulin"></label>
      <label>Type d'eau<br><select id="waterType"><option>Étang</option><option>Rivière</option><option>Lac</option><option>Canal</option></select></label>
      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>
      <label>Espèce ciblée <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>
      <label>Conditions <input id="conditions" placeholder="Ex: clair, pluie"></label>
      <label>Température (°C)<br><input type="number" id="temperature" placeholder="15"></label>
      <div style="margin-top:15px;">
        <button id="getAdvice">Obtenir des conseils</button>
        <button id="voiceBtn">Commande vocale</button>
        <button id="clearBtn">Réinitialiser</button>
      </div>
    </section>

    <section class="card output-card">
      <h2>Conseils de l'IA</h2>
      <div class="dashboard">
        <h3><span class="level-badge">Débutant</span> — <span id="xp">0</span> XP</h3>
      </div>
      <div id="advice"><p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p></div>
      <button onclick="openResultat()" style="margin:20px auto;display:block;width:90%;background:#00d4aa;color:white;padding:14px;border-radius:10px;font-weight:bold;">
        Enregistrer un résultat
      </button>

      <div id="tab-ranking" class="tab-content">
        <h2>Classement des Pêcheurs</h2>
        <div id="ranking-list" style="margin-top:20px;">
          <p class="muted" style="text-align:center;">Chargement du classement…</p>
        </div>
      </div>
    </section>
  </main>

  <!-- BOUTON CARTE -->
  <button id="openMapBtn" style="position:fixed;bottom:20px;right:20px;background:#00d4aa;color:white;border:none;padding:16px 20px;border-radius:50%;font-size:28px;box-shadow:0 8px 25px rgba(0,212,170,0.6);z-index:9998;cursor:pointer;">
    Map
  </button>

  <!-- MODALE CARTE -->
  <div id="mapModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;">
    <div style="position:relative;width:100%;height:100%;">
      <button onclick="document.getElementById('mapModal').style.display='none'" style="position:absolute;top:15px;right:15px;background:#e74c3c;color:white;border:none;padding:12px 18px;border-radius:50%;font-size:18px;z-index:10000;cursor:pointer;">X</button>
      <h2 id="mapTitle" style="position:absolute;top:15px;left:50%;transform:translateX(-50%);color:#00d4aa;z-index:10000;font-size:26px;text-shadow:0 2px 10px black;">Ma Carte Secrète</h2>
      <div id="fishingMap" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- INITIALISATION FIREBASE + TOUTES LES FONCTIONS (AMIS + CARTE) -->
  <script>
    // CONFIG FIREBASE (METS TA VRAIE CONFIG ICI)
const firebaseConfig = {
  apiKey: "AIzaSyBrPTS4cWiSX6-gi-NVjQ3SJYLoAWzr8Xw",
  authDomain: "fisher-forceai.firebaseapp.com",
  databaseURL: "https://fisher-forceai-default-rtdb.firebaseio.com",
  projectId: "fisher-forceai",
  storageBucket: "fisher-forceai.firebasestorage.app",
  messagingSenderId: "293964630939",
  appId: "1:293964630939:web:c96b2cb554922397e96f3e",
  measurementId: "G-EEYWH9SES8"
};


    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    window.db = db;
    window.auth = auth;
    window.currentUser = null;

    auth.onAuthStateChanged(user => {
      window.currentUser = user;
      if (user) {
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('pseudoInput').value = localStorage.getItem('fisherPseudo') || user.displayName || '';
        loadFriends();
      } else {
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('loginBtn').style.display = 'block';
      }
    });

    // Connexion Google
    document.getElementById('loginBtn').onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    // Déconnexion
    document.getElementById('logoutBtn').onclick = () => auth.signOut();

    // Sauvegarde pseudo
    document.getElementById('savePseudo').onclick = () => {
      const pseudo = document.getElementById('pseudoInput').value.trim();
      if (pseudo && window.currentUser) {
        db.collection('users').doc(window.currentUser.uid).set({ displayName: pseudo }, { merge: true });
        localStorage.setItem('fisherPseudo', pseudo);
      }
    };

    // ==================== AMIS ====================
    function loadFriends() {
      if (!window.currentUser) return;
      db.collection('users').doc(window.currentUser.uid).onSnapshot(doc => {
        const data = doc.data() || {};
        const friends = Object.keys(data.friends || {});
        document.getElementById('friendCount').textContent = friends.length;
        const list = document.getElementById('friendsList');
        if (friends.length === 0) {
          list.innerHTML = '<p style="text-align:center;color:#666;margin-top:30px;">Aucun ami pour l’instant<br>Ajoutes-en avec leur pseudo exact !</p>';
          return;
        }
        list.innerHTML = '<h3 style="color:#00d4aa;text-align:center;margin-bottom:15px;">Tes amis (' + friends.length + ')</h3>';
        friends.forEach(uid => {
          db.collection('users').doc(uid).get().then(snap => {
            const name = snap.data()?.displayName || "Pêcheur mystère";
            list.innerHTML += `
              <div style="background:#333;padding:14px;margin:8px 0;border-radius:12px;display:flex;justify-content:space-between;align-items:center;">
                <strong style="color:white;">${name}</strong>
                <button onclick="showFriendMap('${uid}','${name}')" style="background:#ffd700;color:black;padding:8px 16px;border:none;border-radius:10px;font-weight:bold;">
                  Voir sa carte
                </button>
              </div>`;
          });
        });
      });
    }

    function addFriendByPseudo() {
      const pseudo = document.getElementById('searchFriend').value.trim();
      if (!pseudo) return alert("Entre un pseudo");
      db.collection('users').where('displayName', '==', pseudo).get()
        .then(snap => {
          if (snap.empty) return alert("Pseudo introuvable");
          const uid = snap.docs[0].id;
          if (uid === window.currentUser.uid) return alert("C’est toi !");
          db.collection('users').doc(window.currentUser.uid).update({
            [`friends.${uid}`]: true
          }).then(() => {
            alert(pseudo + " ajouté à tes amis !");
            document.getElementById('searchFriend').value = '';
            loadFriends();
          });
        });
    }

    function showFriendMap(uid, name) {
      document.getElementById('friendsModal').style.display = 'none';
      document.getElementById('mapModal').style.display = 'block';
      document.getElementById('mapTitle').textContent = `Carte secrète de ${name}`;

      setTimeout(() => {
        if (window.personalMap) window.personalMap.remove();
        window.personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.personalMap);

        const spots = JSON.parse(localStorage.getItem('myPersonalSpots_' + uid) || '[]');
        spots.forEach(s => {
          L.marker([s.lat, s.lng], {
            icon: L.divIcon({html: `<div style="background:#ff4757;color:white;padding:10px 16px;border-radius:12px;font-weight:bold;">${s.name}</div>`})
          }).addTo(window.personalMap)
            .bindPopup(`<b style="color:#ff4757;">Spot de ${name}</b><br>${s.name}`);
        });
      }, 300);
    }

    // ==================== CARTE PERSONNELLE ====================
    let personalMap = null;
    function initPersonalMap() {
      if (personalMap) personalMap.remove();
      personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(personalMap);

      const mySpots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
      mySpots.forEach(spot => {
        const marker = L.marker([spot.lat, spot.lng], {
          icon: L.divIcon({
            html: `<div style="background:#00d4aa;color:white;padding:10px 18px;border-radius:16px;font-weight:bolder;font-size:16px;border:4px solid white;box-shadow:0 6px 20px black;">${spot.name}</div>`,
            iconSize: [160, 60], iconAnchor: [80, 60]
          })
        }).addTo(personalMap);

        marker.bindPopup(() => {
          const catches = spot.catches || [];
          const html = catches.length === 0 ? '<p style="color:#aaa;">Aucune prise</p>' : catches.map(c => `
            <div style="margin:8px 0;padding:10px;background:rgba(255,255,255,0.2);border-radius:8px;">
              ${c.photo ? `<img src="${c.photo}" style="width:100%;border-radius:8px;margin-bottom:8px;">` : ''}
              <b>${c.species} — ${c.weight}kg</b><br>${c.lure || 'NC'}<br><small>${c.date}</small>
            </div>`).join('');
          return `<div style="width:280px;"><h3 style="color:#00d4aa;text-align:center;">${spot.name}</h3>${html}
            <button onclick="openCatchForm(${spot.lat},${spot.lng})" style="margin-top:10px;width:100%;background:#ffd700;color:black;padding:12px;border:none;border-radius:10px;font-weight:bold;">+ Prise</button>
          </div>`;
        });
      });

      // Double-clic = nouveau spot
      personalMap.on('dblclick', e => {
        const name = prompt("Nom de ton spot secret :", "Spot légendaire");
        if (!name?.trim()) return;
        const newSpot = { name: name.trim(), lat: e.latlng.lat, lng: e.latlng.lng, date: new Date().toLocaleDateString('fr-FR'), catches: [] };
        const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
        spots.push(newSpot);
        localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
        initPersonalMap();
      });

      // Géoloc
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          personalMap.setView([pos.coords.latitude, pos.coords.longitude], 14);
          L.marker([pos.coords.latitude, pos.coords.longitude], {icon: L.divIcon({html: '<div style="font-size:50px;color:#00ff00;">Person</div>'})})
            .addTo(personalMap).bindPopup("T'es là, Maître !").openPopup();
        });
      }
    }

    function openCatchForm(lat, lng) {
      const species = prompt("Espèce", "Brochet") || "";
      const weight = prompt("Poids (kg)", "8.5") || "0";
      const lure = prompt("Leurre", "") || "";
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
          const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
          const spot = spots.find(s => s.lat === lat && s.lng === lng);
          spot.catches.push({ species, weight: parseFloat(weight), lure, photo: ev.target.result, date: new Date().toLocaleDateString('fr-FR') });
          localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
          alert("Prise ajoutée !");
          initPersonalMap();
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    document.getElementById('openMapBtn').onclick = () => {
      document.getElementById('mapModal').style.display = 'block';
      document.getElementById('mapTitle').textContent = "Ma Carte Secrète";
      setTimeout(initPersonalMap, 300);
    };

    // Ton classement (inchangé)
    document.addEventListener('DOMContentLoaded', () => {
      const wait = () => window.db ? initRanking() : setTimeout(wait, 100);
      wait();
      function initRanking() { /* ton code classement existant */ }
    });
  </script>

  <script src="app.js"></script>
</body>
</html>
