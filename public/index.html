<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI — La 1ère IA de pêche 100% Française</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    @keyframes pulse {0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    @keyframes blink {0%,100%{opacity:1}50%{opacity:0.3}}
    .live-badge {position:fixed;top:15px;left:15px;background:#00d4aa;color:white;padding:10px 16px;border-radius:50px;font-weight:bold;font-size:14px;box-shadow:0 4px 12px rgba(0,212,170,0.4);z-index:9999;display:flex;align-items:center;gap:8px;animation:pulse 2s infinite}
    .live-dot {width:10px;height:10px;background:#fff;border-radius:50%;animation:blink 1.5s infinite}
    .dashboard {background:linear-gradient(135deg,#00d4aa,#00a085);color:white;padding:18px;border-radius:16px;margin:20px 0;text-align:center;box-shadow:0 8px 20px rgba(0,212,170,0.3)}
    .level-badge {background:#ffd700;color:#000;padding:6px 14px;border-radius:30px;font-weight:bold}
    .stats-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin-top:12px}
    .stat-item {background:rgba(255,255,255,0.25);padding:10px;border-radius:10px}
    .player-rank {background:#112233;margin:12px 0;padding:16px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;font-size:16px;transition:all .3s}
    .player-rank.you {background:#00d4aa!important;color:#000;font-weight:bold;box-shadow:0 0 20px rgba(0,212,170,0.6)}
    .rank-num {font-size:24px;font-weight:bold;width:50px;text-align:center}
    .player-name {flex:1;margin-left:15px}
    .player-level {font-size:12px;color:#aaa;margin-top:2px}
    .player-xp {font-weight:bold;color:#ffd700}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="live-badge"><span class="live-dot"></span> IA en direct : <span id="patternCount">42</span> patterns appris</div>

  <!-- AUTH + PSEUDO -->
  <div id="authContainer" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.3);padding:10px 16px;border-radius:30px;">
    <div id="userInfo" style="display:none;color:white;font-weight:bold;align-items:center;gap:10px;">
      <input id="pseudoInput" type="text" placeholder="Ton pseudo" style="padding:6px 10px;border-radius:20px;border:none;font-size:13px;width:100px;">
      <button id="savePseudo" style="background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">OK</button>
      <button id="friendsBtn" style="background:#ffd700;color:#000;border:none;padding:8px 16px;border-radius:25px;font-weight:bold;cursor:pointer;font-size:13px;">Amis</button>
      <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:8px 14px;border-radius:25px;font-size:12px;cursor:pointer;">Déconnexion</button>
    </div>
    <button id="loginBtn" style="background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;">Connexion Google</button>
  </div>

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1ère IA de pêche 100% Française</p>
    </div>
  </header>

  <main class="container main-grid">
    <section class="card input-card">
      <h2>Décris ton spot</h2>
      <label>Nom du spot <input id="spotName" placeholder="Ex: Étang du Moulin"></label>
      <label>Type d'eau<br><select id="waterType"><option>Étang</option><option>Rivière</option><option>Lac</option><option>Canal</option></select></label>
      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>
      <label>Espèce ciblée <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>
      <label>Conditions <input id="conditions" placeholder="Ex: clair, pluie"></label>
      <label>Température (°C)<br><input type="number" id="temperature" placeholder="15"></label>
      <div style="margin-top:15px;">
        <button id="getAdvice">Obtenir des conseils</button>
        <button id="voiceBtn">Commande vocale</button>
        <button id="clearBtn">Réinitialiser</button>
      </div>
    </section>

    <section class="card output-card">
      <h2>Conseils de l'IA</h2>
      <div class="dashboard">
        <h3><span class="level-badge">Débutant</span> — <span id="xp">0</span> XP</h3>
        <div class="stats-grid">
          <div class="stat-item">Spots : <strong id="spotCount">0</strong></div>
          <div class="stat-item">Espèces : <strong id="speciesCount">0</strong></div>
          <div class="stat-item">Réussite : <strong id="successRate">0%</strong></div>
        </div>
      </div>

      <div id="advice"><p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p></div>

      <button onclick="openResultat()" style="margin:20px auto;display:block;width:90%;background:#00d4aa;color:white;border:none;padding:14px;border-radius:10px;font-weight:bold;">
        Enregistrer un résultat
      </button>
      <!-- BOUTON SCANNER DE POISSON (arme absolue) -->
<button id="scanFishBtn" style="margin:20px auto;display:block;width:90%;background:#ff4500;color:white;border:none;padding:18px;border-radius:14px;font-weight:bold;font-size:18px;box-shadow:0 8px 30px rgba(255,69,0,0.6);">
  Scanner un poisson (IA)
</button>

<!-- MODALE RÉSULTAT SCANNER -->
<div id="scanModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);z-index:99999;">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:20px;border-radius:20px;width:90%;max-width:400px;text-align:center;color:white;">
    <h2 style="color:#ff4500;margin:0 0 20px;">Analyse en cours...</h2>
    <div id="scanPreview" style="width:100%;max-height:400px;object-fit:contain;background:black;border-radius:12px;overflow:hidden;">
      <img id="previewImg" style="width:100%;height:100%;object-fit:contain;">
    </div>
    <div id="scanResult" style="margin-top:20px;font-size:18px;line-height:1.8;"></div>
    <button onclick="document.getElementById('scanModal').style.display='none'" style="margin-top:20px;background:#333;padding:12px 30px;border:none;border-radius:10px;color:white;font-weight:bold;">
      Fermer
    </button>
  </div>
</div>

<script>
// ... ton code existant ...

// === SCANNER DE POISSON PAR IA (amélioré avec plus d'espèces) ===
document.getElementById('scanFishBtn').addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById('previewImg').src = ev.target.result;
      document.getElementById('scanModal').style.display = 'block';

      // Simulation IA améliorée (plus d'espèces, plus réaliste)
      setTimeout(() => {
        const resultats = [
          {esp: "Brochet", poids: 8.7, long: 96, age: 7, sante: "Excellente", trophee: 9.8},
          {esp: "Perche", poids: 1.9, long: 48, age: 4, sante: "Parfaite", trophee: 9.2},
          {esp: "Sandre", poids: 6.2, long: 82, age: 6, sante: "Bonne", trophee: 8.9},
          {esp: "Black-bass", poids: 4.1, long: 52, age: 5, sante: "Excellente", trophee: 9.5},
          {esp: "Silure", poids: 28.4, long: 192, age: 12, sante: "Monstrueuse", trophee: 10},
          {esp: "Truite", poids: 2.3, long: 55, age: 3, sante: "Parfaite", trophee: 8.5},
          {esp: "Carpe", poids: 12.5, long: 85, age: 8, sante: "Bonne", trophee: 9.1},
          {esp: "Anguille", poids: 3.8, long: 120, age: 9, sante: "Excellente", trophee: 7.8}
        ];
        const r = resultats[Math.floor(Math.random() * resultats.length)]; // Aléatoire équilibré
        
        document.getElementById('scanResult').innerHTML = `
          <div style="background:#ff4500;padding:16px;border-radius:12px;">
            <h3 style="margin:0;color:white;">${r.esp}</h3>
            <p style="margin:8px 0 0;font-size:24px;font-weight:bold;">${r.poids} kg – ${r.long} cm</p>
          </div>
          <div style="margin-top:15px;background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;">
            Âge estimé : <strong>${r.age} ans</strong><br>
            Santé : <strong>${r.sante}</strong><br>
            Score trophée : <strong style="color:#ffd700;">${r.trophee}/10</strong>
          </div>
          <button onclick="saveScannedFish('${r.esp}',${r.poids},${r.long},'${ev.target.result}')" style="margin-top:20px;background:#00d4aa;padding:14px 30px;border:none;border-radius:12px;color:white;font-weight:bold;font-size:16px;">
            Enregistrer ce monstre
          </button>
        `;
      }, 1800);
    };
    reader.readAsDataURL(file);
  };
  input.click();
});

function saveScannedFish(espece, poids, longueur, photo) {
  const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
  sessions.push({
    success: true,
    species: espece,
    poids: poids * 1000, // en grammes
    longueur: longueur,
    spot: "Spot scanné",
    lure: "IA Magic Scanner",
    photo: photo,
    date: new Date().toISOString()
  });
  localStorage.setItem('fishingSessions', JSON.stringify(sessions));
  alert(`${espece} de ${poids} kg enregistré dans ton palmarès !`);
  document.getElementById('scanModal').style.display = 'none';
}
</script>

      <!-- CLASSEMENT -->
      <div id="tab-ranking" class="tab-content">
        <h2>Classement des Pêcheurs</h2>
        <div id="ranking-list" style="margin-top:20px;">
          <p class="muted" style="text-align:center;">Chargement du classement…</p>
        </div>
      </div>
    </section>
  </main>

  <!-- BOUTON CARTE -->
  <button id="openMapBtn" style="position:fixed;bottom:20px;right:20px;background:#00d4aa;color:white;border:none;padding:16px 20px;border-radius:50%;font-size:28px;box-shadow:0 8px 25px rgba(0,212,170,0.6);z-index:9998;cursor:pointer;">
    Map
  </button>

  <!-- MODALE CARTE PERSONNELLE -->
  <div id="mapModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;">
    <div style="position:relative;width:100%;height:100%;">
      <button onclick="document.getElementById('mapModal').style.display='none'" style="position:absolute;top:15px;right:15px;background:#e74c3c;color:white;border:none;padding:12px 18px;border-radius:50%;font-size:18px;z-index:10000;cursor:pointer;">X</button>
      <h2 style="position:absolute;top:15px;left:50%;transform:translateX(-50%);color:#00d4aa;z-index:10000;font-size:26px;text-shadow:0 2px 10px black;">
        Ma Carte Secrète Personnelle
      </h2>
      <div id="fishingMap" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- SCRIPT CARTE PERSONNELLE + PRISES + PHOTOS (VERSION FINALE) -->
  <script>
    let personalMap = null;
    let personalMarkers = {};

    function initPersonalMap() {
      if (personalMap) personalMap.remove();
      personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap'}).addTo(personalMap);

      const mySpots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');

      mySpots.forEach(spot => {
        const key = spot.lat + '_' + spot.lng;
        const marker = L.marker([spot.lat, spot.lng], {
          icon: L.divIcon({
            html: `<div style="background:#00d4aa;color:white;padding:10px 18px;border-radius:16px;font-weight:bolder;font-size:16px;border:4px solid white;box-shadow:0 6px 20px black;">${spot.name}</div>`,
            iconSize: [160, 60], iconAnchor: [80, 60]
          })
        }).addTo(personalMap);

        marker.bindPopup(() => {
          const catches = spot.catches || [];
          let catchesHTML = catches.length === 0 ? '<p style="color:#aaa;">Aucune prise</p>' : catches.map(c => `
            <div style="margin:8px 0;padding:10px;background:rgba(255,255,255,0.2);border-radius:8px;">
              ${c.photo ? `<img src="${c.photo}" style="width:100%;max-height:150px;object-fit:cover;border-radius:8px;margin-bottom:8px;">` : ''}
              <b>${c.species} — ${c.weight}kg</b><br>Leurre: ${c.lure||'NC'}<br><small>${c.date}</small>
            </div>`).join('');

          return `<div style="width:280px;"><h3 style="margin:0 0 10px;color:#00d4aa;text-align:center;">${spot.name}</h3>${catchesHTML}
            <button onclick="openCatchForm(${spot.lat},${spot.lng})" style="margin-top:10px;width:100%;background:#ffd700;color:black;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">
              Ajouter une prise
            </button></div>`;
        });
      });

      // Sessions classiques
      const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
      sessions.forEach(s => {
        if (s.lat && s.lng) {
          L.marker([s.lat, s.lng], {icon: L.divIcon({html: s.success ? 'Fish' : 'Cross', iconSize: [40,40], iconAnchor: [20,40]})})
            .addTo(personalMap)
            .bindPopup(`<b style="color:${s.success?'#00d4aa':'#e74c3c'};">${s.success?'Prise':'Bredouille'}</b><br>${s.spot}`);
        }
      });

      // Double-clic = nouveau spot
      personalMap.on('dblclick', e => {
        const name = prompt("Nom de ton nouveau spot secret :", "Spot du Maître Thao");
        if (!name || name.trim().length < 2) return;
        const newSpot = {name: name.trim(), lat: e.latlng.lat, lng: e.latlng.lng, date: new Date().toLocaleDateString('fr-FR'), catches: []};
        const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
        spots.push(newSpot);
        localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
        alert(`Spot "${name}" créé !`);
        initPersonalMap();
      });

      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          personalMap.setView([pos.coords.latitude, pos.coords.longitude], 14);
          L.marker([pos.coords.latitude, pos.coords.longitude], {icon: L.divIcon({html: 'Person', iconSize: [50,50], iconAnchor: [25,50]})})
            .addTo(personalMap).bindPopup("T'es là, Légende !").openPopup();
        });
      }
    }

    function openCatchForm(lat, lng) {
      const species = prompt("Espèce", "Brochet") || "";
      const weight = prompt("Poids en kg", "0") || "0";
      const lure = prompt("Leurre ?", "") || "";
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
          const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
          const spot = spots.find(s => s.lat === lat && s.lng === lng);
          spot.catches.push({species, weight: parseFloat(weight), lure, photo: ev.target.result, date: new Date().toLocaleDateString('fr-FR')});
          localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
          alert(`${species} de ${weight}kg ajouté !`);
          initPersonalMap();
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    document.getElementById('openMapBtn').addEventListener('click', () => {
      document.getElementById('mapModal').style.display = 'block';
      setTimeout(initPersonalMap, 300);
    });
  </script>

  <!-- CLASSEMENT + DATE DANS LES CONSEILS (dans app.js) -->
  <script src="app.js"></script>
</body>
</html>
