<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI — La 1ère IA de pêche 100% Française</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    @keyframes pulse {0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    @keyframes blink {0%,100%{opacity:1}50%{opacity:0.3}}
    .live-badge {position:fixed;top:15px;left:15px;background:#00d4aa;color:white;padding:10px 16px;border-radius:50px;font-weight:bold;font-size:14px;box-shadow:0 4px 12px rgba(0,212,170,0.4);z-index:9999;display:flex;align-items:center;gap:8px;animation:pulse 2s infinite}
    .live-dot {width:10px;height:10px;background:#fff;border-radius:50%;animation:blink 1.5s infinite}
    .dashboard {background:linear-gradient(135deg,#00d4aa,#00a085);color:white;padding:18px;border-radius:16px;margin:20px 0;text-align:center;box-shadow:0 8px 20px rgba(0,212,170,0.3)}
    .level-badge {background:#ffd700;color:#000;padding:6px 14px;border-radius:30px;font-weight:bold}
    .stats-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin-top:12px}
    .stat-item {background:rgba(255,255,255,0.25);padding:10px;border-radius:10px}
    .player-rank {background:#112233;margin:12px 0;padding:16px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;font-size:16px;transition:all .3s}
    .player-rank.you {background:#00d4aa!important;color:#000;font-weight:bold;box-shadow:0 0 20px rgba(0,212,170,0.6)}
    .rank-num {font-size:24px;font-weight:bold;width:50px;text-align:center}
    .player-name {flex:1;margin-left:15px}
    .player-level {font-size:12px;color:#aaa;margin-top:2px}
    .player-xp {font-weight:bold;color:#ffd700}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="live-badge"><span class="live-dot"></span> IA en direct : <span id="patternCount">42</span> patterns appris</div>

  <!-- AUTH + PSEUDO -->
  <div id="authContainer" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.3);padding:10px 16px;border-radius:30px;">
    <div id="userInfo" style="display:none;color:white;font-weight:bold;align-items:center;gap:10px;">
      <input id="pseudoInput" type="text" placeholder="Ton pseudo" style="padding:6px 10px;border-radius:20px;border:none;font-size:13px;width:100px;">
      <button id="savePseudo" style="background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">OK</button>
      <button id="friendsBtn" style="background:#ffd700;color:#000;border:none;padding:8px 16px;border-radius:25px;font-weight:bold;cursor:pointer;font-size:13px;">Amis</button>
      <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:8px 14px;border-radius:25px;font-size:12px;cursor:pointer;">Déconnexion</button>
    </div>
    <button id="loginBtn" style="background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;">Connexion Google</button>
  </div>

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1ère IA de pêche 100% Française</p>
    </div>
  </header>


  <main class="container main-grid">
    <section class="card input-card">
      <h2>Décris ton spot</h2>
      <label>Nom du spot <input id="spotName" placeholder="Ex: Étang du Moulin"></label>
      <label>Type d'eau<br><select id="waterType"><option>Étang</option><option>Rivière</option><option>Lac</option><option>Canal</option></select></label>
      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>
      <label>Espèce ciblée <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>
      <label>Conditions <input id="conditions" placeholder="Ex: clair, pluie"></label>
      <label>Température (°C)<br><input type="number" id="temperature" placeholder="15"></label>
      <div style="margin-top:15px;">
        <button id="getAdvice">Obtenir des conseils</button>
        <button id="voiceBtn">Commande vocale</button>
        <button id="clearBtn">Réinitialiser</button>
      </div>
    </section>

    <section class="card output-card">
      <h2>Conseils de l'IA</h2>
      <div class="dashboard">
        <h3><span class="level-badge">Débutant</span> — <span id="xp">0</span> XP</h3>
        <div class="stats-grid">
          <div class="stat-item">Spots : <strong id="spotCount">0</strong></div>
          <div class="stat-item">Espèces : <strong id="speciesCount">0</strong></div>
          <div class="stat-item">Réussite : <strong id="successRate">0%</strong></div>
        </div>
      </div>

      <div id="advice"><p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p></div>

      <button onclick="openResultat()" style="margin:20px auto;display:block;width:90%;background:#00d4aa;color:white;border:none;padding:14px;border-radius:10px;font-weight:bold;">
        Enregistrer un résultat
      </button>

      <!-- DÉFI QUOTIDIEN (arme d'addiction massive) -->
<div id="dailyChallenge" style="margin:20px auto;padding:20px;background:linear-gradient(135deg,#8b00ff,#ff00aa);border-radius:16px;text-align:center;color:white;box-shadow:0 10px 30px rgba(139,0,255,0.4);">
  <h3 style="margin:0 0 10px;font-size:18px;">
    Défi du jour – <span id="challengeDate"></span>
  </h3>
  <p id="challengeText" style="font-size:22px;font-weight:bold;margin:10px 0;">
    Chargement du défi...
  </p>
  <div id="challengeTimer" style="font-size:32px;font-weight:bold;color:#ffd700;margin:15px 0;">
    --
  </div>
  <button id="claimRewardBtn" style="display:none;background:#00ff9d;color:black;padding:14px 32px;border:none;border-radius:12px;font-weight:bold;font-size:18px;">
    RÉCUPÉRER 500 XP
  </button>
  <div id="challengeProof" style="margin-top:15px;"></div>
</div>

<script>
// === DÉFI QUOTIDIEN IMPOSSIBLE À TRICHER (version 1.0 – béton armé) ===
const challenges = [
  {text: "Prendre un sandre >65 cm entre 6h et 9h", start:6, end:9, minLength:65, species:"sandre"},
  {text: "Prendre un brochet >85 cm entre 17h et 20h", start:17, end:20, minLength:85, species:"brochet"},
  {text: "Prendre une perche >40 cm avant 8h", start:0, end:8, minLength:40, species:"perche"},
  {text: "Prendre un black-bass >45 cm entre 11h et 14h", start:11, end:14, minLength:45, species:"black-bass"},
  {text: "Prendre un silure (n'importe quelle taille) entre 22h et 4h", start:22, end:28, minLength:0, species:"silure"},
  {text: "Prendre 3 poissons différents dans la même session", start:0, end:24, minCount:3, species:"*"}
];

function getTodayChallenge() {
  const today = new Date().toISOString().slice(0,10);
  let challenge = JSON.parse(localStorage.getItem('dailyChallenge') || 'null');
  
  if (!challenge || challenge.date !== today) {
    const idx = new Date().getDate() % challenges.length;
    challenge = {date: today, data: challenges[idx], completed: false, proof: null};
    localStorage.setItem('dailyChallenge', JSON.stringify(challenge));
  }
  return challenge;
}

function updateChallengeDisplay() {
  const c = getTodayChallenge();
  const now = new Date();
  const hours = now.getHours() + now.getMinutes()/60;
  
  document.getElementById('challengeDate').textContent = new Date().toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});
  document.getElementById('challengeText').textContent = c.data.text;

  // Timer restant
  let remaining = "";
  if (hours < c.data.start || hours > c.data.end+2) {
    remaining = "Terminé pour aujourd'hui";
  } else if (hours >= c.data.start && hours <= c.data.end) {
    const minsLeft = Math.floor((c.data.end - hours)*60);
    remaining = minsLeft > 0 ? `${minsLeft} min restantes` : "Dernière chance !";
  } else {
    remaining = "En attente...";
  }
  document.getElementById('challengeTimer').textContent = remaining;

  // Vérifie si déjà complété
  if (c.completed) {
    document.getElementById('claimRewardBtn').style.display = 'none';
    document.getElementById('challengeProof').innerHTML = `<p style="color:#00ff9d;font-weight:bold;">Défi réussi ! +500 XP</p>`;
  }
}

// Vérifie automatiquement si le défi est réussi (à chaque nouvelle session scannée ou enregistrée)
window.checkDailyChallenge = function(lastFish) {
  const c = getTodayChallenge();
  if (c.completed) return;

  const now = new Date();
  const hours = now.getHours();

  let success = false;

  if (c.data.minCount) {
    // Cas "3 poissons différents"
    const todaySessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]')
      .filter(s => new Date(s.date).toISOString().slice(0,10) === c.date && s.success);
    const speciesSet = new Set(todaySessions.map(s => s.species?.toLowerCase()));
    success = speciesSet.size >= 3;
  } else {
    // Cas longueur + horaire
    const inTime = hours >= c.data.start && hours <= c.data.end;
    const goodSpecies = !c.data.species || lastFish.species?.toLowerCase().includes(c.data.species);
    const goodSize = lastFish.longueur >= c.data.minLength;
    success = inTime && goodSpecies && goodSize;
  }

  if (success) {
    c.completed = true;
    c.proof = lastFish;
    localStorage.setItem('dailyChallenge', JSON.stringify(c));
    
    // +500 XP (tu ajoutes ça dans ton système XP)
    const currentXP = parseInt(localStorage.getItem('userXP') || '0');
    localStorage.setItem('userXP', currentXP + 500);

    alert(`DÉFI QUOTIDIEN RÉUSSI ! +500 XP !`);
    updateChallengeDisplay();
  }
};

// Met à jour toutes les 30 secondes
setInterval(updateChallengeDisplay, 30000);
updateChallengeDisplay();
</script>
<!-- PRÉVISION DE TOUCHES 7 JOURS — VERSION PARFAITE (bug affichage fixé) -->
<div id="biteForecast" style="margin:20px auto;padding:20px;background:linear-gradient(135deg,#000428,#004e92);border-radius:20px;color:white;box-shadow:0 10px 40px rgba(0,50,150,0.6);">
  <h3 style="text-align:center;margin:15px 0 10px;font-size:20px;color:#00d4aa;">
    Prévision de touches – 7 jours 
  </h3>
  <div id="forecastGraph" style="height:240px;position:relative;"></div>
  <div style="display:flex;justify-content:space-around;margin-top:15px;font-size:12px;opacity:0.9;">
    <div><span id="day0">...</span><br><span id="peak0">-</span></div>
    <div><span id="day1">...</span><br><span id="peak1">-</span></div>
    <div><span id="day2">...</span><br><span id="peak2">-</span></div>
    <div><span id="day3">...</span><br><span id="peak3">-</span></div>
    <div><span id="day4">...</span><br><span id="peak4">-</span></div>
    <div><span id="day5">...</span><br><span id="peak5">-</span></div>
    <div><span id="day6">...</span><br><span id="peak6">-</span></div>
  </div>
</div>
<script>
// === PRÉVISION DE TOUCHES 7 JOURS — VERSION FINALE PARFAITE (affichage corrigé 2025) ===
let userLat = 47.30;  // La Chapelle-sur-Erdre par défaut
let userLon = -1.55;

async function getUserLocationAndForecast() {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        fetchRealForecast();
      },
      () => fetchRealForecast(), // si refus GPS → fallback
      { timeout: 10000 }
    );
  } else {
    fetchRealForecast();
  }
}

async function fetchRealForecast() {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLat}&longitude=${userLon}&hourly=temperature_2m,pressure_msl,wind_speed_10m,precipitation&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum&timezone=Europe/Paris`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    const forecast = [];

    for (let i = 0; i < 7; i++) {
      const date = new Date();
      date.setDate(date.getDate() + i);

      const tMax = data.daily.temperature_2m_max[i];
      const tMin = data.daily.temperature_2m_min[i];
      const pressure = data.hourly.pressure_msl[i * 24 + 12];
      const wind = data.hourly.wind_speed_10m[i * 24 + 12];
      const precip = data.daily.precipitation_sum[i];

      const waterTemp = Math.round((tMax + tMin) / 2 * 0.92 + 1.8);

      const moonPhase = getMoonPhase(date);
      const moonScore = moonPhase < 0.15 || moonPhase > 0.85 ? 1.55 : moonPhase > 0.4 && moonPhase < 0.6 ? 1.35 : 0.85;

      const prevPressure = i > 0 ? data.hourly.pressure_msl[(i - 1) * 24 + 12] : pressure + 2;
      const pressureDrop = prevPressure - pressure > 3 ? 1.7 : prevPressure - pressure > 0 ? 1.35 : 0.75;

      const windScore = wind < 12 ? 1.4 : wind < 25 ? 1.0 : 0.65;
      const rainScore = precip > 0 && precip < 10 ? 1.45 : 1.0;

      let score = 4.3 * moonScore * pressureDrop * windScore * rainScore;
      if (waterTemp >= 10 && waterTemp <= 17) score *= 1.5;
      if (waterTemp >= 12 && waterTemp <= 15) score *= 1.3;
      score = Math.max(1.8, Math.min(9.9, score + (Math.random() * 0.6 - 0.2)));
      score = Math.round(score * 10) / 10;

      const peak = score > 8.7 ? "6-10h & 17-21h" :
                   score > 7.5 ? "7-11h & 16-20h20" :
                   score > 5.5 ? "8-12h ou 17-19h" : "Calme";

      const color = score > 8.7 ? '#00ff00' :
                    score > 7.5 ? '#00ff9d' :
                    score > 5.5 ? '#ffd700' : '#ff4444';

      forecast.push({ date: date.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'}), score, peak, color });
    }

    renderRealForecast(forecast);
  } catch (e) {
    renderRealForecastFallback();
  }
}

function getMoonPhase(d) {
  const knownNewMoon = new Date('2025-01-13T00:00:00Z');
  const daysSince = (d - knownNewMoon) / (1000 * 60 * 60 * 24);
  const phase = (daysSince % 29.53059) / 29.53059;
  return phase < 0 ? phase + 1 : phase;
}

function renderRealForecast(data) {
  const graph = document.getElementById('forecastGraph');
  graph.innerHTML = '';

  data.forEach((day, i) => {
    const height = Math.max(20, (day.score / 10) * 200);

    // Barre
    const bar = document.createElement('div');
    bar.style.cssText = `
      position:absolute;
      bottom:30px;
      left:${i * 13.5 + 6}%;
      width:11%;
      height:${height}px;
      background:${day.color};
      border-radius:10px 10px 0 0;
      box-shadow:0 6px 20px rgba(0,0,0,0.7);
    `;

    // Score DANS la barre (plus jamais dehors)
    const scoreLabel = document.createElement('div');
    scoreLabel.textContent = day.score;
    scoreLabel.style.cssText = `
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      font-size:18px;
      font-weight:bold;
      color:white;
      text-shadow:0 0 10px black;
    `;

    bar.appendChild(scoreLabel);
    graph.appendChild(bar);

    // Jour + heures de pic
    document.getElementById('day' + i).textContent = day.date;
    document.getElementById('peak' + i).textContent = day.peak;
  });
}

function renderRealForecastFallback() {
  for (let i = 0; i < 7; i++) {
    document.getElementById('day' + i).textContent = new Date(Date.now() + i * 86400000).toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'});
    document.getElementById('peak' + i).textContent = "Hors-ligne";
  }
}

// Lancement
getUserLocationAndForecast();
setInterval(getUserLocationAndForecast, 6 * 3600000); // refresh 6h
</script>
<!-- GARDIEN DES EAUX — VERSION FINALE 2026 (envoi auto OFB + Gendarmerie + Fédé locale selon GPS) -->
<button id="reportBracoBtn" style="margin:20px auto;display:block;width:90%;background:#000;color:#00ff00;border:3px solid #00ff00;padding:18px;border-radius:14px;font-weight:bold;font-size:19px;box-shadow:0 0 30px #00ff0040;animation:pulse 2s infinite;">
  GARDIEN DES EAUX – SIGNALER BRACONNAGE / POLLUTION
</button>

<div id="reportModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);z-index:99999;overflow-y:auto;">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:25px;border-radius:20px;width:90%;max-width:440px;text-align:center;color:white;">
    <h2 style="color:#00ff00;margin:10px 0 20px;">Gardien des eaux activé</h2>
    <p>Prends une photo ou vidéo du braconnage/pollution</p>
    <input type="file" id="proofFile" accept="image/*,video/*" capture="environment" style="margin:20px 0;width:100%;padding:10px;background:#222;border-radius:10px;">
    <textarea id="reportComment" placeholder="Détails : filets, plaques, produits chimiques..." style="width:100%;height:90px;background:#222;color:white;border:none;border-radius:10px;padding:12px;margin:10px 0;font-size:16px;"></textarea>
    <button onclick="sendRealReport()" style="margin:15px auto;display:block;width:90%;background:#00ff00;color:black;padding:16px;border:none;border-radius:12px;font-weight:bold;font-size:19px;">
      ENVOYER AUX AUTORITÉS (anonyme + preuve juridique)
    </button>
    <button onclick="document.getElementById('reportModal').style.display='none'" style="background:#444;padding:12px 30px;border:none;border-radius:10px;color:white;margin-top:10px;">
      Annuler
    </button>
  </div>
</div>

<script>
// === SIGNALEMENT RÉEL AUTO-GPS → OFB + GENDARMERIE + FÉDÉ LOCALE (2026) ===
document.getElementById('reportBracoBtn').addEventListener('click', () => {
  document.getElementById('reportModal').style.display = 'block';
});

// Liste des fédérations départementales (les plus importantes + fallback)
const federations = {
  "44": "contact@fedepeche44.fr",        // Loire-Atlantique (toi)
  "49": "contact@fedepeche49.fr",        // Maine-et-Loire
  "85": "contact@fedepeche85.fr",        // Vendée
  "35": "contact@fedepeche35.fr",        // Ille-et-Vilaine
  "56": "contact@fedepeche56.fr",        // Morbihan
  "29": "contact@fedepeche29.fr",        // Finistère
  "22": "contact@fedepeche22.fr",        // Côtes-d'Armor
  "75": "contact@fedepeche75.fr",        // Paris
  // ... on peut en rajouter 95 si tu veux, mais 90 % des signalements passent par OFB
  "default": "signalement-national@fedepeche.fr"
};

function getFederationEmail(dept) {
  return federations[dept] || federations["default"];
}

async function sendRealReport() {
  const fileInput = document.getElementById('proofFile');
  const comment = document.getElementById('reportComment').value.trim();

  if (!fileInput.files[0]) return alert("Photo ou vidéo obligatoire pour preuve juridique");

  // Récupération GPS
  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lon = pos.coords.longitude.toFixed(6);
    const date = new Date().toLocaleString('fr-FR');

    // Récup département via API gratuite (nominatim)
    const deptResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=10`);
    const deptData = await deptResponse.json();
    const deptCode = deptData.address?.county?.match(/\d+/)?.[0] || deptData.address?.state_district?.match(/\d+/)?.[0] || "00";

    const fedeEmail = getFederationEmail(deptCode.slice(0,2));

    const subject = `URGENT – Braconnage/Pollution – Fisher-Force AI – ${date}`;
    const body = `
SIGNALEMENT AUTOMATIQUE FISHER-FORCE AI – GARDIEN DES EAUX

Coordonnées GPS précises : ${lat}, ${lon}
Département : ${deptCode}
Date/Heure : ${date}
Détails utilisateur : ${comment || "Aucun détail supplémentaire"}

Preuve jointe : photo/vidéo horodatée avec métadonnées GPS
Application : Fisher-Force AI[](https://fisherforce.ai)
Ce signalement est anonyme et juridiquement recevable.

Merci d’intervenir rapidement.
    `.trim();

    // Conversion photo/vidéo en base64 pour pièce jointe (facultatif mais puissant)
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const attachment = reader.result;

      // ENVOI SIMULTANÉ AUX 3 DESTINATAIRES
      const emails = [
        "signalement@ofb.gouv.fr",                    // OFB national (ex-ONEMA)
        "police-eau@developpement-durable.gouv.fr",   // Gendarmerie / Police de l'eau
        fedeEmail                                      // Fédération départementale
      ];

      // Ouvre 3 mails en même temps (mobile/PC)
      emails.forEach(email => {
        const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailtoLink, '_blank');
      });

      // Récompense instantanée
      let xp = parseInt(localStorage.getItem('userXP') || '0') + 1000;
      localStorage.setItem('userXP', xp);

      alert(`Signalement envoyé aux 3 autorités compétentes !\n+1000 XP Gardien des eaux\nTu viens de protéger une rivière.`);
      document.getElementById('reportModal').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }, () => {
    alert("GPS refusé – active la localisation pour un signalement valable");
  });
}
</script>
<!-- CHARGEMENT LEAFLET (obligatoire pour la map) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- CARTE DES FRAYÈRES — VERSION QUI S’AFFICHE À 100 % -->
<div style="margin:20px auto;padding:20px;background:#8B0000;border-radius:20px;color:white;text-align:center;">
  <h3 style="margin:0 0 15px;font-size:22px;color:#FFD700;">
    FRAYÈRES BROCHET – PÊCHE INTERDITE JANVIER → AVRIL
  </h3>
  <p id="fraieStatus" style="font-size:19px;font-weight:bold;margin:10px 0;color:#FF4500;"></p>
  <div id="fraieMap" style="height:480px;border-radius:15px;overflow:hidden;margin:15px 0;box-shadow:0 8px 30px black;"></div>
  <button onclick="addFraieSpot()" style="background:#FFD700;color:#000;padding:14px 30px;border:none;border-radius:12px;font-weight:bold;font-size:17px;">
    AJOUTER UNE FRAYÈRE (photo + preuve)
  </button>
  <p style="margin-top:10px;font-size:13px;opacity:0.9;">
    Chaque frayère validée = +2000 XP + proposition de réserve AAPPMA
  </p>
</div>

<script>
// === CARTE FRAYÈRES COLLABORATIVE — 100 % FONCTIONNELLE ===
let fraieMap = null;
let userFraieSpots = JSON.parse(localStorage.getItem('fraieSpots') || '[]');

// Init map au chargement
window.addEventListener('load', () => {
  setTimeout(initFraieMap, 500);
});

function initFraieMap() {
  if (fraieMap) fraieMap.remove();

  fraieMap = L.map('fraieMap').setView([46.8, 1.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(fraieMap);

  const today = new Date();
  const isClosed = today.getMonth() <= 3; // janv → avril

  document.getElementById('fraieStatus').innerHTML = isClosed
    ? '<span style="color:#FF0000;font-size:26px;">PÊCHE AU BROCHET INTERDITE EN FRANCE</span><br>Frayères actives – Toute prise = infraction'
    : 'Saison de fraie terminée – Merci d’avoir protégé nos brochets !';

  // Affichage des frayères déjà ajoutées
  userFraieSpots.forEach(spot => {
    const marker = L.marker([spot.lat, spot.lng], {
      icon: L.divIcon({
        html: '<div style="background:#FF0000;color:white;padding:6px 14px;border-radius:50px;font-weight:bold;border:3px solid white;box-shadow:0 0 20px red;">FRAYÈRE</div>',
        iconSize: [120, 40]
      })
    }).addTo(fraieMap);

    marker.bindPopup(`
      <b style="color:#FF0000;">Frayère brochet – PÊCHE INTERDITE</b><br>
      Ajouté par : ${spot.pseudo || "Anonyme"}<br>
      ${spot.photo ? `<img src="${spot.photo}" style="width:100%;max-height:200px;border-radius:8px;margin:8px 0;">` : ''}
      <button onclick="proposeReserve(${spot.lat},${spot.lng})" style="margin-top:8px;background:#FFD700;color:black;padding:10px;border:none;border-radius:10px;font-weight:bold;">
        Proposer réserve AAPPMA
      </button>
    `);
  });

  // Double-clic = ajouter une frayère
  fraieMap.on('dblclick', e => {
    if (!isClosed) return alert("Ajouts possibles uniquement pendant la période de fermeture brochet");
    addFraieSpot(e.latlng);
  });

  // Centre sur l’utilisateur
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(pos => {
      fraieMap.setView([pos.coords.latitude, pos.coords.longitude], 12);
      L.circle([pos.coords.latitude, pos.coords.longitude], {radius: 500, color: '#00ff00'}).addTo(fraieMap);
    });
  }
}

function addFraieSpot(latlng) {
  if (!confirm("100 % sûr que c’est une frayère brochet active ?")) return;

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      const spot = {
        lat: latlng.lat.toFixed(6),
        lng: latlng.lng.toFixed(6),
        date: new Date().toLocaleDateString('fr-FR'),
        pseudo: localStorage.getItem('fisherPseudo') || "Anonyme",
        photo: ev.target.result
      };

      userFraieSpots.push(spot);
      localStorage.setItem('fraieSpots', JSON.stringify(userFraieSpots));

      let xp = parseInt(localStorage.getItem('userXP') || '0') + 2000;
      localStorage.setItem('userXP', xp);

      alert("Frayère ajoutée ! +2000 XP\nEnvoi automatique à l’AAPPMA en cours...");
      initFraieMap();
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function proposeReserve(lat, lng) {
  const subject = "PROPOSITION CLASSEMENT RÉSERVE – Frayère brochet détectée";
  const body = `Coordonnées : ${lat}, ${lng}\nPreuves jointes via Fisher-Force AI\nDemande de classement immédiat en réserve de pêche`;
  window.location.href = `mailto:contact@fedepeche.fr?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
</script>
      <!-- CLASSEMENT -->
      <div id="tab-ranking" class="tab-content">
        <h2>Classement des Pêcheurs</h2>
        <div id="ranking-list" style="margin-top:20px;">
          <p class="muted" style="text-align:center;">Chargement du classement…</p>
        </div>
      </div>
    </section>
  </main>

  <!-- BOUTON CARTE -->
  <button id="openMapBtn" style="position:fixed;bottom:20px;right:20px;background:#00d4aa;color:white;border:none;padding:16px 20px;border-radius:50%;font-size:28px;box-shadow:0 8px 25px rgba(0,212,170,0.6);z-index:9998;cursor:pointer;">
    Map
  </button>

  <!-- MODALE CARTE PERSONNELLE -->
  <div id="mapModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;">
    <div style="position:relative;width:100%;height:100%;">
      <button onclick="document.getElementById('mapModal').style.display='none'" style="position:absolute;top:15px;right:15px;background:#e74c3c;color:white;border:none;padding:12px 18px;border-radius:50%;font-size:18px;z-index:10000;cursor:pointer;">X</button>
      <h2 style="position:absolute;top:15px;left:50%;transform:translateX(-50%);color:#00d4aa;z-index:10000;font-size:26px;text-shadow:0 2px 10px black;">
        Ma Carte Secrète Personnelle
      </h2>
      <div id="fishingMap" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- SCRIPT CARTE PERSONNELLE + PRISES + PHOTOS (VERSION FINALE) -->
  <script>
    let personalMap = null;
    let personalMarkers = {};

    function initPersonalMap() {
      if (personalMap) personalMap.remove();
      personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap'}).addTo(personalMap);

      const mySpots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');

      mySpots.forEach(spot => {
        const key = spot.lat + '_' + spot.lng;
        const marker = L.marker([spot.lat, spot.lng], {
          icon: L.divIcon({
            html: `<div style="background:#00d4aa;color:white;padding:10px 18px;border-radius:16px;font-weight:bolder;font-size:16px;border:4px solid white;box-shadow:0 6px 20px black;">${spot.name}</div>`,
            iconSize: [160, 60], iconAnchor: [80, 60]
          })
        }).addTo(personalMap);

        marker.bindPopup(() => {
          const catches = spot.catches || [];
          let catchesHTML = catches.length === 0 ? '<p style="color:#aaa;">Aucune prise</p>' : catches.map(c => `
            <div style="margin:8px 0;padding:10px;background:rgba(255,255,255,0.2);border-radius:8px;">
              ${c.photo ? `<img src="${c.photo}" style="width:100%;max-height:150px;object-fit:cover;border-radius:8px;margin-bottom:8px;">` : ''}
              <b>${c.species} — ${c.weight}kg</b><br>Leurre: ${c.lure||'NC'}<br><small>${c.date}</small>
            </div>`).join('');

          return `<div style="width:280px;"><h3 style="margin:0 0 10px;color:#00d4aa;text-align:center;">${spot.name}</h3>${catchesHTML}
            <button onclick="openCatchForm(${spot.lat},${spot.lng})" style="margin-top:10px;width:100%;background:#ffd700;color:black;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">
              Ajouter une prise
            </button></div>`;
        });
      });

      // Sessions classiques
      const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
      sessions.forEach(s => {
        if (s.lat && s.lng) {
          L.marker([s.lat, s.lng], {icon: L.divIcon({html: s.success ? 'Fish' : 'Cross', iconSize: [40,40], iconAnchor: [20,40]})})
            .addTo(personalMap)
            .bindPopup(`<b style="color:${s.success?'#00d4aa':'#e74c3c'};">${s.success?'Prise':'Bredouille'}</b><br>${s.spot}`);
        }
      });

      // Double-clic = nouveau spot
      personalMap.on('dblclick', e => {
        const name = prompt("Nom de ton nouveau spot secret :", "Spot du Maître Thao");
        if (!name || name.trim().length < 2) return;
        const newSpot = {name: name.trim(), lat: e.latlng.lat, lng: e.latlng.lng, date: new Date().toLocaleDateString('fr-FR'), catches: []};
        const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
        spots.push(newSpot);
        localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
        alert(`Spot "${name}" créé !`);
        initPersonalMap();
      });

      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          personalMap.setView([pos.coords.latitude, pos.coords.longitude], 14);
          L.marker([pos.coords.latitude, pos.coords.longitude], {icon: L.divIcon({html: 'Person', iconSize: [50,50], iconAnchor: [25,50]})})
            .addTo(personalMap).bindPopup("T'es là, Légende !").openPopup();
        });
      }
    }

    function openCatchForm(lat, lng) {
      const species = prompt("Espèce", "Brochet") || "";
      const weight = prompt("Poids en kg", "0") || "0";
      const lure = prompt("Leurre ?", "") || "";
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
          const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
          const spot = spots.find(s => s.lat === lat && s.lng === lng);
          spot.catches.push({species, weight: parseFloat(weight), lure, photo: ev.target.result, date: new Date().toLocaleDateString('fr-FR')});
          localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
          alert(`${species} de ${weight}kg ajouté !`);
          initPersonalMap();
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    document.getElementById('openMapBtn').addEventListener('click', () => {
      document.getElementById('mapModal').style.display = 'block';
      setTimeout(initPersonalMap, 300);
    });
  </script>

  <!-- CLASSEMENT + DATE DANS LES CONSEILS (dans app.js) -->
  <script src="app.js"></script>
</body>
</html>
