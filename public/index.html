<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI —</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .badge-ia {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #00d4aa;
      color: white;
      padding: 8px 16px;
      border-radius: 50px;
      font-weight: bold;
      font-size: 13px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      z-index: 9999;
      animation: pulse 2s infinite;
    }
    .live-badge {
      position: fixed;
      top: 15px;
      left: 15px;
      background: #00d4aa;
      color: white;
      padding: 10px 16px;
      border-radius: 50px;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,212,170,0.4);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: pulse 2s infinite;
    }
    .live-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #fff;
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }
    .qr-section {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: #f0fff9;
      border-radius: 12px;
      border: 2px solid #00d4aa;
    }
    .qr-section p {
      font-weight: bold;
      color: #00a085;
      margin: 0 0 15px 0;
      font-size: 18px;
    }
    .qr-section img {
      border: 3px solid #00d4aa;
      border-radius: 12px;
    }
  </style>
</head>
<body>

  <!-- === BADGE ANIMÉ : IA APPRENANTE === -->
  <div class="badge-ia">IA Apprenante</div>

  <!-- === BADGE "IA EN DIRECT" (compteur live) === -->
  <div class="live-badge">
    <span class="live-dot"></span>
    IA en direct : <span id="patternCount">0</span> patterns appris
  </div>

  <!-- === SON DÉSACTIVÉ (évite 502) === -->
  <!-- <script> SON SUPPRIMÉ TEMPORAIREMENT </script> -->

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1ère IA de pêche 100% Française</p>
    </div>
  </header>

  <main class="container main-grid">

    <!-- === FORMULAIRE === -->
    <section class="card input-card">
      <h2>Décris ton spot</h2>

      <label>Nom du spot <input id="spotName" placeholder="Ex: Étang du Moulin"></label>

      <label>Type d'eau<br>
        <select id="waterType">
          <option>Étang</option>
          <option>Rivière</option>
          <option>Lac</option>
          <option>Canal</option>
        </select>
      </label>

      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>

      <label>Fréquentation<br>
        <select id="pressure">
          <option value="low">Faible</option>
          <option value="medium" selected>Moyenne</option>
          <option value="high">Élevée</option>
        </select>
      </label>

      <label>Espèce ciblée <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>

      <label>Heure / Date prévue <input id="dateTime" type="datetime-local"></label>

      <label>Conditions (brève) <input id="conditions" placeholder="Ex: clair, pluie, vent NE"></label>

      <!-- === CHAMPS VOCAUX === -->
      <label>Température de l'eau (°C)<br>
        <input type="number" id="temperature" placeholder="Ex: 15" step="0.5" style="width:100%; padding:8px; margin:5px 0;">
      </label>
      <label>Heure de pêche<br>
        <input type="time" id="fishingTime" value="08:00" style="width:100%; padding:8px; margin:5px 0;">
      </label>

      <!-- === PSEUDO === -->
      <label>Ton pseudo (facultatif)<br>
        <input type="text" id="anglerName" placeholder="Ex: LoulouPeche" style="width:100%; padding:8px; margin:5px 0;">
      </label>

      <!-- === BOUTONS UNIQUES === -->
      <div class="row" style="margin-top:15px; gap:10px; flex-wrap:wrap;">
        <button id="getAdvice">Obtenir des conseils</button>
        <button id="voiceBtn" class="secondary" style="background:#00a085; color:white; display:flex; align-items:center; gap:8px; padding:10px 16px;">
          <span id="micIcon">Microphone</span> Commande vocale
        </button>
        <button id="clearBtn" class="secondary">Réinitialiser</button>
      </div>

      <p class="muted">Admin: <a href="/admin">Gérer sponsors</a></p>
    </section>

    <!-- === CONSEILS + STATS + CLASSEMENT + QR === -->
    <section class="card output-card">
      <h2>Conseils de l'IA</h2>

      <!-- === CONSEILS + CONTRÔLES VOCAUX === -->
      <div id="advice">
        <p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p>
      </div>

      <!-- === CONTRÔLES SYNTHÈSE VOCALE === -->
      <div id="voiceControls" style="margin-top:15px; text-align:center; display:none;">
        <button id="speakBtn" style="background:#00a085; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
          Lire les conseils
        </button>
        <button id="stopBtn" style="background:#e74c3c; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-left:10px;">
          Arrêter
        </button>
      </div>

      <!-- === BOUTON STATS === -->
      <div style="margin: 20px 0; text-align: center;">
        <button id="statsBtn" onclick="showStats()"
          style="padding: 12px 24px; font-size: 16px; background: #00d4aa; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: 0.2s;">
          Voir mes stats d'IA
        </button>
        <div id="stats" style="margin-top: 15px; text-align: left; font-family: monospace;"></div>
      </div>

      <!-- === CLASSEMENT TOP 5 === -->
      <div style="margin: 30px 0; text-align: center;">
        <h3 style="color: #00a085; margin-bottom:10px;">Top 5 des Maîtres de l'IA</h3>
        <div id="leaderboard" style="font-family: monospace; background:#f9f9f9; padding:15px; border-radius:10px; border:2px solid #00d4aa; min-height:60px;">
          <p>Chargement du classement...</p>
        </div>
      </div>

      <!-- === LIEN VERS RÉSULTAT === -->
      <a href="resultat.html"><button style="margin-top:10px; width:100%;">Enregistrer un résultat</button></a>

      <!-- === QR CODE === -->
      <div class="qr-section">
        <p>Scan & pêche plus malin : l'IA apprend de tes prises !</p>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https://fisher-forceai.onrender.com/" alt="QR Code FisherForce AI">
      </div>

      <details class="settings">
        <summary>Paramètres avancés</summary>
        <label>
          <input type="checkbox" id="allowSponsors"> Autoriser références sponsorisées
        </label>
        <p class="muted">Si tu as une clé OpenAI, les conseils seront enrichis.</p>
      </details>
    </section>
  </main>

  <!-- === FOOTER === -->
  <footer class="site-footer">
    <div class="container">
      <small>2025 Fisher-ForceAI. Tous droits réservés.</small>
      <div style="margin-top:15px; text-align:center;">
        <p>Suivez-moi sur mes réseaux :</p>
        <div style="display:flex; justify-content:center; gap:15px; font-size:24px;">
          <a href="https://www.instagram.com/fisherforce/" target="_blank">
            <img src="icons/insta.jpg" alt="Instagram" style="width:32px;height:32px;">
          </a>
          <a href="https://www.youtube.com/channel/UC_gRRbnmfVhiBVgLzQ7xLAw" target="_blank">
            <img src="icons/yt.png" alt="YouTube" style="width:32px;height:32px;">
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- === SCRIPTS === -->
  <script src="app.js"></script>
  <script src="script.js"></script>

  <!-- === FONCTIONS STATS / BADGE / LEADERBOARD / SAVE === -->
  <script>
    async function showStats() {
      const btn = document.getElementById('statsBtn');
      btn.disabled = true;
      btn.innerHTML = "Chargement...";
      try {
        const res = await fetch('/api/learnedPatterns');
        const data = await res.json();
        let total = 0;
        for (const species in data) {
          for (const saison in data[species]) {
            for (const cond in data[species][saison]) {
              for (const spot in data[species][saison][cond]) {
                total += data[species][saison][cond][spot].length;
              }
            }
          }
        }
        document.getElementById('stats').innerHTML = `
          <div style="background:#f0fff9; padding:15px; border-radius:10px; border:2px solid #00d4aa;">
            <h3 style="margin:0; color:#00a085;">IA FisherForce en action !</h3>
            <p style="margin:5px 0;"><strong>Patterns appris :</strong>
              <span style="color:#00d4aa; font-size:1.2em;">${total}</span>
            </p>
            <pre style="background:#fff; padding:10px; border:1px solid #ddd; border-radius:5px; max-height:300px; overflow:auto; font-size:12px;">
${JSON.stringify(data, null, 2)}
            </pre>
          </div>
        `;
      } catch (e) {
        document.getElementById('stats').innerHTML = '<p style="color:red;">Erreur de connexion</p>';
      }
      btn.disabled = false;
      btn.innerHTML = "Voir mes stats d'IA";
    }

    async function updateLiveBadge() {
      try {
        const res = await fetch('/api/learnedPatterns');
        const data = await res.json();
        let total = 0;
        for (const species in data) {
          for (const saison in data[species]) {
            for (const cond in data[species][saison]) {
              for (const spot in data[species][saison][cond]) {
                total += data[species][saison][cond][spot].length;
              }
            }
          }
        }
        document.getElementById('patternCount').textContent = total;
      } catch (e) {
        document.getElementById('patternCount').textContent = '—';
      }
    }

    async function updateLeaderboard() {
      try {
        const res = await fetch('/api/leaderboard');
        const data = await res.json();
        if (data.length === 0) {
          document.getElementById('leaderboard').innerHTML = '<p>Aucun pêcheur classé pour l’instant !</p>';
          return;
        }
        let html = '<ol style="text-align:left; margin:0; padding-left:20px;">';
        data.forEach((p, i) => {
          const medals = ['gold', 'silver', 'bronze'];
          const medal = i < 3 ? medals[i] : '';
          html += `<li><strong>${p.name}</strong> — ${p.count} prises enseignées</li>`;
        });
        html += '</ol>';
        document.getElementById('leaderboard').innerHTML = html;
      } catch (e) {
        document.getElementById('leaderboard').innerHTML = '<p>Erreur de chargement</p>';
      }
    }

    window.saveLastAdvice = function(species, spotType, conditions, structure) {
      sessionStorage.setItem('lastAdvice', JSON.stringify({
        species: species || "inconnu",
        spotType: spotType || "inconnu",
        conditions: conditions || "inconnu",
        structure: structure || ""
      }));
    };

    setInterval(updateLiveBadge, 10000);
    updateLiveBadge();
    setInterval(updateLeaderboard, 15000);
    updateLeaderboard();
  </script>

</body>
</html>
