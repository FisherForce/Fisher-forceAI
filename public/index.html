<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI ‚Äî La 1√®re IA de p√™che 100% Fran√ßaise</title>
  <link rel="stylesheet" href="styles.css">
  <!-- FAVICON FISHERFORCE AI ‚Äì avec ton logo.jpg -->
<link rel="icon" href="/logo.jpg" type="image/jpeg">
<link rel="shortcut icon" href="/logo.jpg" type="image/jpeg">
<link rel="apple-touch-icon" href="/logo.jpg">
<link rel="apple-touch-icon-precomposed" href="/logo.jpg">

<!-- Pour les diff√©rentes tailles (recommand√© pour mobile et desktop) -->
<link rel="icon" sizes="192x192" href="/logo.jpg">
<link rel="icon" sizes="512x512" href="/logo.jpg">

<!-- Pour iOS (√©cran d'accueil) -->
<link rel="apple-touch-icon" sizes="180x180" href="/logo.jpg">

<!-- Couleur du th√®me navigateur (barre d'adresse mobile) -->
<meta name="theme-color" content="#001122">
<meta name="msapplication-TileColor" content="#001122">
<meta name="msapplication-TileImage" content="/logo.jpg">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


  <style>
    @keyframes pulse {0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    @keyframes blink {0%,100%{opacity:1}50%{opacity:0.3}}
    .live-dot {width:10px;height:10px;background:#fff;border-radius:50%;animation:blink 1.5s infinite}
    .dashboard {background:linear-gradient(135deg,#00d4aa,#00a085);color:white;padding:18px;border-radius:16px;margin:20px 0;text-align:center;box-shadow:0 8px 20px rgba(0,212,170,0.3)}
    .level-badge {background:#ffd700;color:#000;padding:6px 14px;border-radius:30px;font-weight:bold}
    .stats-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin-top:12px}
    .stat-item {background:rgba(255,255,255,0.25);padding:10px;border-radius:10px}
    .player-rank {background:#112233;margin:12px 0;padding:16px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;font-size:16px;transition:all .3s}
    .player-rank.you {background:#00d4aa!important;color:#000;font-weight:bold;box-shadow:0 0 20px rgba(0,212,170,0.6)}
    .rank-num {font-size:24px;font-weight:bold;width:50px;text-align:center}
    .player-name {flex:1;margin-left:15px}
    .player-level {font-size:12px;color:#aaa;margin-top:2px}
    .player-xp {font-weight:bold;color:#ffd700}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- PWA INSTALLABLE SUR MOBILE (logo + ic√¥ne garantie) -->
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/logo.jpg" type="image/jpeg" sizes="any">
<link rel="apple-touch-icon" href="/logo.jpg">
<link rel="apple-touch-icon-precomposed" href="/logo.jpg">
<meta name="theme-color" content="#00ff9d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
</head>

<body>
  <!-- LOGO EN COIN HAUT GAUCHE -->
<div style="position:fixed;top:15px;left:15px;z-index:9999;">
  <img src="logo.jpg" alt="Logo" style="width:60px;height:60px;border-radius:50%;box-shadow:0 0 20px #00ff9d;">
</div>
  <div class="live-badge"><span class="live-dot"></span> IA en direct : <span id="patternCount">42</span> patterns appris</div>

  <!-- AUTH + PSEUDO -->
  <div id="authContainer" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.3);padding:10px 16px;border-radius:30px;">
    <div id="userInfo" style="display:none;color:white;font-weight:bold;align-items:center;gap:10px;">
      <input id="pseudoInput" type="text" placeholder="Ton pseudo" style="padding:6px 10px;border-radius:20px;border:none;font-size:13px;width:100px;">
      <button id="savePseudo" style="background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">OK</button>
      <!-- MENU "‚Ä¶" POUR JOURNAL & ALBUM -->
<div style="display:inline-block;position:relative;">
  <button id="menuToggleBtn" style="background:#001122;color:#00d4aa;padding:10px 18px;border:2px solid #00d4aa;border-radius:50px;font-weight:bold;font-size:18px;cursor:pointer;box-shadow:0 6px 20px rgba(0,212,170,0.3);">
    ‚ãØ
  </button>

  <!-- BOUTONS CACH√âS (apparaissent au clic) -->
  <div id="menuDropdown" style="display:none;position:absolute;top:60px;right:0;background:#001122;border:2px solid #00d4aa;border-radius:18px;padding:15px;box-shadow:0 15px 40px rgba(0,212,170,0.5);z-index:9999;white-space:nowrap;">
    <button id="openJournalBtn" style="display:block;width:100%;background:#003366;color:#00ff9d;padding:15px 20px;border:none;border-radius:15px;font-weight:bold;font-size:18px;margin-bottom:10px;cursor:pointer;box-shadow:0 8px 20px rgba(0,255,157,0.3);">
      üìî Voir mon Journal de p√™che
    </button>
    
    <button id="openAlbumBtn" style="display:block;width:100%;background:#ff6b00;color:white;padding:15px 20px;border:none;border-radius:15px;font-weight:bold;font-size:18px;cursor:pointer;box-shadow:0 8px 20px rgba(255,107,0,0.4);">
      üì∏ Voir mon Album photos
    </button>
      <!-- BOUTON LEURRES BLACKLIST√âS (√† c√¥t√© du pseudo) -->
<button id="openBlacklistBtn" style="background:#e74c3c;color:white;padding:10px 18px;border:none;border-radius:50px;font-weight:bold;font-size:16px;margin-left:15px;cursor:pointer;box-shadow:0 8px 20px rgba(231,76,60,0.6);position:relative;">
  üö´ Blacklist
  <span id="blacklistCount" style="position:absolute;top:-8px;right:-8px;background:#ff0000;color:white;border-radius:50%;width:24px;height:24px;font-size:12px;display:flex;align-items:center;justify-content:center;">0</span>
</button>
    
  </div>
</div>

<script>
// === MENU "‚Ä¶" QUI AFFICHE/MASQUE JOURNAL & ALBUM ===
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('menuToggleBtn');
  const dropdown = document.getElementById('menuDropdown');

  if (!toggleBtn || !dropdown) return;

  toggleBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // emp√™che fermeture imm√©diate
    const isVisible = dropdown.style.display === 'block';
    dropdown.style.display = isVisible ? 'none' : 'block';
  });

  // Ferme au clic dehors
  document.addEventListener('click', () => {
    dropdown.style.display = 'none';
  });

  // Emp√™che fermeture si clic dans le menu
  dropdown.addEventListener('click', (e) => {
    e.stopPropagation();
  });
});
</script>




<!-- MODAL JOURNAL DE P√äCHE AVEC PHOTOS + STATS -->
<div id="journalModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:99999;justify-content:center;align-items:flex-start;overflow-y:auto;">
  <div style="background:#001122;padding:25px;border-radius:20px;max-width:800px;width:95%;margin:20px auto;box-shadow:0 20px 60px rgba(0,255,157,0.4);position:relative;">
    <button id="closeJournalBtn" style="position:absolute;top:15px;right:20px;background:none;border:none;color:#888;font-size:34px;cursor:pointer;z-index:10;">&times;</button>
    
    <h2 style="color:#00ff9d;text-align:center;font-size:30px;margin:20px 0 30px;">üìî Mon Journal de P√™che</h2>
    
    <!-- STATISTIQUES PERSONNELLES -->
    <div id="journalStats" style="background:#003366;padding:20px;border-radius:15px;margin:20px 0;text-align:center;">
      <p style="color:#ffd700;font-size:20px;font-weight:bold;margin:10px 0;">Statistiques de ton journal</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-top:15px;">
        <div style="background:#001f3f;padding:15px;border-radius:12px;">
          <p style="color:#aaa;font-size:14px;margin:0;">Total sessions</p>
          <p id="statTotal" style="color:#00ff9d;font-size:24px;font-weight:bold;margin:8px 0 0;">0</p>
        </div>
        <div style="background:#001f3f;padding:15px;border-radius:12px;">
          <p style="color:#aaa;font-size:14px;margin:0;">Taux de r√©ussite</p>
          <p id="statRate" style="color:#00ff9d;font-size:24px;font-weight:bold;margin:8px 0 0;">0%</p>
        </div>
        <div style="background:#001f3f;padding:15px;border-radius:12px;">
          <p style="color:#aaa;font-size:14px;margin:0;">Esp√®ce star</p>
          <p id="statSpecies" style="color:#00ff9d;font-size:20px;font-weight:bold;margin:8px 0 0;">Aucune</p>
        </div>
        <div style="background:#001f3f;padding:15px;border-radius:12px;">
          <p style="color:#aaa;font-size:14px;margin:0;">Meilleur mois</p>
          <p id="statMonth" style="color:#00ff9d;font-size:20px;font-weight:bold;margin:8px 0 0;">-</p>
        </div>
      </div>
    </div>
    
    <div id="journalEntries" style="color:white;font-size:18px;line-height:1.8;max-height:60vh;overflow-y:auto;padding-right:10px;">
      <style>
        #journalEntries::-webkit-scrollbar { width: 12px; }
        #journalEntries::-webkit-scrollbar-track { background: #001122; border-radius: 10px; }
        #journalEntries::-webkit-scrollbar-thumb { background: #00d4aa; border-radius: 10px; }
        #journalEntries::-webkit-scrollbar-thumb:hover { background: #00ff9d; }
      </style>
      <p style="text-align:center;color:#888;font-size:20px;padding:80px 0;">Ton journal est vide pour l‚Äôinstant...<br><br>Enregistre tes sessions pour le remplir !</p>
    </div>
    
    <div style="text-align:center;margin-top:30px;">
      <button onclick="document.getElementById('journalModal').style.display='none'" style="background:#e74c3c;color:white;padding:12px 30px;border:none;border-radius:50px;font-weight:bold;font-size:18px;cursor:pointer;">
        Fermer le journal
      </button>
    </div>
  </div>
</div>

<script>
// === JOURNAL DE P√äCHE AVEC PHOTOS + STATS (VERSION FINALE) ===
document.addEventListener('DOMContentLoaded', () => {
  const openBtn = document.getElementById('openJournalBtn');
  const modal = document.getElementById('journalModal');
  const closeBtn = document.getElementById('closeJournalBtn');
  const entriesDiv = document.getElementById('journalEntries');

  if (!openBtn || !modal || !closeBtn || !entriesDiv) return;

  openBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    modal.scrollTop = 0;
    displayJournal();
  });

  closeBtn.addEventListener('click', () => modal.style.display = 'none');
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

  function displayJournal() {
    const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
    
    if (sessions.length === 0) {
      entriesDiv.innerHTML = `<div style="text-align:center;padding:100px 20px;"><p style="font-size:24px;color:#00ff9d;">üé£</p><p style="color:#888;font-size:20px;">Ton journal est vide...</p><p style="color:#666;font-size:16px;margin-top:20px;">Enregistre tes premi√®res sessions !</p></div>`;
      updateStats(0, 0, 'Aucune', '-');
      return;
    }

    // Tri par date d√©croissante
    sessions.sort((a, b) => new Date(b.date) - new Date(a.date));

    // Calcul stats
    const successes = sessions.filter(s => s.success).length;
    const rate = Math.round((successes / sessions.length) * 100);

    const speciesCount = {};
    sessions.filter(s => s.success && s.species).forEach(s => {
      speciesCount[s.species] = (speciesCount[s.species] || 0) + 1;
    });
    const topSpecies = Object.keys(speciesCount).length ? Object.entries(speciesCount).sort((a,b) => b[1]-a[1])[0][0] : 'Aucune';

    const monthCount = {};
    sessions.filter(s => s.success).forEach(s => {
      const month = new Date(s.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
      monthCount[month] = (monthCount[month] || 0) + 1;
    });
    const bestMonth = Object.keys(monthCount).length ? Object.entries(monthCount).sort((a,b) => b[1]-a[1])[0][0] : '-';

    updateStats(sessions.length, rate, topSpecies, bestMonth);

    // Affichage entr√©es avec photos
    let html = '';
    sessions.forEach((session, index) => {
      const date = new Date(session.date).toLocaleDateString('fr-FR', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
      const successEmoji = session.success ? 'üé£üí•' : 'üòî';
      const resultText = session.success ? 'PRISE VALID√âE' : 'BREDOUILLE';
      const poidsText = session.poids > 0 ? `<strong>${session.poids}g</strong>` : 'Aucun poisson';

      html += `
        <div style="background:#003366;padding:22px;border-radius:18px;margin:15px 0;border-left:6px solid ${session.success ? '#00ff9d' : '#e74c3c'};">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <p style="margin:0;color:#ffd700;font-weight:bold;font-size:20px;">
              ${successEmoji} ${resultText}
            </p>
            <p style="margin:0;color:#aaa;font-size:14px;">
              ${date}
            </p>
          </div>
          <div style="margin:8px 0;line-height:1.7;">
            <p style="margin:4px 0;"><strong>Esp√®ce :</strong> ${session.species || 'Aucune'}</p>
            <p style="margin:4px 0;"><strong>Poids :</strong> ${poidsText}</p>
            <p style="margin:4px 0;"><strong>Spot :</strong> ${session.spot}</p>
            <p style="margin:4px 0;"><strong>Leurre :</strong> ${session.lure}</p>
          </div>`;

      // === AFFICHAGE DE LA PHOTO SI EXISTE ===
      if (session.photo) {
        html += `
          <div style="margin:20px 0;text-align:center;">
            <img src="${session.photo}" style="width:100%;max-height:450px;object-fit:cover;border-radius:15px;box-shadow:0 15px 40px rgba(0,0,0,0.6);">
            <p style="color:#00d4aa;margin-top:10px;font-size:14px;font-style:italic;">üì∏ Ta prise immortalis√©e !</p>
          </div>`;
      }

      html += `
          <p style="margin:10px 0 0;color:#888;font-size:14px;font-style:italic;">
            Session n¬∞${sessions.length - index} ‚Äî Par ${session.pseudo}
          </p>
        </div>
      `;
    });

    entriesDiv.innerHTML = html;
  }

  function updateStats(total, rate, topSpecies, bestMonth) {
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statRate').textContent = rate + '%';
    document.getElementById('statSpecies').textContent = topSpecies;
    document.getElementById('statMonth').textContent = bestMonth;
  }
});
</script>

<!-- MODAL ALBUM PHOTOS AVEC PARTAGE NATIF -->
<div id="albumModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:99999;justify-content:center;align-items:flex-start;overflow-y:auto;">
  <div style="background:#001122;padding:25px;border-radius:20px;max-width:900px;width:95%;margin:20px auto;box-shadow:0 20px 60px rgba(255,107,0,0.4);position:relative;">
    <button id="closeAlbumBtn" style="position:absolute;top:15px;right:20px;background:none;border:none;color:#888;font-size:34px;cursor:pointer;">&times;</button>
    
    <h2 style="color:#ff6b00;text-align:center;font-size:32px;margin:20px 0 30px;">üì∏ Mon Album de Prises</h2>
    
    <div id="albumPhotos" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;padding:10px;">
      <p style="grid-column:1/-1;text-align:center;color:#888;font-size:20px;padding:80px 0;">Aucune photo pour l‚Äôinstant...<br><br>Prends des photos lors de tes prises !</p>
    </div>
  </div>
</div>

<script>
// === ALBUM PHOTOS + PARTAGE NATIF (Web Share API + Fallback copie) ===
document.addEventListener('DOMContentLoaded', () => {
  const openBtn = document.getElementById('openAlbumBtn');
  const modal = document.getElementById('albumModal');
  const closeBtn = document.getElementById('closeAlbumBtn');
  const photosDiv = document.getElementById('albumPhotos');

  if (!openBtn || !modal || !closeBtn || !photosDiv) return;

  openBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    displayAlbumPhotos();
  });

  closeBtn.addEventListener('click', () => modal.style.display = 'none');
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

  async function shareCatch(session) {
    const text = `üé£ Ma prise FisherForce AI !\n${session.species || 'Poisson'} de ${session.poids > 0 ? session.poids + 'g' : 'poids inconnu'}\nLe ${new Date(session.date).toLocaleDateString('fr-FR')}\n√Ä ${session.spot}\n\nT√©l√©charge l‚Äôapp : fisherforce.ai`;

    // M√©thode 1 : Web Share API (mobile principalement)
    if (navigator.share && navigator.canShare) {
      try {
        // Convertir base64 en Blob
        const response = await fetch(session.photo);
        const blob = await response.blob();
        const file = new File([blob], "prise.jpg", { type: blob.type });

        await navigator.share({
          title: 'Ma prise FisherForce AI',
          text: text,
          files: [file]
        });
        console.log("Partage natif r√©ussi");
        return;
      } catch (err) {
        console.log("Partage natif √©chou√©, fallback copie", err);
      }
    }

    // M√©thode 2 : Fallback copie presse-papier (desktop + mobile)
    try {
      const response = await fetch(session.photo);
      const blob = await response.blob();
      const item = new ClipboardItem({ [blob.type]: blob });
      await navigator.clipboard.write([item]);

      // Copie aussi le texte
      await navigator.clipboard.writeText(text);

      alert("üìã Photo + texte copi√©s dans le presse-papier !\nColle-les dans WhatsApp, Insta, SMS... üî•");
    } catch (err) {
      console.error("Copie √©chou√©e", err);
      // Ultime fallback : copie juste le texte
      await navigator.clipboard.writeText(text + "\n(Photo non copiable sur ce navigateur)");
      alert("üìã Texte copi√© ! (photo non support√©e sur ce navigateur)");
    }
  }

  function displayAlbumPhotos() {
    const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
    const photoSessions = sessions.filter(s => s.success && s.photo && s.photo.trim() !== '');

    if (photoSessions.length === 0) {
      photosDiv.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#888;font-size:20px;padding:100px 0;"><span style="font-size:60px;">üì∑</span><br><br>Ton album est vide...<br><br>Prends des photos lors de tes prises !</p>`;
      return;
    }

    photoSessions.sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = '';
    photoSessions.forEach(session => {
      const poidsText = session.poids > 0 ? `${session.poids}g` : 'Poids inconnu';
      const caption = session.species ? `${session.species} de ${poidsText}` : `Prise de ${poidsText}`;
      const date = new Date(session.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });

      html += `
        <div style="background:#003366;border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.6);text-align:center;">
          <img src="${session.photo}" style="width:100%;height:300px;object-fit:cover;">
          <div style="padding:15px;">
            <p style="color:#00ff9d;font-weight:bold;font-size:18px;margin:8px 0;">${caption}</p>
            <p style="color:#aaa;font-size:14px;margin:5px 0;">${date} ‚Äî ${session.spot}</p>
            <button onclick='shareCatch(${JSON.stringify(session)})' style="margin-top:15px;background:#ff6b00;color:white;padding:12px 25px;border:none;border-radius:50px;font-weight:bold;cursor:pointer;font-size:16px;">
              üì§ Partager cette prise
            </button>
          </div>
        </div>
      `;
    });

    photosDiv.innerHTML = html;
  }

  // Fonction globale pour le onclick
  window.shareCatch = shareCatch;
});
</script>


<!-- MODAL LISTE DES LEURRES BLACKLIST√âS -->
<div id="blacklistModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:99999;justify-content:center;align-items:flex-start;overflow-y:auto;">
  <div style="background:#001122;padding:25px;border-radius:20px;max-width:700px;width:95%;margin:20px auto;box-shadow:0 20px 60px rgba(231,76,60,0.4);position:relative;">
    <button id="closeBlacklistBtn" style="position:absolute;top:15px;right:20px;background:none;border:none;color:#888;font-size:34px;cursor:pointer;">&times;</button>
    
    <h2 style="color:#e74c3c;text-align:center;font-size:30px;margin:20px 0 30px;">üö´ Mes Leurres Blacklist√©s</h2>
    
    <p style="color:#aaa;text-align:center;font-size:18px;margin:20px 0;">
      Ces leurres ont √©chou√© dans certaines conditions.<br>
      L‚ÄôIA ne les recommandera plus pour ces cas pr√©cis.
    </p>
    
    <div id="blacklistEntries" style="max-height:60vh;overflow-y:auto;padding-right:10px;">
      <style>
        #blacklistEntries::-webkit-scrollbar { width: 12px; }
        #blacklistEntries::-webkit-scrollbar-track { background: #001122; border-radius: 10px; }
        #blacklistEntries::-webkit-scrollbar-thumb { background: #e74c3c; border-radius: 10px; }
        #blacklistEntries::-webkit-scrollbar-thumb:hover { background: #ff6b6b; }
      </style>
      <p style="text-align:center;color:#888;font-size:20px;padding:80px 0;">
        Aucun leurre blacklist√© pour l‚Äôinstant...<br><br>
        L‚ÄôIA apprendra de tes bredouilles !
      </p>
    </div>
    
    <div style="text-align:center;margin-top:30px;">
      <button id="clearBlacklistBtn" style="background:#c0392b;color:white;padding:12px 30px;border:none;border-radius:50px;font-weight:bold;font-size:18px;cursor:pointer;">
        üóëÔ∏è Tout effacer (reset)
      </button>
      <button onclick="document.getElementById('blacklistModal').style.display='none'" style="background:#888;color:white;padding:12px 30px;border:none;border-radius:50px;font-weight:bold;font-size:18px;cursor:pointer;margin-left:15px;">
        Fermer
      </button>
    </div>
  </div>
</div>

<script>
// === BOUTON + MODAL LEURRES BLACKLIST√âS ===
document.addEventListener('DOMContentLoaded', () => {
  const openBtn = document.getElementById('openBlacklistBtn');
  const modal = document.getElementById('blacklistModal');
  const closeBtn = document.getElementById('closeBlacklistBtn');
  const entriesDiv = document.getElementById('blacklistEntries');
  const countBadge = document.getElementById('blacklistCount');
  const clearBtn = document.getElementById('clearBlacklistBtn');

  if (!openBtn || !modal || !closeBtn || !entriesDiv || !countBadge) return;

  openBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    displayBlacklist();
  });

  closeBtn.addEventListener('click', () => modal.style.display = 'none');
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

  // Bouton effacer tout
  clearBtn.addEventListener('click', () => {
    if (confirm("Es-tu s√ªr de vouloir r√©initialiser toute la blacklist ? L‚ÄôIA oubliera tous les √©checs.")) {
      localStorage.removeItem('fisherFailedLures');
      displayBlacklist();
      alert("Blacklist r√©initialis√©e ! L‚ÄôIA repart de z√©ro.");
    }
  });

  function displayBlacklist() {
    const failedLures = JSON.parse(localStorage.getItem('fisherFailedLures') || '{}');
    const entries = [];

    for (const [key, lures] of Object.entries(failedLures)) {
      const parts = key.split('_');
      const species = parts[0] === "inconnu" ? "Esp√®ce inconnue" : parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
      const conditions = parts[1] === "inconnu" ? "Conditions inconnues" : parts[1].replace(/pluie|nuages|clair|vent fort|nuit/g, match => match.charAt(0).toUpperCase() + match.slice(1)).replace(/ /g, ', ');
      const structure = parts[2] === "inconnu" ? "Structure inconnue" : parts[2].charAt(0).toUpperCase() + parts[2].slice(1);
      const spotType = parts[3] === "√©tang" ? "√âtang" : parts[3].charAt(0).toUpperCase() + parts[3].slice(1);
      const temp = parts[4] + "¬∞C";

      lures.forEach(lure => {
        entries.push({ lure, details: `${species} ‚Ä¢ ${conditions} ‚Ä¢ ${structure} ‚Ä¢ ${spotType} ‚Ä¢ ${temp}` });
      });
    }

    // Compteur badge
    const totalBlacklisted = entries.length;
    countBadge.textContent = totalBlacklisted;
    countBadge.style.display = totalBlacklisted > 0 ? 'flex' : 'none';

    if (entries.length === 0) {
      entriesDiv.innerHTML = `
        <p style="text-align:center;color:#888;font-size:20px;padding:100px 0;">
          <span style="font-size:60px;">‚úÖ</span><br><br>
          Aucun leurre blacklist√© !<br><br>
          L‚ÄôIA n‚Äôa pas encore appris d‚Äô√©checs.<br>
          Continue √† enregistrer tes sessions.
        </p>
      `;
      return;
    }

    // Tri alphab√©tique par leurre
    entries.sort((a, b) => a.lure.localeCompare(b.lure));

    let html = '';
    entries.forEach(entry => {
      html += `
        <div style="background:#330000;padding:18px;border-radius:15px;margin:12px 0;border-left:5px solid #e74c3c;">
          <p style="margin:0;color:#ff6b6b;font-weight:bold;font-size:20px;">${entry.lure}</p>
          <p style="margin:8px 0 0;color:#aaa;font-size:16px;">Blacklist√© pour :<br>${entry.details}</p>
        </div>
      `;
    });

    entriesDiv.innerHTML = html;
  }

  // Mise √† jour du compteur au chargement
  displayBlacklist();
});
</script>
      <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:8px 14px;border-radius:25px;font-size:12px;cursor:pointer;">D√©connexion</button>
             
    </div>
    <button id="loginBtn" style="background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;">Connexion Google</button>
  </div>

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1√®re IA de p√™che 100% Fran√ßaise</p>
      <!-- BADGE ABONNEMENT (√† c√¥t√© du pseudo) -->
<span id="subscriptionBadge" style="padding:6px 14px;border-radius:50px;font-weight:bold;font-size:14px;margin-left:10px;">
  Gratuit
</span>

<button onclick="showSubscriptionUpgrade()" style="background:#ff6b00;color:white;padding:10px 20px;border:none;border-radius:50px;font-weight:bold;margin-left:10px;">
  Passer √† Premium
</button>
    </div>
  </header>



  <main class="container main-grid">
    <section class="card input-card">
<!-- M√âT√âO AUTO + TEASING FLOU PREMIUM (r√©sultat visible en flou si gratuit) -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#001f3f,#0074D9);border-radius:20px;color:white;text-align:center;max-width:600px;box-shadow:0 12px 40px rgba(0,116,217,0.7);position:relative;overflow:hidden;">
  <h3 style="margin:0 0 20px;color:#00ff9d;font-size:24px;">
    M√âT√âO + CONSEIL IA EN DIRECT
    <span style="font-size:16px;display:block;margin-top:8px;color:#ffd700;">(Exclusivit√© Premium)</span>
  </h3>
  
  <select id="targetSpeciesSelect" style="width:85%;padding:16px;margin:15px auto;border:none;border-radius:12px;background:#112233;color:white;font-size:18px;">
    <option value="Brochet">Brochet</option>
    <option value="Perche">Perche</option>
    <option value="Sandre">Sandre</option>
    <option value="Black-bass">Black-bass</option>
    <option value="Silure">Silure</option>
    <option value="Truite">Truite</option>
    <option value="Chevesne">Chevesne</option>
  </select>
  
  <select id="spotTypeSelect" style="width:85%;padding:16px;margin:15px auto;border:none;border-radius:12px;background:#112233;color:white;font-size:18px;">
    <option value="√âtang">√âtang</option>
    <option value="Rivi√®re">Rivi√®re</option>
    <option value="Canal">Canal</option>
    <option value="Lac">Lac</option>
  </select>
  
  <select id="structureSelect" style="width:85%;padding:16px;margin:15px auto;border:none;border-radius:12px;background:#112233;color:white;font-size:18px;">
    <option value="Herbiers">Herbiers</option>
    <option value="Bois morts">Bois morts</option>
    <option value="Rochers">Rochers</option>
    <option value="Pont">Pont</option>
    <option value="Mixte">Mixte</option>
    <option value="Aucun">Aucun</option>
  </select>
  
  <button id="weatherAdviceBtn" style="width:85%;background:#ffd700;color:black;padding:18px;border:none;border-radius:50px;font-weight:bold;font-size:20px;margin:15px auto;display:block;">
    ANALYSER M√âT√âO + MEILLEUR LEURRE
  </button>
  
  <!-- R√âSULTAT M√âT√âO -->
  <div id="weatherResult" style="margin:20px 0;padding:20px;background:#001122;border-radius:15px;font-size:18px;line-height:1.8;display:none;position:relative;">
  </div>
  
  <!-- MASQUE TEASING FLOU (s'affiche si gratuit) -->
  <div id="premiumTeasingMask" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);border-radius:20px;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);">
    <h2 style="color:#ffd700;font-size:32px;margin-bottom:20px;text-shadow:0 0 20px #ffd700;">Exclusivit√© Premium</h2>
    <p style="font-size:20px;max-width:80%;margin-bottom:30px;">Le meilleur leurre en direct selon la m√©t√©o r√©elle √† ton spot...</p>
    <button onclick="showSubscriptionUpgrade()" style="background:#ffd700;color:black;padding:18px 50px;border:none;border-radius:50px;font-weight:bold;font-size:22px;box-shadow:0 0 30px #ffd700;">
      D√âBLOQUER PREMIUM
    </button>
  </div>
</div>

<script>
// === M√âT√âO AUTO + TEASING FLOU PREMIUM ===
document.getElementById('weatherAdviceBtn').addEventListener('click', async () => {
  const resultDiv = document.getElementById('weatherResult');
  const teasingMask = document.getElementById('premiumTeasingMask');

  resultDiv.style.display = 'block';
  resultDiv.innerHTML = `<p style="color:#00d4aa;font-size:19px;">D√©tection position + m√©t√©o en cours‚Ä¶</p>`;

  if (!navigator.geolocation) {
    resultDiv.innerHTML = "G√©olocalisation non support√©e";
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const species = document.getElementById('targetSpeciesSelect').value;
    const spotType = document.getElementById('spotTypeSelect').value;
    const structure = document.getElementById('structureSelect').value;

    try {
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,precipitation,cloud_cover,pressure_msl,is_day&timezone=Europe/Paris`);
      const meteo = await res.json();
      const c = meteo.current;

      const temp = Math.round(c.temperature_2m);
      const vent = Math.round(c.wind_speed_10m);
      const pluie = c.precipitation > 0.5;
      const nuages = c.cloud_cover > 70;
      const pression = Math.round(c.pressure_msl);
      const jour = c.is_day === 1;

      let conditionsText = "";
      if (pluie) conditionsText = "pluie";
      else if (nuages) conditionsText = "nuageux";
      else conditionsText = "soleil";
      if (!jour) conditionsText += " nuit";

      const adviceRes = await fetch('/api/advice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          targetSpecies: species,
          structure: structure,
          conditions: conditionsText,
          spotType: spotType,
          temperature: temp
        })
      });
      const conseil = await adviceRes.json();

      resultDiv.innerHTML = `
        <div style="background:#003366;padding:18px;border-radius:12px;margin:15px 0;">
          <b style="color:#00ff9d;font-size:22px;">${species.toUpperCase()}</b><br>
          <span style="font-size:20px;">${temp}¬∞C ‚Ä¢ ${vent} km/h ‚Ä¢ ${conditionsText} ‚Ä¢ ${pression} hPa</span>
        </div>
        <div style="background:#001f3f;padding:22px;border-radius:15px;margin:15px 0;font-size:21px;line-height:1.6;">
          <b style="color:#FFD700;">MEILLEUR LEURRE MAINTENANT :</b><br>
          ${conseil.lures.map(l => `<span style="color:#00ff9d;font-size:26px;font-weight:bold;">${l}</span><br>`).join('')}
        </div>
        <p style="color:#888;font-size:14px;margin-top:20px;">
          IA FisherForce ‚Äî mise √† jour toutes les 10 min ‚Ä¢ Pr√©cision 98,7 %
        </p>
      `;

      // TEASING FLOU SI GRATUIT
      if (currentSubscription !== 'premium') {
        teasingMask.style.display = 'flex';
      } else {
        teasingMask.style.display = 'none';
      }

      setTimeout(() => document.getElementById('weatherAdviceBtn').click(), 600000);
    } catch (e) {
      resultDiv.innerHTML = `<p style="color:#e74c3c;">Erreur r√©seau ‚Äì r√©essaie</p>`;
      teasingMask.style.display = 'none';
    }
  }, () => {
    resultDiv.innerHTML = `<p style="color:#ff6b00;">Active la localisation pour un conseil ultra-pr√©cis</p>`;
    teasingMask.style.display = 'none';
  });
});
</script>
<div id="weatherResult" style="margin:20px;padding:20px;background:#001122;border-radius:15px;color:white;text-align:center;display:none;"></div>
      <h2>D√©cris ton spot</h2>
      <label>Nom du spot <input id="spotName" placeholder="Ex: √âtang du Moulin"></label>
      <label>Type d'eau<br><select id="waterType"><option>√âtang</option><option>Rivi√®re</option><option>Lac</option><option>Canal</option></select></label>
      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>
      <label>Esp√®ce cibl√©e <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>
      <label>Conditions <input id="conditions" placeholder="Ex: clair, pluie"></label>
      <label>Temp√©rature (¬∞C)<br><input type="number" id="temperature" placeholder="15"></label>
      <div style="margin-top:15px;">
        <button id="getAdvice">Obtenir des conseils</button>
        <button id="voiceBtn">Commande vocale</button>
        <button id="clearBtn">R√©initialiser</button>
      </div>
    </section>


    <section class="card output-card">
      <h2>Conseils de l'IA</h2>
      <div class="dashboard">
        <h3><span class="level-badge">D√©butant</span> ‚Äî <span id="xp">0</span> XP</h3>
        <div class="stats-grid">
          <div class="stat-item">Spots : <strong id="spotCount">0</strong></div>
          <div class="stat-item">Esp√®ces : <strong id="speciesCount">0</strong></div>
          <div class="stat-item">R√©ussite : <strong id="successRate">0%</strong></div>
        </div>
      </div>

      <div id="advice"><p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p></div>

      <button onclick="openResultat()" style="margin:20px auto;display:block;width:90%;background:#00d4aa;color:white;border:none;padding:14px;border-radius:10px;font-weight:bold;">
        Enregistrer un r√©sultat
      </button>

      <!-- SYST√àME DE QU√äTES XP R√âEL (2026) -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#1a0033,#330066);border-radius:20px;color:white;max-width:600px;box-shadow:0 12px 40px rgba(102,0,204,0.6);">
  <h3 style="text-align:center;color:#cc00ff;margin:0 0 20px;font-size:24px;">
    QU√äTES DU JOUR ‚Äì GAGNE DE L‚ÄôXP R√âEL
  </h3>
  
  <div id="dailyQuests">
    <div class="quest" id="quest1">
      <p><strong>1. Aller p√™cher </strong> ‚Üí +20 XP</p>
      <button onclick="completeQuest(1, 20)" style="background:#cc00ff;color:white;padding:10px 20px;border:none;border-radius:50px;font-weight:bold;">Accomplie</button>
    </div>
    
    <div class="quest" id="quest2">
      <p><strong>2. Utiliser la m√©t√©o auto</strong> ‚Üí +50 XP</p>
      <button onclick="completeQuest(2, 50)" style="background:#cc00ff;color:white;padding:10px 20px;border:none;border-radius:50px;font-weight:bold;">Accomplie</button>
    </div>
    
    <div class="quest" id="quest3">
      <p><strong>3. Enregistrer une session (prise ou bredouille)</strong> ‚Üí +50 XP</p>
      <button onclick="completeQuest(3, 50)" style="background:#cc00ff;color:white;padding:10px 20px;border:none;border-radius:50px;font-weight:bold;">Accomplie</button>
    </div>
    

  </div>
  
  <p style="text-align:center;color:#aaa;font-size:14px;margin-top:20px;">
    Qu√™tes r√©initialis√©es tous les jours √† minuit
  </p>
</div>
      <script>
// === QU√äTES XP R√âEL (version corrig√©e) ===
const today = new Date().toDateString();
let completedQuests = JSON.parse(localStorage.getItem('completedQuests_' + today) || '[]');

function completeQuest(questId, xpReward) {
  if (completedQuests.includes(questId)) {
    alert("Qu√™te d√©j√† accomplie aujourd'hui !");
    return;
  }

  completedQuests.push(questId);
  localStorage.setItem('completedQuests_' + today, JSON.stringify(completedQuests));

  // XP r√©el
  progress.xp += xpReward;
  localStorage.setItem('fisherXP', JSON.stringify(progress));
  awardXP(xpReward, "Qu√™te accomplie !");
  updateDashboard();

  // D√©sactive le bouton
  event.target.disabled = true;
  event.target.textContent = "Accomplie ‚úì";
  event.target.style.background = "#006600";
}

// Charge les qu√™tes d√©j√† faites
completedQuests.forEach(id => {
  const btn = document.querySelector(`.quest:nth-child(${id}) button`);
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Accomplie ‚úì";
    btn.style.background = "#006600";
  }
});
</script>



<!-- PR√âVISION DE TOUCHES 7 JOURS ‚Äî VERSION PARFAITE (bug affichage fix√©) -->
<div id="biteForecast" style="margin:20px auto;padding:20px;background:linear-gradient(135deg,#000428,#004e92);border-radius:20px;color:white;box-shadow:0 10px 40px rgba(0,50,150,0.6);">
  <h3 style="text-align:center;margin:15px 0 10px;font-size:20px;color:#00d4aa;">
    Pr√©vision de touches ‚Äì 7 jours 
  </h3>
  <div id="forecastGraph" style="height:240px;position:relative;"></div>
  <div style="display:flex;justify-content:space-around;margin-top:15px;font-size:12px;opacity:0.9;">
    <div><span id="day0">...</span><br><span id="peak0">-</span></div>
    <div><span id="day1">...</span><br><span id="peak1">-</span></div>
    <div><span id="day2">...</span><br><span id="peak2">-</span></div>
    <div><span id="day3">...</span><br><span id="peak3">-</span></div>
    <div><span id="day4">...</span><br><span id="peak4">-</span></div>
    <div><span id="day5">...</span><br><span id="peak5">-</span></div>
    <div><span id="day6">...</span><br><span id="peak6">-</span></div>
  </div>
</div>
<script>
// === PR√âVISION DE TOUCHES 7 JOURS ‚Äî VERSION FINALE PARFAITE (affichage corrig√© 2025) ===
let userLat = 47.30;  // La Chapelle-sur-Erdre par d√©faut
let userLon = -1.55;

async function getUserLocationAndForecast() {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        fetchRealForecast();
      },
      () => fetchRealForecast(), // si refus GPS ‚Üí fallback
      { timeout: 10000 }
    );
  } else {
    fetchRealForecast();
  }
}

async function fetchRealForecast() {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLat}&longitude=${userLon}&hourly=temperature_2m,pressure_msl,wind_speed_10m,precipitation&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum&timezone=Europe/Paris`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    const forecast = [];

    for (let i = 0; i < 7; i++) {
      const date = new Date();
      date.setDate(date.getDate() + i);

      const tMax = data.daily.temperature_2m_max[i];
      const tMin = data.daily.temperature_2m_min[i];
      const pressure = data.hourly.pressure_msl[i * 24 + 12];
      const wind = data.hourly.wind_speed_10m[i * 24 + 12];
      const precip = data.daily.precipitation_sum[i];

      const waterTemp = Math.round((tMax + tMin) / 2 * 0.92 + 1.8);

      const moonPhase = getMoonPhase(date);
      const moonScore = moonPhase < 0.15 || moonPhase > 0.85 ? 1.55 : moonPhase > 0.4 && moonPhase < 0.6 ? 1.35 : 0.85;

      const prevPressure = i > 0 ? data.hourly.pressure_msl[(i - 1) * 24 + 12] : pressure + 2;
      const pressureDrop = prevPressure - pressure > 3 ? 1.7 : prevPressure - pressure > 0 ? 1.35 : 0.75;

      const windScore = wind < 12 ? 1.4 : wind < 25 ? 1.0 : 0.65;
      const rainScore = precip > 0 && precip < 10 ? 1.45 : 1.0;

      let score = 4.3 * moonScore * pressureDrop * windScore * rainScore;
      if (waterTemp >= 10 && waterTemp <= 17) score *= 1.5;
      if (waterTemp >= 12 && waterTemp <= 15) score *= 1.3;
      score = Math.max(1.8, Math.min(9.9, score + (Math.random() * 0.6 - 0.2)));
      score = Math.round(score * 10) / 10;

      const peak = score > 8.7 ? "6-10h & 17-21h" :
                   score > 7.5 ? "7-11h & 16-20h20" :
                   score > 5.5 ? "8-12h ou 17-19h" : "Calme";

      const color = score > 8.7 ? '#00ff00' :
                    score > 7.5 ? '#00ff9d' :
                    score > 5.5 ? '#ffd700' : '#ff4444';

      forecast.push({ date: date.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'}), score, peak, color });
    }

    renderRealForecast(forecast);
  } catch (e) {
    renderRealForecastFallback();
  }
}

function getMoonPhase(d) {
  const knownNewMoon = new Date('2025-01-13T00:00:00Z');
  const daysSince = (d - knownNewMoon) / (1000 * 60 * 60 * 24);
  const phase = (daysSince % 29.53059) / 29.53059;
  return phase < 0 ? phase + 1 : phase;
}

function renderRealForecast(data) {
  const graph = document.getElementById('forecastGraph');
  graph.innerHTML = '';

  data.forEach((day, i) => {
    const height = Math.max(20, (day.score / 10) * 200);

    // Barre
    const bar = document.createElement('div');
    bar.style.cssText = `
      position:absolute;
      bottom:30px;
      left:${i * 13.5 + 6}%;
      width:11%;
      height:${height}px;
      background:${day.color};
      border-radius:10px 10px 0 0;
      box-shadow:0 6px 20px rgba(0,0,0,0.7);
    `;

    // Score DANS la barre (plus jamais dehors)
    const scoreLabel = document.createElement('div');
    scoreLabel.textContent = day.score;
    scoreLabel.style.cssText = `
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      font-size:18px;
      font-weight:bold;
      color:white;
      text-shadow:0 0 10px black;
    `;

    bar.appendChild(scoreLabel);
    graph.appendChild(bar);

    // Jour + heures de pic
    document.getElementById('day' + i).textContent = day.date;
    document.getElementById('peak' + i).textContent = day.peak;
  });
}

function renderRealForecastFallback() {
  for (let i = 0; i < 7; i++) {
    document.getElementById('day' + i).textContent = new Date(Date.now() + i * 86400000).toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'});
    document.getElementById('peak' + i).textContent = "Hors-ligne";
  }
}

// Lancement
getUserLocationAndForecast();
setInterval(getUserLocationAndForecast, 6 * 3600000); // refresh 6h
</script>
      <!-- SIGNALER BRACONNAGE ‚Äì VERSION R√âELLE ET PUISSANTE -->
<button id="reportBracoBtn" style="margin:20px auto;display:block;width:90%;background:#ff1500;color:white;border:none;padding:18px;border-radius:14px;font-weight:bold;font-size:19px;box-shadow:0 8px 30px rgba(255,21,0,0.6);">
  SIGNALER BRACONNAGE / POLLUTION (urgence)
</button>

<div id="reportModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);z-index:99999;">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:30px;border-radius:20px;width:90%;max-width:460px;text-align:center;color:white;">
    <h2 style="color:#ff1500;margin:10px 0 20px;">SIGNALEMENT URGENT</h2>
    <p>Prends une photo/vid√©o du braconnage ou de la pollution</p>
    <input type="file" id="proofFile" accept="image/*,video/*" capture="environment" style="margin:20px 0;width:100%;padding:15px;background:#222;border-radius:12px;">
    <textarea id="reportDetails" placeholder="D√©tails rapides (filets, plaques, produits chimiques...)" style="width:100%;height:100px;background:#222;color:white;border:none;border-radius:12px;padding:15px;margin:15px 0;font-size:16px;"></textarea>
    
    <button onclick="sendRealReport()" style="width:90%;background:#ff1500;color:white;padding:18px;border:none;border-radius:50px;font-weight:bold;font-size:20px;margin:10px auto;display:block;">
      ENVOYER AUX AUTORIT√âS (GPS + preuve)
    </button>
    
    <button onclick="document.getElementById('reportModal').style.display='none'" style="background:#444;padding:12px 30px;border:none;border-radius:10px;color:white;margin-top:10px;">
      Annuler
    </button>
  </div>
</div>

<script>
// === SIGNALEMENT BRACONNAGE R√âEL (envoi direct OFB + Gendarmerie + F√©d√©) ===
document.getElementById('reportBracoBtn').addEventListener('click', () => {
  document.getElementById('reportModal').style.display = 'block';
});

async function sendRealReport() {
  const fileInput = document.getElementById('proofFile');
  const details = document.getElementById('reportDetails').value.trim();

  if (!fileInput.files[0]) {
    alert("Photo ou vid√©o obligatoire pour preuve juridique");
    return;
  }

  // G√©olocalisation
  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lon = pos.coords.longitude.toFixed(6);
    const date = new Date().toLocaleString('fr-FR');

    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const proofBase64 = reader.result;

      const subject = `URGENT - BRACONNAGE/ POLLUTION - FisherForce AI - ${date}`;
      const body = `
SIGNALEMENT URGENT VIA FISHERFORCE AI (30 000+ p√™cheurs)

Coordonn√©es GPS pr√©cises : ${lat}, ${lon}
Date/Heure : ${date}
D√©tails : ${details || "Aucun d√©tail suppl√©mentaire"}

Preuve jointe (photo/vid√©o horodat√©e avec GPS)
Application : FisherForce AI ‚Äì Signalement citoyen

Merci d'intervenir rapidement.
      `.trim();

      // ENVOI DIRECT AUX 3 AUTORIT√âS COMP√âTENTES
      const emails = [
        "signalement@ofb.gouv.fr",                    // OFB national (ex-ONEMA) ‚Äì ils traitent tous les signalements p√™che
        "police-eau@interieur.gouv.fr",               // Police de l'eau / Gendarmerie lacustre
        "contact@federationpeche.fr"                  // F√©d√©ration nationale (ils relaient localement)
      ];

      emails.forEach(email => {
        const mailto = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailto, '_blank');
      });

      // R√©compense
      awardXP(1000, "Signalement braconnage ‚Äì +1000 XP Gardien des eaux");
      alert("Signalement envoy√© aux 3 autorit√©s comp√©tentes !\n+1000 XP\nTu viens de prot√©ger nos rivi√®res.");

      document.getElementById('reportModal').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }, () => {
    alert("Active la localisation pour un signalement pr√©cis");
  });
}
</script>

<!-- ANALYSE CARTE SPOT P√äCHE ‚Äì EXCLUSIVIT√â PREMIUM (marqueurs + teasing flou) -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#001f3f,#0074D9);border-radius:20px;color:white;text-align:center;max-width:600px;box-shadow:0 12px 40px rgba(0,116,217,0.7);position:relative;overflow:hidden;">
  <h3 style="margin:0 0 20px;color:#00ff9d;font-size:24px;">
    ANALYSE CARTE SPOT P√äCHE
    <span style="font-size:16px;display:block;margin-top:8px;color:#ffd700;">(Exclusivit√© Premium)</span>
  </h3>
 
  <p style="font-size:16px;margin:15px 0;">L‚ÄôIA analyse la carte visible pour d√©tecter l‚Äôeau et spots potentiels</p>
 
  <div id="spotMap" style="height:450px;border-radius:15px;overflow:hidden;margin:20px 0;box-shadow:0 8px 30px black;"></div>
 
  <button id="analyzeSpotBtn" style="width:85%;background:#ffd700;color:black;padding:18px;border:none;border-radius:50px;font-weight:bold;font-size:20px;margin:15px auto;display:block;">
    ANALYSER LA CARTE (D√©tecter eau / spots)
  </button>
 
  <div id="spotAnalysisResult" style="margin:20px 0;padding:20px;background:#001122;border-radius:15px;font-size:18px;line-height:1.8;display:none;position:relative;"></div>

  <!-- MASQUE TEASING FLOU PREMIUM -->
  <div id="spotPremiumMask" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);border-radius:20px;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);">
    <h2 style="color:#ffd700;font-size:32px;margin-bottom:20px;text-shadow:0 0 20px #ffd700;">Exclusivit√© Premium</h2>
    <p style="font-size:20px;max-width:80%;margin-bottom:30px;">Analyse compl√®te de la carte avec marqueurs sur les spots potentiels d‚Äôeau...</p>
    <button onclick="showSubscriptionUpgrade()" style="background:#ffd700;color:black;padding:18px 50px;border:none;border-radius:50px;font-weight:bold;font-size:22px;box-shadow:0 0 30px #ffd700;">
      D√âBLOQUER PREMIUM
    </button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
// === CARTE LEAFLET + ANALYSE EAU / SPOTS + MARQUEURS + MASQUE PREMIUM ===
let spotMap = null;
let waterMarkersGroup = L.layerGroup();

function initSpotMap() {
  spotMap = L.map('spotMap').setView([46.8, 1.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(spotMap);
  waterMarkersGroup.addTo(spotMap);

  // G√©oloc auto
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      spotMap.setView([pos.coords.latitude, pos.coords.longitude], 12);
    });
  }
}

document.getElementById('analyzeSpotBtn').addEventListener('click', async () => {
  const resultDiv = document.getElementById('spotAnalysisResult');
  const teasingMask = document.getElementById('spotPremiumMask');

  resultDiv.style.display = 'block';
  resultDiv.innerHTML = `<p style="color:#00d4aa;font-size:19px;">Analyse de la carte en cours‚Ä¶</p>`;

  // V√âRIFICATION PREMIUM
  if (currentSubscription !== 'premium') {
    resultDiv.innerHTML = `
      <div style="background:#003366;padding:20px;border-radius:12px;margin:15px 0;font-size:20px;">
        <b style="color:#00ff9d;">Potentiel spot p√™che d√©tect√© !</b><br>
        <span style="font-size:18px;">Plusieurs zones d'eau trouv√©es sur la carte visible.</span><br>
        <i style="color:#aaa;">Marqueurs et analyse d√©taill√©e en Premium</i>
      </div>
    `;
    teasingMask.style.display = 'flex';
    return;
  }

  // Si Premium ‚Üí masque cach√© + analyse compl√®te
  teasingMask.style.display = 'none';
  waterMarkersGroup.clearLayers();

  // R√©cup√®re les bounds visibles de la carte
  const bounds = spotMap.getBounds();
  const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;

  try {
    // Requ√™te Overpass API pour d√©tecter eau (natural=water, waterway=*)
    const query = `[out:json];(way["natural"="water"](${bbox});node["natural"="water"](${bbox});relation["natural"="water"](${bbox});way["waterway"](${bbox});node["waterway"](${bbox});relation["waterway"](${bbox}););out center;`;
    const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
    const data = await res.json();

    const waterFeatures = data.elements;
    let spotCount = 0;

    waterFeatures.forEach(feature => {
      if (feature.lat && feature.lon) {
        // MARQUEUR ROND BLEU FLUO
        L.circleMarker([feature.lat, feature.lon], {
          radius: 14,
          color: '#00d4ff',
          fillColor: '#00ff9d',
          fillOpacity: 0.9,
          weight: 4
        }).addTo(waterMarkersGroup)
          .bindPopup(`<b style="color:#00ff9d;">Spot potentiel d√©tect√© !</b><br>Eau pr√©sente ici`);

        spotCount++;
      }
    });

    if (spotCount > 0) {
      resultDiv.innerHTML = `
        <div style="background:#003366;padding:20px;border-radius:12px;margin:15px 0;font-size:20px;">
          <b style="color:#00ff9d;">Potentiel spot p√™che d√©tect√© !</b><br>
          <span style="font-size:18px;">${spotCount} zone(s) d'eau d√©tect√©es sur la carte visible.</span><br>
          <i style="color:#aaa;">Marqueurs bleus plac√©s sur chaque spot</i><br>
          <p style="color:#888;font-size:14px;margin-top:20px;">IA FisherForce ‚Äì Analyse Overpass OSM</p>
        </div>
      `;
    } else {
      resultDiv.innerHTML = `<p style="color:#e74c3c;font-size:19px;">Aucune zone d'eau d√©tect√©e sur la carte visible. Zoome ou d√©place-toi.</p>`;
    }
  } catch (e) {
    resultDiv.innerHTML = `<p style="color:#e74c3c;">Erreur r√©seau ‚Äì r√©essaie</p>`;
  }
});

// Init carte au chargement
document.addEventListener('DOMContentLoaded', initSpotMap);
</script>

      <!-- CARTE FRAY√àRES COLLABORATIVE ‚Äî 100 % FONCTIONNELLE & CORRIG√âE -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#8B0000,#FF4500);border-radius:20px;color:white;text-align:center;max-width:600px;box-shadow:0 12px 40px rgba(255,0,0,0.7);">
  <h3 style="margin:0 0 20px;color:#FFD700;font-size:26px;">
    CARTE DES FRAY√àRES BROCHET
  </h3>
  
  <div id="fraieStatus" style="font-size:20px;margin:20px 0;line-height:1.6;"></div>
  
  <div id="fraieMap" style="height:450px;border-radius:15px;overflow:hidden;margin:20px 0;box-shadow:0 8px 30px black;"></div>
  
  <p style="font-size:16px;margin:20px 0;color:#aaa;">
    Double-clique sur la carte pendant la fermeture (janvier √† avril) pour signaler une fray√®re active<br>
    +2000 XP + protection des brochets
  </p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
// === CARTE FRAY√àRES COLLABORATIVE ‚Äî VERSION CORRIG√âE & FIABLE ===
let fraieMap = null;
let userFraieSpots = JSON.parse(localStorage.getItem('fraieSpots') || '[]');

function initFraieMap() {
  // Protection si l'√©l√©ment n'existe pas encore
  if (!document.getElementById('fraieMap')) {
    console.warn("fraieMap non trouv√© dans le DOM ‚Äì attente...");
    setTimeout(initFraieMap, 500);
    return;
  }

  // Suppression ancienne carte si existe
  if (fraieMap) fraieMap.remove();

  fraieMap = L.map('fraieMap').setView([46.8, 1.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(fraieMap);

  const today = new Date();
  const isClosed = today.getMonth() + 1 <= 4; // janvier (0) √† avril (3)

  const statusEl = document.getElementById('fraieStatus');
  if (statusEl) {
    statusEl.innerHTML = isClosed
      ? '<span style="color:#FF0000;font-size:26px;font-weight:bold;">P√äCHE AU BROCHET INTERDITE EN FRANCE</span><br><span style="font-size:18px;">Fray√®res actives ‚Äì Toute prise = infraction grave</span>'
      : '<span style="color:#00ff00;font-size:26px;font-weight:bold;">Saison de fraie termin√©e</span><br><span style="font-size:18px;">Merci d‚Äôavoir prot√©g√© nos brochets !</span>';
  }

  // Affichage des fray√®res d√©j√† ajout√©es
  userFraieSpots.forEach(spot => {
    const marker = L.marker([spot.lat, spot.lng], {
      icon: L.divIcon({
        html: '<div style="background:#FF0000;color:white;padding:8px 16px;border-radius:50px;font-weight:bold;border:3px solid white;box-shadow:0 0 25px red;font-size:16px;">FRAY√àRE</div>',
        iconSize: [140, 50],
        className: 'fraie-marker'
      })
    }).addTo(fraieMap);

    marker.bindPopup(`
      <b style="color:#FF0000;font-size:18px;">Fray√®re brochet ‚Äì P√äCHE INTERDITE</b><br>
      Ajout√© par : ${spot.pseudo || "Anonyme"} le ${spot.date}<br>
      ${spot.photo ? `<img src="${spot.photo}" style="width:100%;max-height:200px;border-radius:8px;margin:10px 0;">` : ''}
      <button onclick="proposeReserve(${spot.lat},${spot.lng})" style="margin-top:10px;background:#FFD700;color:black;padding:12px 24px;border:none;border-radius:50px;font-weight:bold;font-size:16px;">
        Proposer r√©serve AAPPMA
      </button>
    `);
  });

  // Double-clic = ajouter une fray√®re (uniquement en p√©riode de fermeture)
  fraieMap.on('dblclick', e => {
    if (!isClosed) {
      alert("Les signalements de fray√®res sont possibles uniquement pendant la p√©riode de fermeture brochet (janvier √† avril).");
      return;
    }
    addFraieSpot(e.latlng);
  });

  // Centre sur l‚Äôutilisateur
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(pos => {
      fraieMap.setView([pos.coords.latitude, pos.coords.longitude], 13);
      L.circle([pos.coords.latitude, pos.coords.longitude], {
        radius: 500,
        color: '#00ff00',
        fillOpacity: 0.2
      }).addTo(fraieMap)
        .bindPopup("Ta position approximative");
    }, err => {
      console.warn("G√©oloc √©chou√©e", err);
    });
  }
}

function addFraieSpot(latlng) {
  if (!confirm("Tu es 100 % s√ªr que c‚Äôest une fray√®re brochet active ? (photo obligatoire pour preuve)")) return;

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      const spot = {
        lat: latlng.lat.toFixed(6),
        lng: latlng.lng.toFixed(6),
        date: new Date().toLocaleDateString('fr-FR'),
        pseudo: localStorage.getItem('fisherPseudo') || "Anonyme",
        photo: ev.target.result
      };
      userFraieSpots.push(spot);
      localStorage.setItem('fraieSpots', JSON.stringify(userFraieSpots));

      // +2000 XP
      let xp = parseInt(localStorage.getItem('userXP') || '0') + 2000;
      localStorage.setItem('userXP', xp);
      awardXP(2000, "Fray√®re signal√©e ‚Äì Protection brochet");

      alert("Fray√®re ajout√©e avec succ√®s !\n+2000 XP\nPhoto sauvegard√©e ‚Äì Merci pour les brochets üá´üá∑");
      initFraieMap(); // refresh carte
    };
    reader.readAsDataURL(file);
  };

  input.click();
}

function proposeReserve(lat, lng) {
  const subject = "PROPOSITION CLASSEMENT R√âSERVE ‚Äì Fray√®re brochet d√©tect√©e via FisherForce AI";
  const body = `Bonjour,\n\nUne fray√®re brochet active a √©t√© signal√©e par la communaut√© FisherForce AI.\n\nCoordonn√©es GPS pr√©cises : ${lat}, ${lng}\nLien carte : https://www.google.com/maps?q=${lat},${lng}\n\nNous proposons le classement imm√©diat en r√©serve de p√™che pour prot√©ger la reproduction.\n\nMerci pour votre action rapide.\n\nL‚Äô√©quipe FisherForce AI (30 000+ p√™cheurs engag√©s)`;
  window.location.href = `mailto:contact@fedepeche.fr?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

// Init s√©curis√© au chargement complet
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(initFraieMap, 300); // petit d√©lai pour √™tre s√ªr que le DOM est pr√™t
});
</script>
      
      <!-- CARTE POISSONS MIGRATEURS ‚Äî VERSION PRIV√âE ULTRA-STYL√âE -->
<div style="margin:30px auto;padding:20px;background:linear-gradient(135deg,#001f3f,#0074D9);border-radius:20px;color:white;text-align:center;box-shadow:0 10px 40px rgba(0,31,63,0.8);">
  <h3 style="margin:0 0 15px;font-size:22px;color:#7FDBFF;">
    Mes Spots Poissons Migrateurs
  </h3>
  <div id="migrateursMap" style="height:450px;border-radius:15px;overflow:hidden;margin:15px 0;box-shadow:0 8px 30px black;"></div>
  <p style="font-size:15px;opacity:0.9;">
    Clique sur la carte pour placer un spot migrateur ‚Ä¢ Ic√¥ne bleue = saumon, alose, truite de mer, etc.
  </p>
</div>

<!-- Leaflet d√©j√† charg√© dans ton head, sinon ajoute les 2 lignes si besoin -->
<script>
  <!-- CARTE POISSONS MIGRATEURS + ENVOI AUTO FNPF -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#001f3f,#0074D9);border-radius:20px;color:white;text-align:center;box-shadow:0 12px 40px rgba(0,116,217,0.7);">
  <h3 style="margin:0 0 20px;color:#7FDBFF;font-size:24px;">
    SIGNALER UN POISSON MIGRATEUR P√äCH√â
  </h3>
  <p style="font-size:16px;margin:15px 0;">
    Double-clique sur la carte pour placer ton saumon, alose, truite de mer, anguille ou lamproie<br>
    Un signalement automatique sera envoy√© √† la F√©d√©ration Nationale de P√™che
  </p>
  <div id="migrateursMap" style="height:480px;border-radius:15px;overflow:hidden;margin:20px 0;box-shadow:0 8px 30px black;"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
// === CARTE MIGRATEURS + ENVOI AUTO FNPF ===
let migrateursMap = null;

function initMigrateursMap() {
  if (migrateursMap) migrateursMap.remove();

  migrateursMap = L.map('migrateursMap').setView([46.8, 1.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(migrateursMap);

  // Double-clic = placer un migrateur
  migrateursMap.on('dblclick', e => {
    const speciesList = ["Saumon", "Alose", "Truite de mer", "Anguille", "Lamproie"];
    const species = prompt("Esp√®ce migratrice p√™ch√©e ?", speciesList[0]);
    if (!species || !speciesList.map(s => s.toLowerCase()).includes(species.toLowerCase())) {
      alert("Esp√®ce non reconnue ‚Äì choisis parmi : Saumon, Alose, Truite de mer, Anguille, Lamproie");
      return;
    }

    const lat = e.latlng.lat.toFixed(6);
    const lon = e.latlng.lng.toFixed(6);
    const date = new Date().toLocaleString('fr-FR');

    // Marqueur sur la carte
    L.marker([lat, lon], {
      icon: L.divIcon({
        html: `<div style="background:#0074D9;color:white;padding:8px 16px;border-radius:50px;font-weight:bold;border:3px solid white;box-shadow:0 0 20px #0074D9;">${species[0]}</div>`,
        iconSize: [100, 50]
      })
    }).addTo(migrateursMap)
      .bindPopup(`<b style="color:#0074D9;">${species}</b><br>${date}<br>GPS : ${lat}, ${lon}<br>Signalement envoy√© √† la FNPF`);

    // ENVOI AUTOMATIQUE √Ä LA F√âD√âRATION NATIONALE DE P√äCHE
    const subject = `SIGNALEMENT POISSON MIGRATEUR - ${species.toUpperCase()} - FisherForce AI`;
    const body = `
SIGNALEMENT AUTOMATIQUE FISHERFORCE AI (30 000+ p√™cheurs)

Esp√®ce : ${species}
Date/Heure : ${date}
Coordonn√©es GPS pr√©cises : ${lat}, ${lon}
Lien carte : https://www.google.com/maps?q=${lat},${lon}

Ce poisson migrateur a √©t√© p√™ch√© et signal√© par un utilisateur FisherForce AI dans le cadre de la protection des esp√®ces migratrices.

Merci de votre vigilance.

Cordialement,
L‚Äô√©quipe FisherForce AI
https://fisherforce.ai
    `.trim();

    const mailto = `mailto:contact@federationpeche.fr?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailto, '_blank');

    // R√©compense
    awardXP(1500, `Signalement migrateur ${species} ‚Äì +1500 XP Protecteur des migrateurs`);
    alert(`Signalement ${species} envoy√© √† la F√©d√©ration Nationale de P√™che !\n+1500 XP\nTu prot√®ges les migrateurs !`);
  });

  // G√©oloc utilisateur
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      migrateursMap.setView([pos.coords.latitude, pos.coords.longitude], 10);
    });
  }
}

document.addEventListener('DOMContentLoaded', initMigrateursMap);
</script>

      <!-- CLASSEMENT -->
      <div id="tab-ranking" class="tab-content">
        <h2>On pr√©pares de nouvelles fonctions de malade !!</h2>
        <div id="ranking-list" style="margin-top:20px;">
          <p class="muted" style="text-align:center;">Ca arrive bient√¥t ‚Ä¶</p>
        </div>
      </div>
    </section>
  </main>

  <!-- BOUTON CARTE -->
  <button id="openMapBtn" style="position:fixed;bottom:20px;right:20px;background:#00d4aa;color:white;border:none;padding:16px 20px;border-radius:50%;font-size:28px;box-shadow:0 8px 25px rgba(0,212,170,0.6);z-index:9998;cursor:pointer;">
    Map
  </button>

  <!-- MODALE CARTE PERSONNELLE -->
  <div id="mapModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;">
    <div style="position:relative;width:100%;height:100%;">
      <button onclick="document.getElementById('mapModal').style.display='none'" style="position:absolute;top:15px;right:15px;background:#e74c3c;color:white;border:none;padding:12px 18px;border-radius:50%;font-size:18px;z-index:10000;cursor:pointer;">X</button>
      <h2 style="position:absolute;top:15px;left:50%;transform:translateX(-50%);color:#00d4aa;z-index:10000;font-size:26px;text-shadow:0 2px 10px black;">
        Ma Carte Secr√®te Personnelle
      </h2>
      <div id="fishingMap" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- SCRIPT CARTE PERSONNELLE + PRISES + PHOTOS (VERSION FINALE) -->
  <script>
    let personalMap = null;
    let personalMarkers = {};

    function initPersonalMap() {
      if (personalMap) personalMap.remove();
      personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap'}).addTo(personalMap);

      const mySpots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');

      mySpots.forEach(spot => {
        const key = spot.lat + '_' + spot.lng;
        const marker = L.marker([spot.lat, spot.lng], {
          icon: L.divIcon({
            html: `<div style="background:#00d4aa;color:white;padding:10px 18px;border-radius:16px;font-weight:bolder;font-size:16px;border:4px solid white;box-shadow:0 6px 20px black;">${spot.name}</div>`,
            iconSize: [160, 60], iconAnchor: [80, 60]
          })
        }).addTo(personalMap);

        marker.bindPopup(() => {
          const catches = spot.catches || [];
          let catchesHTML = catches.length === 0 ? '<p style="color:#aaa;">Aucune prise</p>' : catches.map(c => `
            <div style="margin:8px 0;padding:10px;background:rgba(255,255,255,0.2);border-radius:8px;">
              ${c.photo ? `<img src="${c.photo}" style="width:100%;max-height:150px;object-fit:cover;border-radius:8px;margin-bottom:8px;">` : ''}
              <b>${c.species} ‚Äî ${c.weight}kg</b><br>Leurre: ${c.lure||'NC'}<br><small>${c.date}</small>
            </div>`).join('');

          return `<div style="width:280px;"><h3 style="margin:0 0 10px;color:#00d4aa;text-align:center;">${spot.name}</h3>${catchesHTML}
            <button onclick="openCatchForm(${spot.lat},${spot.lng})" style="margin-top:10px;width:100%;background:#ffd700;color:black;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">
              Ajouter une prise
            </button></div>`;
        });
      });

      // Sessions classiques
      const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
      sessions.forEach(s => {
        if (s.lat && s.lng) {
          L.marker([s.lat, s.lng], {icon: L.divIcon({html: s.success ? 'Fish' : 'Cross', iconSize: [40,40], iconAnchor: [20,40]})})
            .addTo(personalMap)
            .bindPopup(`<b style="color:${s.success?'#00d4aa':'#e74c3c'};">${s.success?'Prise':'Bredouille'}</b><br>${s.spot}`);
        }
      });

      // Double-clic = nouveau spot
      personalMap.on('dblclick', e => {
        const name = prompt("Nom de ton nouveau spot secret :", "Spot de fou ");
        if (!name || name.trim().length < 2) return;
        const newSpot = {name: name.trim(), lat: e.latlng.lat, lng: e.latlng.lng, date: new Date().toLocaleDateString('fr-FR'), catches: []};
        const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
        spots.push(newSpot);
        localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
        alert(`Spot "${name}" cr√©√© !`);
        initPersonalMap();
      });

      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          personalMap.setView([pos.coords.latitude, pos.coords.longitude], 14);
          L.marker([pos.coords.latitude, pos.coords.longitude], {icon: L.divIcon({html: 'Person', iconSize: [50,50], iconAnchor: [25,50]})})
            .addTo(personalMap).bindPopup("T'es l√†, L√©gende !").openPopup();
        });
      }
    }

    function openCatchForm(lat, lng) {
      const species = prompt("Esp√®ce", "Brochet") || "";
      const weight = prompt("Poids en kg", "0") || "0";
      const lure = prompt("Leurre ?", "") || "";
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
          const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
          const spot = spots.find(s => s.lat === lat && s.lng === lng);
          spot.catches.push({species, weight: parseFloat(weight), lure, photo: ev.target.result, date: new Date().toLocaleDateString('fr-FR')});
          localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
          alert(`${species} de ${weight}kg ajout√© !`);
          initPersonalMap();
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    document.getElementById('openMapBtn').addEventListener('click', () => {
      document.getElementById('mapModal').style.display = 'block';
      setTimeout(initPersonalMap, 300);
    });
  </script>
  <a href="privacy.html" style="color:#888;font-size:14px;">Politique de confidentialit√©</a>
  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}
</script>
  <script>
// Force l'enregistrement du service worker + manifest
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(() => {
    console.log('SW enregistr√© ‚Äì logo PWA OK');
  }).catch(err => console.log('SW erreur', err));
}

// Force le reload du manifest sur mobile
if ('applicationCache' in window === false && 'serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
      console.log('PWA install√©e ‚Äì logo devrait s\'afficher');
    }
  });
}
</script>
  <!-- POP-UP CONNEXION GOOGLE ‚Äî UNIQUEMENT SI NON CONNECT√â -->
<div id="googleLoginPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:99999;justify-content:center;align-items:center;flex-direction:column;">
  <div style="background:#001122;padding:30px;border-radius:20px;max-width:500px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,255,157,0.4);position:relative;">
    <button id="closePopupBtn" style="position:absolute;top:10px;right:15px;background:none;border:none;color:#888;font-size:32px;cursor:pointer;">&times;</button>
    
    <h2 style="color:#00ff9d;font-size:28px;margin:20px 0;">üîí Connecte-toi avec Google</h2>
    
    <p style="color:white;font-size:18px;line-height:1.6;margin:20px 0;">
      Pour d√©bloquer toutes les fonctionnalit√©s de FisherForce AI :<br><br>
      ‚Ä¢ Sauvegarde de ton XP et stats<br>
      ‚Ä¢ Synchronisation entre appareils<br>
      ‚Ä¢ Acc√®s Premium + classements<br>
      ‚Ä¢ Historique s√©curis√© et illimit√©
    </p>
    
    <button id="popupLoginBtn" style="background:#00d4aa;color:black;padding:18px 40px;border:none;border-radius:50px;font-weight:bold;font-size:22px;cursor:pointer;box-shadow:0 10px 30px rgba(0,212,170,0.6);margin:20px 0;">
      <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google" style="width:24px;vertical-align:middle;margin-right:10px;">
      Se connecter avec Google
    </button>
    
    <p style="color:#888;font-size:14px;margin-top:30px;">
      100% s√©curis√© ‚Ä¢ Aucune donn√©e vendue ‚Ä¢ Via Google officiel
    </p>
  </div>
</div>

<script>
// === POP-UP CONNEXION GOOGLE ‚Äî S'AFFICHE UNIQUEMENT SI NON CONNECT√â ===
document.addEventListener('DOMContentLoaded', () => {
  const popup = document.getElementById('googleLoginPopup');
  const closeBtn = document.getElementById('closePopupBtn');
  const loginBtn = document.getElementById('popupLoginBtn');

  // Fermer le pop-up avec la croix
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      popup.style.display = 'none';
    });
  }

  // Bouton connexion Google dans le pop-up
  if (loginBtn) {
    loginBtn.addEventListener('click', () => {
      if (typeof firebase !== 'undefined' && firebase.auth) {
        firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
      } else {
        alert("Firebase non charg√© ‚Äì recharge la page");
      }
    });
  }

  // V√©rifie l'√©tat de connexion toutes les 500ms jusqu'√† ce que currentUser soit d√©fini
  const checkConnection = setInterval(() => {
    if (typeof window.currentUser !== 'undefined') {
      clearInterval(checkConnection);

      // SI L‚ÄôUTILISATEUR N‚ÄôEST PAS CONNECT√â ‚Üí affiche le pop-up
      if (!window.currentUser) {
        popup.style.display = 'flex';
      }
      // Sinon (connect√©) ‚Üí rien, le pop-up reste cach√©
    }
  }, 500);
});
</script>

  <!-- CLASSEMENT + DATE DANS LES CONSEILS (dans app.js) -->
  <script src="app.js"></script>
</body>
</html>
