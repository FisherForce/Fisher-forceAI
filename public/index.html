<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI — La 1ère IA de pêche 100% Française</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    @keyframes pulse {0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    @keyframes blink {0%,100%{opacity:1}50%{opacity:0.3}}
    .live-badge {position:fixed;top:15px;left:15px;background:#00d4aa;color:white;padding:10px 16px;border-radius:50px;font-weight:bold;font-size:14px;box-shadow:0 4px 12px rgba(0,212,170,0.4);z-index:9999;display:flex;align-items:center;gap:8px;animation:pulse 2s infinite;}
    .live-dot {width:10px;height:10px;background:#fff;border-radius:50%;animation:blink 1.5s infinite;}
    .dashboard {background:linear-gradient(135deg,#00d4aa,#00a085);color:white;padding:18px;border-radius:16px;margin:20px 0;text-align:center;box-shadow:0 8px 20px rgba(0,212,170,0.3);}
    .level-badge {background:#ffd700;color:#000;padding:6px 14px;border-radius:30px;font-weight:bold;}
  </style>
</head>
<body>

  <div class="live-badge"><span class="live-dot"></span> IA en direct : <span id="patternCount">42</span> patterns appris</div>

  <!-- AUTH + PSEUDO + AMIS -->
  <div id="authContainer" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.4);padding:10px 16px;border-radius:30px;">
    <div id="userInfo" style="display:none;color:white;font-weight:bold;align-items:center;gap:10px;">
      <input id="pseudoInput" type="text" placeholder="Ton pseudo" style="padding:6px 10px;border-radius:20px;border:none;font-size:13px;width:110px;">
      <button id="savePseudo" style="background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">OK</button>
      <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:8px 14px;border-radius:25px;font-size:12px;cursor:pointer;">Déco</button>
    </div>
    <button id="loginBtn" style="background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;">Connexion Google</button>

    <button id="friendsBtn" style="background:#ffd700;color:#000;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;font-size:14px;">
      Amis (<span id="friendCount">0</span>)
    </button>
  </div>

  <!-- MODALE AMIS -->
  <div id="friendsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:9999;overflow-y:auto;padding:20px;">
    <div style="max-width:420px;margin:0 auto;background:#112233;border-radius:20px;padding:20px;position:relative;">
      <button onclick="document.getElementById('friendsModal').style.display='none'" style="position:absolute;top:10px;right:10px;background:#e74c3c;color:white;border:none;padding:10px 16px;border-radius:50%;font-size:18px;cursor:pointer;">X</button>
      <h2 style="text-align:center;color:#00d4aa;margin:0 0 20px;">Amis FisherForce</h2>
      <div style="background:#333;padding:15px;border-radius:12px;margin-bottom:20px;">
        <input type="text" id="searchFriend" placeholder="Pseudo exact de ton pote" style="width:100%;padding:12px;border:none;border-radius:10px;margin-bottom:10px;">
        <button onclick="addFriendByPseudo()" style="width:100%;background:#00d4aa;color:white;padding:12px;border:none;border-radius:10px;font-weight:bold;">Ajouter cet ami</button>
      </div>
      <div id="friendsList" style="color:white;">Chargement…</div>
    </div>
  </div>

  <!-- TON CONTENU HABITUEL (formulaire, conseils, classement, etc.) -->
  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1ère IA de pêche 100% Française</p>
    </div>
  </header>

  <main class="container main-grid">
    <!-- Colle ici tout ton formulaire + section conseils + classement comme avant -->
    <!-- (je te laisse remettre ton code habituel, il n’a pas changé) -->
  </main>

  <!-- BOUTON CARTE EN BAS À DROITE -->
  <button id="openMapBtn" style="position:fixed;bottom:20px;right:20px;background:#00d4aa;color:white;border:none;padding:16px 20px;border-radius:50%;font-size:28px;box-shadow:0 8px 25px rgba(0,212,170,0.6);z-index:9998;cursor:pointer;">
    Map
  </button>

  <!-- MODALE CARTE SECRÈTE -->
  <div id="mapModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;">
    <div style="position:relative;width:100%;height:100%;">
      <button onclick="document.getElementById('mapModal').style.display='none'" style="position:absolute;top:15px;right:15px;background:#e74c3c;color:white;border:none;padding:12px 18px;border-radius:50%;font-size:18px;z-index:10000;cursor:pointer;">X</button>
      <h2 id="mapTitle" style="position:absolute;top:15px;left:50%;transform:translateX(-50%);color:#00d4aa;z-index:10000;font-size:26px;text-shadow:0 2px 10px black;">Ma Carte Secrète</h2>
      <div id="fishingMap" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- TOUT LE CODE CARTE + AMIS + AUTH (indépendant de ton app.js) -->
  <script>
    // On attend que Firebase soit chargé par ton app.js
    function waitForFirebase() {
      if (typeof firebase !== 'undefined' && firebase.apps?.length > 0) {
        initAuthAndMap();
      } else {
        setTimeout(waitForFirebase, 50);
      }
    }

    function initAuthAndMap() {
      const auth = firebase.auth();
      const rtdb = firebase.database();
      window.currentUser = null;

      auth.onAuthStateChanged(user => {
        window.currentUser = user;
        if (user) {
          document.getElementById('userInfo').style.display = 'flex';
          document.getElementById('loginBtn').style.display = 'none';
          loadPseudo();
          loadFriends();
        } else {
          document.getElementById('userInfo').style.display = 'none';
          document.getElementById('loginBtn').style.display = 'block';
        }
      });

      document.getElementById('loginBtn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      document.getElementById('logoutBtn').onclick = () => auth.signOut();

      function loadPseudo() {
        if (!window.currentUser) return;
        rtdb.ref('users/' + window.currentUser.uid + '/displayName').once('value', s => {
          const pseudo = s.val() || '';
          document.getElementById('pseudoInput').value = pseudo;
          localStorage.setItem('fisherPseudo', pseudo);
        });
      }

      document.getElementById('savePseudo').onclick = () => {
        const pseudo = document.getElementById('pseudoInput').value.trim();
        if (pseudo && window.currentUser) {
          rtdb.ref('users/' + window.currentUser.uid).update({ displayName: pseudo });
          localStorage.setItem('fisherPseudo', pseudo);
        }
      };

      // === AMIS ===
      document.getElementById('friendsBtn').onclick = () => {
        document.getElementById('friendsModal').style.display = 'block';
        loadFriends();
      };

      function loadFriends() {
        if (!window.currentUser) return;
        rtdb.ref('users/' + window.currentUser.uid + '/friends').on('value', snap => {
          const friends = snap.val() || {};
          const uids = Object.keys(friends);
          document.getElementById('friendCount').textContent = uids.length;
          const list = document.getElementById('friendsList');
          if (uids.length === 0) {
            list.innerHTML = '<p style="text-align:center;color:#666;margin-top:30px;">Aucun ami pour l’instant</p>';
            return;
          }
          list.innerHTML = `<h3 style="color:#00d4aa;text-align:center;">Tes amis (${uids.length})</h3>`;
          uids.forEach(uid => {
            rtdb.ref('users/' + uid + '/displayName').once('value').then(s => {
              const name = s.val() || "Pêcheur";
              list.innerHTML += `
                <div style="background:#333;padding:14px;margin:8px 0;border-radius:12px;display:flex;justify-content:space-between;align-items:center;">
                  <strong style="color:white;">${name}</strong>
                  <button onclick="showFriendMap('${uid}','${name}')" style="background:#ffd700;color:black;padding:8px 16px;border:none;border-radius:10px;font-weight:bold;">Voir sa carte</button>
                </div>`;
            });
          });
        });
      }

      window.addFriendByPseudo = () => {
        const pseudo = document.getElementById('searchFriend').value.trim();
        if (!pseudo) return alert("Entre un pseudo");
        rtdb.ref('users').orderByChild('displayName').equalTo(pseudo).once('value', snap => {
          if (!snap.exists()) return alert("Pseudo introuvable");
          const uid = Object.keys(snap.val())[0];
          if (uid === window.currentUser.uid) return alert("C’est toi !");
          rtdb.ref('users/' + window.currentUser.uid + '/friends/' + uid).set(true);
          alert(pseudo + " ajouté !");
          document.getElementById('searchFriend').value = '';
        });
      };

      window.showFriendMap = (uid, name) => {
        document.getElementById('friendsModal').style.display = 'none';
        document.getElementById('mapModal').style.display = 'block';
        document.getElementById('mapTitle').textContent = `Carte secrète de ${name}`;
        setTimeout(() => initFriendMap(uid), 300);
      };

      // === CARTE ===
      let personalMap = null;

      function initPersonalMap() {
        if (personalMap) personalMap.remove();
        personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(personalMap);

        const uid = window.currentUser?.uid || '';
        const spots = JSON.parse(localStorage.getItem('myPersonalSpots_' + uid) || '[]');

        spots.forEach(spot => {
          const marker = L.marker([spot.lat, spot.lng], {
            icon: L.divIcon({
              html: `<div style="background:#00d4aa;color:white;padding:10px 18px;border-radius:16px;font-weight:bolder;font-size:16px;border:4px solid white;box-shadow:0 6px 20px black;">${spot.name}</div>`,
              iconSize: [160, 60],
              iconAnchor: [80, 60]
            })
          }).addTo(personalMap);

          marker.bindPopup(() => {
            const catches = spot.catches || [];
            const html = catches.length === 0 ? '<p style="color:#aaa;">Aucune prise</p>' : catches.map(c => `
              <div style="margin:8px 0;padding:10px;background:rgba(255,255,255,0.2);border-radius:8px;">
                ${c.photo ? `<img src="${c.photo}" style="width:100%;border-radius:8px;margin-bottom:8px;">` : ''}
                <b>${c.species} — ${c.weight}kg</b><br>${c.lure||'NC'}<br><small>${c.date}</small>
              </div>`).join('');
            return `<div style="width:280px;"><h3 style="color:#00d4aa;text-align:center;">${spot.name}</h3>${html}
              <button onclick="addCatch(${spot.lat},${spot.lng})" style="margin-top:10px;width:100%;background:#ffd700;color:black;padding:12px;border:none;border-radius:10px;font-weight:bold;">+ Prise</button>
            </div>`;
          });
        });

        personalMap.on('dblclick', e => {
          const name = prompt("Nom du spot secret ?", "Spot du Maître");
          if (!name?.trim()) return;
          const newSpot = { name: name.trim(), lat: e.latlng.lat, lng: e.latlng.lng, catches: [] };
          spots.push(newSpot);
          localStorage.setItem('myPersonalSpots_' + uid, JSON.stringify(spots));
          initPersonalMap();
        });

        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(pos => {
            personalMap.setView([pos.coords.latitude, pos.coords.longitude], 14);
            L.marker([pos.coords.latitude, pos.coords.longitude], {icon: L.divIcon({html: '<div style="font-size:50px;color:#00ff00;">Person</div>'})})
              .addTo(personalMap).bindPopup("T'es là !").openPopup();
          });
        }
      }

      function initFriendMap(uid) {
        if (personalMap) personalMap.remove();
        personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(personalMap);
        const spots = JSON.parse(localStorage.getItem('myPersonalSpots_' + uid) || '[]');
        spots.forEach(s => {
          L.marker([s.lat, s.lng], {icon: L.divIcon({html: `<div style="background:#ff4757;color:white;padding:10px 16px;border-radius:12px;font-weight:bold;">${s.name}</div>`})})
            .addTo(personalMap)
            .bindPopup(`Spot secret de ${document.getElementById('mapTitle').textContent.split('de ')[1]}`);
        });
      }

      window.addCatch = (lat, lng) => {
        const species = prompt("Espèce", "Brochet") || "";
        const weight = prompt("Poids en kg", "8.5") || "0";
        const lure = prompt("Leurre utilisé", "") || "";
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = ev => {
            const uid = window.currentUser?.uid || '';
            const spots = JSON.parse(localStorage.getItem('myPersonalSpots_' + uid) || '[]');
            const spot = spots.find(s => Math.abs(s.lat - lat) < 0.0001 && Math.abs(s.lng - lng) < 0.0001);
            if (spot) {
              spot.catches = spot.catches || [];
              spot.catches.push({ species, weight: parseFloat(weight), lure, photo: ev.target.result, date: new Date().toLocaleDateString('fr-FR') });
              localStorage.setItem('myPersonalSpots_' + uid, JSON.stringify(spots));
              alert("Prise ajoutée sur ton spot !");
              initPersonalMap();
            }
          };
          reader.readAsDataURL(file);
        };
        input.click();
      };

      document.getElementById('openMapBtn').onclick = () => {
        document.getElementById('mapModal').style.display = 'block';
        document.getElementById('mapTitle').textContent = "Ma Carte Secrète";
        setTimeout(initPersonalMap, 300);
      };
    }

    waitForFirebase();
  </script>

  <!-- Ton app.js normal (celui que tu avais avant) -->
  <script src="app.js"></script>
</body>
</html>
