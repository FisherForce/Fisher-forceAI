<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI — La 1ère IA de pêche 100% Française</title>
  <link rel="stylesheet" href="styles.css">
  
  <!-- Leaflet (chargé une seule fois, au bon endroit) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .badge-ia { position: fixed; top: 15px; right: 15px; background: #00d4aa; color: white; padding: 8px 16px; border-radius: 50px; font-weight: bold; font-size: 13px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); z-index: 9999; animation: pulse 2s infinite; }
    .live-badge { position: fixed; top: 15px; left: 15px; background: #00d4aa; color: white; padding: 10px 16px; border-radius: 50px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(0,212,170,0.4); z-index: 9999; display: flex; align-items: center; gap: 8px; animation: pulse 2s infinite; }
    .live-dot { width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: blink 1.5s infinite; }
    .dashboard { background: linear-gradient(135deg, #00d4aa, #00a085); color: white; padding: 18px; border-radius: 16px; margin: 20px 0; text-align: center; box-shadow: 0 8px 20px rgba(0,212,170,0.3); }
    .level-badge { background: #ffd700; color: #000; padding: 6px 14px; border-radius: 30px; font-weight: bold; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-top: 12px; }
    .stat-item { background: rgba(255,255,255,0.25); padding: 10px; border-radius: 10px; }
    .player-rank { background: #112233; margin: 12px 0; padding: 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 16px; transition: all 0.3s; }
    .player-rank.you { background: #00d4aa !important; color: #000; font-weight: bold; box-shadow: 0 0 20px rgba(0,212,170,0.6); }
    .rank-num { font-size: 24px; font-weight: bold; width: 50px; text-align: center; }
    .player-name { flex: 1; margin-left: 15px; }
    .player-level { font-size: 12px; color: #aaa; margin-top: 2px; }
    .player-xp { font-weight: bold; color: #ffd700; }
    .no-players { text-align: center; color: #777; font-style: italic; margin: 30px 0; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="live-badge"><span class="live-dot"></span> IA en direct : <span id="patternCount">42</span> patterns appris</div>

  <!-- AUTH + PSEUDO + AMIS -->
  <div id="authContainer" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.3);padding:10px 16px;border-radius:30px;">
    <div id="userInfo" style="display:none;color:white;font-weight:bold;align-items:center;gap:10px;">
      <input id="pseudoInput" type="text" placeholder="Ton pseudo" style="padding:6px 10px;border-radius:20px;border:none;font-size:13px;width:100px;">
      <button id="savePseudo" style="background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">OK</button>
      <button id="friendsBtn" style="background:#ffd700;color:#000;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;font-size:14px;">
        Amis (<span id="friendCount">0</span>)
      </button>

<!-- MODALE AMIS -->
<div id="friendsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;">
  <div style="background:#112233;padding:20px;border-radius:16px;margin:20px;max-width:400px;max-height:80vh;overflow-y:auto;">
    <h2 style="color:#00d4aa;text-align:center;">Tes Amis FisherForce</h2>
    
    <div style="margin:15px 0;padding:10px;background:#333;border-radius:10px;">
      <input type="text" id="searchFriend" placeholder="Pseudo ou email de l'ami" style="width:100%;padding:10px;border:none;border-radius:10px;">
      <button onclick="sendFriendRequest()" style="margin-top:8px;width:100%;background:#00d4aa;color:white;padding:12px;border:none;border-radius:10px;font-weight:bold;">Ajouter</button>
    </div>
    <script>
// === RÉSEAU SOCIAL AMIS + PARTAGE DE CARTE ===
let currentUserUid = null;

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    currentUserUid = user.uid;
    localStorage.setItem('fisherPseudo', user.displayName || user.email.split('@')[0]);
    loadFriends();
  }
});

document.getElementById('friendsBtn').addEventListener('click', () => {
  document.getElementById('friendsModal').style.display = 'block';
  loadFriendRequests();
  loadFriends();
});

function sendFriendRequest() {
  const search = document.getElementById('searchFriend').value.trim();
  if (!search) return alert("Entre un pseudo ou email");

  // Recherche l'utilisateur
  db.collection('users').where('displayName', '==', search).get()
    .then(snap => {
      if (snap.empty) return alert("Aucun pêcheur trouvé avec ce pseudo");

      const friend = snap.docs[0];
      const friendUid = friend.id;

      if (friendUid === currentUserUid) return alert("Tu ne peux pas t'ajouter toi-même");

      // Envoie la demande
      db.collection('friendRequests').add({
        from: currentUserUid,
        to: friendUid,
        fromName: localStorage.getItem('fisherPseudo'),
        status: 'pending',
        date: new Date()
      }).then(() => {
        alert(`Demande envoyée à ${search} !`);
        document.getElementById('searchFriend').value = '';
      });
    });
}

function loadFriendRequests() {
  db.collection('friendRequests').where('to', '==', currentUserUid).where('status', '==', 'pending')
    .onSnapshot(snap => {
      const list = document.getElementById('friendRequestsList');
      if (snap.empty) {
        list.innerHTML = '<p style="color:#aaa;text-align:center;">Aucune demande en attente</p>';
        return;
      }

      list.innerHTML = '<h3 style="color:#ffd700;">Demandes reçues</h3>';
      snap.forEach(doc => {
        const req = doc.data();
        list.innerHTML += `
          <div style="background:#333;padding:10px;margin:8px 0;border-radius:10px;display:flex;justify-content:space-between;align-items:center;">
            <span><strong>${req.fromName}</strong> veut être ton ami</span>
            <div>
              <button onclick="acceptFriend('${doc.id}', '${req.from}')" style="background:#00d4aa;color:white;padding:6px 12px;border:none;border-radius:8px;margin-left:5px;">Accepter</button>
              <button onclick="db.collection('friendRequests').doc('${doc.id}').delete()" style="background:#e74c3c;color:white;padding:6px 12px;border:none;border-radius:8px;">Refuser</button>
            </div>
          </div>
        `;
      });
    });
}

function acceptFriend(reqId, friendUid) {
  // Ajoute dans les deux sens
  db.collection('friends').doc(currentUserUid).set({[friendUid]: true}, {merge: true});
  db.collection('friends').doc(friendUid).set({[currentUserUid]: true}, {merge: true});
  db.collection('friendRequests').doc(reqId).update({status: 'accepted'});
}

function loadFriends() {
  db.collection('friends').doc(currentUserUid).onSnapshot(doc => {
    if (!doc.exists) {
      document.getElementById('friendCount').textContent = '0';
      document.getElementById('friendsList').innerHTML = '<p style="color:#aaa;text-align:center;">Aucun ami pour l’instant</p>';
      return;
    }

    const friends = Object.keys(doc.data());
    document.getElementById('friendCount').textContent = friends.length;

    let html = '<h3 style="color:#00d4aa;">Tes amis (' + friends.length + ')</h3>';
    friends.forEach(uid => {
      db.collection('users').doc(uid).get().then(u => {
        const name = u.data()?.displayName || 'Inconnu';
        html += `
          <div style="background:#333;padding:12px;margin:8px 0;border-radius:12px;display:flex;justify-content:space-between;align-items:center;">
            <span><strong>${name}</strong></span>
            <button onclick="viewFriendMap('${uid}', '${name}')" style="background:#ffd700;color:black;padding:8px 16px;border:none;border-radius:10px;font-weight:bold;">
              Voir sa carte
            </button>
          </div>
        `;
        document.getElementById('friendsList').innerHTML = html;
      });
    });
  });
}

function viewFriendMap(friendUid, friendName) {
  document.getElementById('friendsModal').style.display = 'none';
  document.getElementById('mapModal').style.display = 'block';
  document.querySelector('#mapModal h2').textContent = `Carte secrète de ${friendName}`;

  setTimeout(() => {
    if (personalMap) personalMap.remove();
    personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(personalMap);

    db.collection('personalSpots').doc(friendUid).collection('spots').get()
      .then(snap => {
        snap.forEach(doc => {
          const s = doc.data();
          L.marker([s.lat, s.lng], {
            icon: L.divIcon({html: `<div style="background:#ff6b6b;color:white;padding:10px 16px;border-radius:14px;font-weight:bold;">${s.name}</div>`, iconSize: [140,50], iconAnchor: [70,50]})
          }).addTo(personalMap)
            .bindPopup(`<b style="color:#ff6b6b;">Spot de ${friendName}</b><br>${s.name}`);
        });
      });
  }, 300);
}
</script>

    <div id="friendRequestsList"></div>
    <div id="friendsList"></div>

    <button onclick="document.getElementById('friendsModal').style.display='none'" style="margin-top:20px;width:100%;background:#e74c3c;color:white;padding:12px;border:none;border-radius:10px;">Fermer</button>
  </div>
</div>
      <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:8px 14px;border-radius:25px;font-size:12px;cursor:pointer;">Déconnexion</button>
    </div>
    <button id="loginBtn" style="background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;">Connexion Google</button>
  </div>

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1ère IA de pêche 100% Française</p>
    </div>
  </header>

  <main class="container main-grid">
    <section class="card input-card">
      <h2>Décris ton spot</h2>
      <label>Nom du spot <input id="spotName" placeholder="Ex: Étang du Moulin"></label>
      <label>Type d'eau<br><select id="waterType"><option>Étang</option><option>Rivière</option><option>Lac</option><option>Canal</option></select></label>
      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>
      <label>Espèce ciblée <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>
      <label>Conditions <input id="conditions" placeholder="Ex: clair, pluie"></label>
      <label>Température (°C)<br><input type="number" id="temperature" placeholder="15"></label>
      <div style="margin-top:15px;">
        <button id="getAdvice">Obtenir des conseils</button>
        <button id="voiceBtn">Commande vocale</button>
        <button id="clearBtn">Réinitialiser</button>
      </div>
    </section>

    <section class="card output-card">
      <h2>Conseils de l'IA</h2>
      <div class="dashboard">
        <h3><span class="level-badge">Débutant</span> — <span id="xp">0</span> XP</h3>
        <div class="stats-grid">
          <div class="stat-item">Spots : <strong>0</strong></div>
          <div class="stat-item">Espèces : <strong>0</strong></div>
          <div class="stat-item">Réussite : <strong>0%</strong></div>
        </div>
      </div>

      <div id="advice"><p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p></div>

      <button onclick="openResultat()" style="margin:20px auto; display:block; width:90%; background:#00d4aa; color:white; border:none; padding:14px; border-radius:10px; font-weight:bold;">
        Enregistrer un résultat
      </button>

      <!-- CLASSEMENT RÉEL -->
      <div id="tab-ranking" class="tab-content">
        <h2>Classement des Pêcheurs</h2>
        <div id="ranking-list" style="margin-top:20px;">
          <p class="muted" style="text-align:center;">Chargement du classement…</p>
        </div>
      </div>
    </section>
  </main>

  <!-- BOUTON CARTE (unique) -->
  <button id="openMapBtn" style="position:fixed;bottom:20px;right:20px;background:#00d4aa;color:white;border:none;padding:16px 20px;border-radius:50%;font-size:28px;box-shadow:0 8px 25px rgba(0,212,170,0.6);z-index:9998;cursor:pointer;">
    Map
  </button>

  <!-- MODALE CARTE (unique) -->
  <div id="mapModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;">
    <div style="position:relative;width:100%;height:100%;">
      <button onclick="document.getElementById('mapModal').style.display='none'" style="position:absolute;top:15px;right:15px;background:#e74c3c;color:white;border:none;padding:12px 18px;border-radius:50%;font-size:18px;z-index:10000;cursor:pointer;">X</button>
      <h2 style="position:absolute;top:15px;left:50%;transform:translateX(-50%);color:#00d4aa;z-index:10000;font-size:26px;text-shadow:0 2px 10px black;">Carte Privée FisherForce</h2>
      <div id="fishingMap" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- FONCTION CARTE COMMUNAUTAIRE MONDIALE (version finale, propre et fonctionnelle) -->
<script>
// === CARTE PERSONNELLE + PRISES + PHOTOS (VERSION LÉGENDAIRE) ===
let personalMap = null;
let personalMarkers = {};

function initPersonalMap() {
  if (personalMap) personalMap.remove();

  personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap'}).addTo(personalMap);

  const mySpots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');

  mySpots.forEach(spot => {
    const key = spot.lat + '_' + spot.lng;

    const marker = L.marker([spot.lat, spot.lng], {
      icon: L.divIcon({
        html: `<div style="background:#00d4aa;color:white;padding:10px 18px;border-radius:16px;font-weight:bolder;font-size:16px;border:4px solid white;box-shadow:0 6px 20px black;">${spot.name}</div>`,
        iconSize: [160, 60], iconAnchor: [80, 60]
      })
    }).addTo(personalMap);

    personalMarkers[key] = marker;

    // Ouvre la popup avec bouton + pour ajouter une prise
    marker.bindPopup(() => {
      const catches = spot.catches || [];
      let catchesHTML = catches.length === 0 
        ? '<p style="color:#aaa;">Aucune prise enregistrée</p>' 
        : catches.map(c => `
          <div style="margin:8px 0;padding:10px;background:rgba(255,255,255,0.2);border-radius:8px;">
            ${c.photo ? `<img src="${c.photo}" style="width:100%;max-height:150px;object-fit:cover;border-radius:8px;margin-bottom:8px;">` : ''}
            <b>${c.species} — ${c.weight}kg</b><br>
            Leurre: ${c.lure || 'NC'}<br>
            <small>${c.date} — ${c.comment || ''}</small>
          </div>
        `).join('');

      return `
        <div style="width:280px;font-family:sans-serif;">
          <h3 style="margin:0 0 10px;color:#00d4aa;text-align:center;">${spot.name}</h3>
          ${catchesHTML}
          <button onclick="openCatchForm(${spot.lat},${spot.lng})" style="margin-top:10px;width:100%;background:#ffd700;color:black;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">
            Ajouter une prise
          </button>
        </div>
      `;
    });
  });

  // Sessions prises/bredouilles
  const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
  sessions.forEach(s => {
    if (s.lat && s.lng) {
      L.marker([s.lat, s.lng], {
        icon: L.divIcon({html: s.success ? '<div style="font-size:40px;">Fish</div>' : '<div style="font-size:40px;">Cross</div>', iconSize: [40,40], iconAnchor: [20,40]})
      }).addTo(personalMap)
        .bindPopup(`<b style="color:${s.success?'#00d4aa':'#e74c3c'};">${s.success?'Prise':'Bredouille'}</b><br>${s.spot}`);
    }
  });

  // Double-clic = nouveau spot
  personalMap.on('dblclick', e => {
    const name = prompt("Nom de ton nouveau spot secret :", "Spot du Maître Thao");
    if (!name || name.trim().length < 2) return;

    const newSpot = {
      name: name.trim(),
      lat: e.latlng.lat,
      lng: e.latlng.lng,
      date: new Date().toLocaleDateString('fr-FR'),
      catches: []
    };

    const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
    spots.push(newSpot);
    localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
    alert(`Spot "${name}" créé !`);
    initPersonalMap();
  });

  // Géolocalisation
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(pos => {
      personalMap.setView([pos.coords.latitude, pos.coords.longitude], 14);
      L.marker([pos.coords.latitude, pos.coords.longitude], {
        icon: L.divIcon({html: '<div style="font-size:50px;color:#00ff00;">Person</div>', iconSize: [50,50], iconAnchor: [25,50]})
      }).addTo(personalMap).bindPopup("T'es là, Légende !").openPopup();
    });
  }
}

// FORMULAIRE D'AJOUT DE PRISE
function openCatchForm(lat, lng) {
  const species = prompt("Espèce (brochet, perche, sandre...)", "Brochet") || "";
  const weight = prompt("Poids en kg (ex: 8.5)", "0") || "0";
  const lure = prompt("Leurre utilisé ?", "Spinnerbait") || "";
  const comment = prompt("Commentaire (facultatif)", "") || "";

  // Photo
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment'; // force caméra sur mobile
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      saveCatch(lat, lng, species, weight, lure, comment, ev.target.result);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

// SAUVEGARDE LA PRISE
function saveCatch(lat, lng, species, weight, lure, comment, photoDataUrl = null) {
  const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
  const spot = spots.find(s => s.lat === lat && s.lng === lng);
  if (!spot) return;

  spot.catches = spot.catches || [];
  spot.catches.push({
    species: species.trim(),
    weight: parseFloat(weight),
    lure: lure.trim(),
    comment: comment.trim(),
    photo: photoDataUrl,
    date: new Date().toLocaleDateString('fr-FR')
  });

  localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
  alert(`${species} de ${weight}kg ajouté à ton spot !`);
  initPersonalMap();
}

// OUVRE LA CARTE
document.getElementById('openMapBtn').addEventListener('click', () => {
  document.getElementById('mapModal').style.display = 'block';
  setTimeout(initPersonalMap, 300);
});
</script>
  <!-- Ton classement (gardé intact) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const waitForApp = () => {
        if (window.db && typeof window.currentUser !== 'undefined') {
          initRanking();
        } else {
          setTimeout(waitForApp, 100);
        }
      };
      waitForApp();

      function initRanking() {
        const db = window.db;
        const rankingList = document.getElementById('ranking-list');
        let currentUserUid = null;

        const updateUser = () => {
          currentUserUid = window.currentUser?.uid || null;
        };
        updateUser();
        setInterval(updateUser, 500);

        db.collection('users')
          .orderBy('xp', 'desc')
          .limit(50)
          .onSnapshot(snapshot => {
            const players = [];
            let rank = 1;
            let yourRank = null;

            snapshot.docs.forEach(doc => {
              const data = doc.data();
              if (data.xp >= 0 && data.displayName) {
                players.push({ ...data, rank: rank++ });
                if (data.uid === currentUserUid) yourRank = rank - 1;
              }
            });

            if (players.length === 0) {
              rankingList.innerHTML = `<p class="no-players">Aucun pêcheur pour l'instant… Sois le premier !</p>`;
              return;
            }

            const top10 = players.slice(0, 10).map(p => `
              <div class="player-rank ${p.uid === currentUserUid ? 'you' : ''}">
                <div class="rank-num">#${p.rank}</div>
                <div class="player-name">${p.displayName}<div class="player-level">${p.xp < 50 ? "Débutant" : p.xp < 200 ? "Traqueur" : "Maître du brochet"}</div></div>
                <div class="player-xp">${p.xp} XP</div>
              </div>
            `).join('');

            let footer = '';
            if (yourRank && yourRank > 10) {
              const you = players.find(p => p.uid === currentUserUid);
              footer = `<div style="margin-top:25px;text-align:center;color:#00d4aa;font-weight:bold;">Ta position : #${yourRank}</div>
                        <div class="player-rank you"><div class="rank-num">#${yourRank}</div><div class="player-name">Toi !</div><div class="player-xp">${you.xp} XP</div></div>`;
            }

            rankingList.innerHTML = top10 + footer;
          });
      }
    });
  </script>

  <!-- app.js en dernier -->
  <script src="app.js"></script>
</body>
</html>
