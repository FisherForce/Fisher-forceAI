
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI ‚Äî La 1√®re IA de p√™che 100% Fran√ßaise</title>
  <link rel="stylesheet" href="styles.css">
  <!-- FAVICON FISHERFORCE AI ‚Äì avec ton logo.jpg -->
<link rel="icon" href="/logo.jpg" type="image/jpeg">
<link rel="shortcut icon" href="/logo.jpg" type="image/jpeg">
<link rel="apple-touch-icon" href="/logo.jpg">
<link rel="apple-touch-icon-precomposed" href="/logo.jpg">

<!-- Pour les diff√©rentes tailles (recommand√© pour mobile et desktop) -->
<link rel="icon" sizes="192x192" href="/logo.jpg">
<link rel="icon" sizes="512x512" href="/logo.jpg">

<!-- Pour iOS (√©cran d'accueil) -->
<link rel="apple-touch-icon" sizes="180x180" href="/logo.jpg">

<!-- Couleur du th√®me navigateur (barre d'adresse mobile) -->
<meta name="theme-color" content="#001122">
<meta name="msapplication-TileColor" content="#001122">
<meta name="msapplication-TileImage" content="/logo.jpg">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<style>
  /* Animations originales gard√©es */
  @keyframes pulse {0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
  @keyframes blink {0%,100%{opacity:1}50%{opacity:0.3}}

  /* Classes originales gard√©es et am√©lior√©es */
  .live-dot {
    width: 10px;
    height: 10px;
    background: #fff;
    border-radius: 50%;
    animation: blink 1.5s infinite;
    box-shadow: 0 0 8px rgba(255,255,255,0.6);
  }

  .dashboard {
    background: linear-gradient(135deg, #00d4aa, #00a085);
    color: white;
    padding: 20px;
    border-radius: 18px;
    margin: 24px 0;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,212,170,0.4);
    transition: transform 0.3s ease;
  }

  .dashboard:hover {
    transform: translateY(-4px);
  }

  .level-badge {
    background: #ffd700;
    color: #000;
    padding: 8px 16px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 16px;
    box-shadow: 0 4px 12px rgba(255,215,0,0.4);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }

  .stat-item {
    background: rgba(255,255,255,0.18);
    padding: 14px;
    border-radius: 12px;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.08);
    transition: transform 0.2s ease;
  }

  .stat-item:hover {
    transform: scale(1.05);
  }

  .player-rank {
    background: #112233;
    margin: 16px 0;
    padding: 18px;
    border-radius: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
  }

  .player-rank.you {
    background: #00d4aa !important;
    color: #000;
    font-weight: bold;
    box-shadow: 0 0 25px rgba(0,212,170,0.6);
    transform: scale(1.02);
  }

  .rank-num {
    font-size: 28px;
    font-weight: bold;
    width: 60px;
    text-align: center;
    color: #ffd700;
  }

  .player-name {
    flex: 1;
    margin-left: 20px;
    font-weight: 600;
  }

  .player-level {
    font-size: 14px;
    color: #aaa;
    margin-top: 4px;
  }

  .player-xp {
    font-weight: bold;
    color: #ffd700;
    font-size: 18px;
  }

  /* Am√©liorations globales (ajout√©es sans casser l'ancien) */
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f1724, #081427);
    color: #e6eef6;
    min-height: 100vh;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr 1fr; /* 2 colonnes sur mobile */
      gap: 12px;
    }

    .player-rank {
      font-size: 14px;
      padding: 14px;
    }

    .rank-num {
      font-size: 24px;
      width: 50px;
    }
  }
</style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- PWA INSTALLABLE SUR MOBILE (logo + ic√¥ne garantie) -->
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/logo.jpg" type="image/jpeg" sizes="any">
<link rel="apple-touch-icon" href="/logo.jpg">
<link rel="apple-touch-icon-precomposed" href="/logo.jpg">
<meta name="theme-color" content="#00ff9d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
</head>

<body>
  <!-- LOGO EN COIN HAUT GAUCHE -->
<div style="position:fixed;top:15px;left:15px;z-index:9999;">
  <img src="logo.jpg" alt="Logo" style="width:60px;height:60px;border-radius:50%;box-shadow:0 0 20px #00ff9d;">
</div>


  <!-- AUTH + PSEUDO -->
  <div id="authContainer" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.3);padding:10px 16px;border-radius:30px;">
    <div id="userInfo" style="display:none;color:white;font-weight:bold;align-items:center;gap:10px;">
      <input id="pseudoInput" type="text" placeholder="Ton pseudo" style="padding:6px 10px;border-radius:20px;border:none;font-size:13px;width:100px;">
      <button id="savePseudo" style="background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">OK</button>
      <!-- MENU "‚Ä¶" POUR JOURNAL & ALBUM -->
<div style="display:inline-block;position:relative;">
  <button id="menuToggleBtn" style="background:#001122;color:#00d4aa;padding:10px 18px;border:2px solid #00d4aa;border-radius:50px;font-weight:bold;font-size:18px;cursor:pointer;box-shadow:0 6px 20px rgba(0,212,170,0.3);">
    ‚ãØ
  </button>

  <!-- BOUTONS CACH√âS (apparaissent au clic) -->
  <div id="menuDropdown" style="display:none;position:absolute;top:60px;right:0;background:#001122;border:2px solid #00d4aa;border-radius:18px;padding:15px;box-shadow:0 15px 40px rgba(0,212,170,0.5);z-index:9999;white-space:nowrap;">


    <button id="toggleMaterielBtn" style="
  width: 100%;
  max-width: 400px;
  margin: 30px auto;
  padding: 18px 30px;
  background: linear-gradient(135deg, #00ff9d, #00d4aa);
  color: #000;
  border: none;
  border-radius: 50px;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(0,255,157,0.4);
  transition: all 0.3s ease;
  display: block;
">
  üé£ Mon mat√©riel & setup
</button>
   <button onclick="showStatsPopup()" style="
  width: 100%;
  padding: 18px;
  margin-top: 15px;
  background: #00ff9d;
  color: #000;
  border: none;
  border-radius: 50px;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(0,255,157,0.4);
">
  üìä Voir mes stats & progression
</button>
    <button id="openAlbumBtn" style="display:block;width:100%;background:#ff6b00;color:white;padding:15px 20px;border:none;border-radius:15px;font-weight:bold;font-size:18px;cursor:pointer;box-shadow:0 8px 20px rgba(255,107,0,0.4);">
      üì∏ Voir mon Album photos
    </button>
      <!-- BOUTON LEURRES BLACKLIST√âS (√† c√¥t√© du pseudo) -->
<button id="openBlacklistBtn" style="background:#e74c3c;color:white;padding:10px 18px;border:none;border-radius:50px;font-weight:bold;font-size:16px;margin-left:15px;cursor:pointer;box-shadow:0 8px 20px rgba(231,76,60,0.6);position:relative;">
  üö´ Blacklist
  <span id="blacklistCount" style="position:absolute;top:-8px;right:-8px;background:#ff0000;color:white;border-radius:50%;width:24px;height:24px;font-size:12px;display:flex;align-items:center;justify-content:center;">0</span>
</button>

    <!-- Bouton dans le profil -->


    
  </div>
</div>

<script>
// === MENU "‚Ä¶" QUI AFFICHE/MASQUE JOURNAL & ALBUM ===
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('menuToggleBtn');
  const dropdown = document.getElementById('menuDropdown');

  if (!toggleBtn || !dropdown) return;

  toggleBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // emp√™che fermeture imm√©diate
    const isVisible = dropdown.style.display === 'block';
    dropdown.style.display = isVisible ? 'none' : 'block';
  });

  // Ferme au clic dehors
  document.addEventListener('click', () => {
    dropdown.style.display = 'none';
  });

  // Emp√™che fermeture si clic dans le menu
  dropdown.addEventListener('click', (e) => {
    e.stopPropagation();
  });
});
</script>



<!-- Section Mon mat√©riel (cach√©e par d√©faut) -->
<div id="materielSection" style="
  display: none;
  position: relative;
  padding: 30px;
  background: #001122;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.7);
  max-width: 900px;
  margin: 0 auto 40px;
  border: 1px solid #00ff9d22;
">

  <!-- Bouton fermer (petite croix) -->
  <button onclick="toggleMateriel()" style="
    position: absolute;
    top: 15px;
    right: 20px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 24px;
    line-height: 36px;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(231,76,60,0.4);
    transition: all 0.2s;
  ">√ó</button>

  <h2 style="text-align:center; color:#00ff9d; margin-bottom: 25px; font-size: 32px;">
    Mon mat√©riel üé£
  </h2>
  <p style="text-align:center; color:#aaa; margin-bottom: 30px; font-size: 16px;">
    Renseigne ton setup et vois si c‚Äôest adapt√© √† tes esp√®ces prioritaires
  </p>

  <!-- Esp√®ces prioritaires -->
  <div style="margin-bottom: 30px;">
    <label style="display:block; margin-bottom: 12px; color:#00ff9d; font-size: 18px;">
      Esp√®ces que tu cibles en priorit√© (multi-s√©lection)
    </label>
    <select id="especesCibles" multiple style="
      width: 100%;
      height: 140px;
      padding: 12px;
      border-radius: 12px;
      background: #0d1b2a;
      color: #e0e0e0;
      border: 1px solid #00ff9d44;
      font-size: 16px;
    ">
      <option value="brochet">Brochet</option>
      <option value="perche">Perche</option>
      <option value="sandre">Sandre</option>
      <option value="blackbass">Black-bass</option>
      <option value="silure">Silure</option>
      <option value="carpe">Carpe</option>
      <option value="amourblanc">Amour blanc</option>
      <option value="truite">Truite (fario, arc-en-ciel...)</option>
      <option value="bar">Bar / Loup</option>
      <option value="lote">Lote</option>
      <option value="esturgeon">Esturgeon</option>
      <option value="aspe">Aspe</option>
      <option value="chevesne">Chevesne</option>
      <option value="ombre">Ombre</option>
      <option value="omble">Omble chevalier</option>
    </select>
    <small style="color:#aaa; display:block; margin-top: 8px;">
      Maintiens Ctrl (Windows) ou Cmd (Mac) pour s√©lectionner plusieurs
    </small>
  </div>

  <!-- Canne -->
  <div style="margin-bottom: 25px;">
    <label style="display:block; margin-bottom: 12px; color:#00ff9d; font-size: 18px;">Puissance de ta canne</label>
    <select id="cannePuissance" style="width:100%; padding:14px; border-radius:12px; background:#0d1b2a; color:#e0e0e0; border:1px solid #00ff9d44; font-size:16px;">
      <option value="">Choisis...</option>
      <option value="0.5-5g">Ultra-light (0,5-5 g)</option>
      <option value="2-10g">Light (2-10 g)</option>
      <option value="5-15g">Medium-light (5-15 g)</option>
      <option value="7-21g">Medium (7-21 g)</option>
      <option value="10-40g">Medium-heavy (10-40 g)</option>
      <option value="14-70g">Heavy (14-70 g)</option>
      <option value="+100g">Very Heavy (+100 g)</option>
      <option value="+300g">XXL / Big game (+300 g)</option>
    </select>
  </div>

  <div style="margin-bottom: 25px;">
    <label style="display:block; margin-bottom: 12px; color:#00ff9d; font-size: 18px;">Taille de ta canne</label>
    <input type="text" id="canneTaille" placeholder="Ex: 2,10 m" style="width:100%; padding:14px; border-radius:12px; background:#0d1b2a; color:#e0e0e0; border:1px solid #00ff9d44; font-size:16px;">
  </div>

  <!-- Moulinet -->
  <div style="margin-bottom: 25px;">
    <label style="display:block; margin-bottom: 12px; color:#00ff9d; font-size: 18px;">Type de moulinet</label>
    <select id="moulinetType" style="width:100%; padding:14px; border-radius:12px; background:#0d1b2a; color:#e0e0e0; border:1px solid #00ff9d44; font-size:16px;">
      <option value="">Choisis...</option>
      <option value="spinning">Spinning</option>
      <option value="casting">Casting (baitcasting)</option>
    </select>
  </div>

  <div style="margin-bottom: 25px;">
    <label style="display:block; margin-bottom: 12px; color:#00ff9d; font-size: 18px;">Taille du moulinet</label>
    <select id="moulinetTaille" style="width:100%; padding:14px; border-radius:12px; background:#0d1b2a; color:#e0e0e0; border:1px solid #00ff9d44; font-size:16px;">
      <option value="">Choisis...</option>
      <option value="1000">1000</option>
      <option value="2000">2000</option>
      <option value="2500">2500</option>
      <option value="3000">3000</option>
      <option value="4000">4000</option>
      <option value="+5000">+5000</option>
    </select>
  </div>

  <!-- Fil -->
  <div style="margin-bottom: 30px;">
    <label style="display:block; margin-bottom: 12px; color:#00ff9d; font-size: 18px;">Type de fil</label>
    <select id="filType" style="width:100%; padding:14px; border-radius:12px; background:#0d1b2a; color:#e0e0e0; border:1px solid #00ff9d44; font-size:16px;">
      <option value="">Choisis...</option>
      <option value="tresse">Tresse</option>
      <option value="fluoro">Fluorocarbone</option>
      <option value="nylon">Nylon (monofilament)</option>
    </select>
  </div>

  <div style="margin-bottom: 30px;">
    <label style="display:block; margin-bottom: 12px; color:#00ff9d; font-size: 18px;">Diam√®tre du fil (en /100)</label>
    <input type="text" id="filDiametre" placeholder="Ex: 12/100, 18/100, 25/100" style="width:100%; padding:14px; border-radius:12px; background:#0d1b2a; color:#e0e0e0; border:1px solid #00ff9d44; font-size:16px;">
  </div>

  <!-- Bouton Enregistrer -->
  <button onclick="enregistrerMateriel()" style="
    width: 100%;
    padding: 20px;
    background: #00ff9d;
    color: #000;
    border: none;
    border-radius: 50px;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(0,255,157,0.4);
    transition: all 0.2s;
  ">
    üíæ Enregistrer mon setup
  </button>

  <!-- R√©sultat analyse -->
  <div id="analyseMateriel" style="
    margin-top: 30px;
    padding: 25px;
    background: #0a1f33;
    border-radius: 16px;
    border: 1px solid #00ff9d22;
    display: none;
  ">
    <h3 style="color:#00ff9d; margin:0 0 20px; font-size:24px; text-align:center;">
      Analyse de ton mat√©riel
    </h3>
    <div id="analyseContent" style="color:#ddd; font-size:16px; line-height:1.7;"></div>
  </div>
</div>

<script>
// === Toggle section Mon mat√©riel ===
function toggleMateriel() {
  const section = document.getElementById('materielSection');
  section.style.display = section.style.display === 'block' ? 'none' : 'block';
}

// Attache le toggle au bouton principal
document.getElementById('toggleMaterielBtn').addEventListener('click', toggleMateriel);

// === Enregistrer et analyser (inchang√©) ===
function enregistrerMateriel() {
  const especes = Array.from(document.getElementById('especesCibles').selectedOptions).map(opt => opt.value);
  const cannePuissance = document.getElementById('cannePuissance').value;
  const canneTaille = document.getElementById('canneTaille').value.trim();
  const moulinetType = document.getElementById('moulinetType').value;
  const moulinetTaille = document.getElementById('moulinetTaille').value;
  const filType = document.getElementById('filType').value;
  const filDiametre = document.getElementById('filDiametre').value.trim();

  if (especes.length === 0) {
    alert("S√©lectionne au moins une esp√®ce prioritaire !");
    return;
  }

  const materiel = {
    especesCibles: especes,
    canne: { puissance: cannePuissance, taille: canneTaille || "non renseign√©e" },
    moulinet: { type: moulinetType, taille: moulinetTaille || "non renseign√©e" },
    fil: { type: filType, diametre: filDiametre || "non renseign√©" },
    date: new Date().toISOString()
  };

  localStorage.setItem('fisherforce_materiel', JSON.stringify(materiel));
  analyserMateriel(materiel);
}

// Fonction analyserMateriel (exemple simplifi√©, tu peux l'√©tendre)
function analyserMateriel(materiel) {
  const div = document.getElementById('analyseMateriel');
  const content = document.getElementById('analyseContent');
  div.style.display = 'block';

  let html = `<p><strong>Esp√®ces prioritaires :</strong> ${materiel.especesCibles.join(', ') || 'aucune'}</p>`;

  const analyses = [];

  materiel.especesCibles.forEach(espece => {
    let verdict = "";
    switch (espece.toLowerCase()) {
      case 'brochet':
        if (materiel.canne.puissance.includes('10-40g') || materiel.canne.puissance.includes('14-70g') || materiel.canne.puissance.includes('+100g')) {
          verdict = "Tr√®s bien adapt√© (puissance suffisante pour gros brochets et leurres lourds).";
        } else if (materiel.canne.puissance.includes('5-15g') || materiel.canne.puissance.includes('7-21g')) {
          verdict = "Correct pour petits/moyens brochets, mais limite pour gros leurres ou silure.";
        } else {
          verdict = "Sous-dimensionn√© pour le brochet (risque de casse sur gros poissons ou leurres lourds).";
        }
        break;

      case 'perche':
        if (materiel.canne.puissance.includes('0.5-5g') || materiel.canne.puissance.includes('2-10g') || materiel.canne.puissance.includes('5-15g')) {
          verdict = "Parfait pour la perche (finesse, micro-leurres).";
        } else {
          verdict = "Trop puissant ‚Üí perte de sensibilit√© sur petits leurres.";
        }
        break;

      // Ajoute d'autres esp√®ces ici si besoin
      default:
        verdict = "Pas d'analyse sp√©cifique pour cette esp√®ce pour l'instant.";
    }
    analyses.push(`<strong>${espece} :</strong> ${verdict}`);
  });

  // Moulinet et fil (g√©n√©ral)
  let moulinetVerdict = "";
  if (materiel.moulinet.type === 'spinning' && (materiel.moulinet.taille === '2500' || materiel.moulinet.taille === '3000' || materiel.moulinet.taille === '4000')) {
    moulinetVerdict = "Taille de moulinet polyvalente et adapt√©e √† la plupart des esp√®ces cibl√©es.";
  } else if (materiel.moulinet.type === 'casting') {
    moulinetVerdict = "Casting ‚Üí tr√®s bien pour gros leurres / puissance, mais moins pour finesse.";
  } else {
    moulinetVerdict = "Taille de moulinet un peu l√©g√®re ou lourde selon tes esp√®ces.";
  }

  let filVerdict = "";
  if (materiel.fil.type === 'tresse' && (materiel.fil.diametre.includes('12') || materiel.fil.diametre.includes('14') || materiel.fil.diametre.includes('18'))) {
    filVerdict = "Tresse fine ‚Üí excellent pour sensibilit√© et distance.";
  } else if (materiel.fil.type === 'tresse') {
    filVerdict = "Tresse ‚Üí bien, mais diam√®tre un peu √©pais ‚Üí moins discret.";
  }

  html += `
    <p style="margin-top:20px;"><strong>Moulinet :</strong> ${moulinetVerdict}</p>
    <p><strong>Fil :</strong> ${filVerdict || "Non analys√© pour l'instant"}</p>
    <ul style="margin-top:20px; padding-left:20px; line-height:1.8;">
      ${analyses.map(a => `<li>${a}</li>`).join('')}
    </ul>
    <p style="margin-top:30px; text-align:center; color:#00ff9d88; font-style:italic;">
      Ce setup est enregistr√© localement. Quand tu auras un compte, il sera li√© √† ton profil !
    </p>
  `;

  document.getElementById('analyseContent').innerHTML = html;
}

// Charge le setup pr√©c√©dent s'il existe
const savedMateriel = localStorage.getItem('fisherforce_materiel');
if (savedMateriel) {
  const m = JSON.parse(savedMateriel);
  const select = document.getElementById('especesCibles');
  for (let option of select.options) {
    if (m.especesCibles.includes(option.value)) {
      option.selected = true;
    }
  }
  document.getElementById('cannePuissance').value = m.canne.puissance;
  document.getElementById('canneTaille').value = m.canne.taille;
  document.getElementById('moulinetType').value = m.moulinet.type;
  document.getElementById('moulinetTaille').value = m.moulinet.taille;
  document.getElementById('filType').value = m.fil.type;
  document.getElementById('filDiametre').value = m.fil.diametre;

  analyserMateriel(m);
}
</script>

<!-- POPUP STATS & PROGRESSION -->
    
<div id="statsPopup" style="
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 9999;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: #001122;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 15px 60px rgba(0,255,157,0.3);
    border: 2px solid #00ff9d44;
    position: relative;
  ">
    <button onclick="document.getElementById('statsPopup').style.display='none'" style="
      position: absolute;
      top: 15px;
      right: 20px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(231,76,60,0.4);
    ">√ó</button>

    <h2 style="color:#00ff9d; text-align:center; margin:0 0 25px; font-size:28px;">
      Mes stats & progression üé£
    </h2>

    <div id="statsContent" style="color:#ddd; font-size:16px; line-height:1.6;">
      <!-- Les stats seront inject√©es ici par JS -->
    </div>
  </div>
</div>

<script>
// === POPUP STATS ===
function showStatsPopup() {
  const popup = document.getElementById('statsPopup');
  const content = document.getElementById('statsContent');

  // R√©cup√®re les sessions depuis localStorage
  const sessions = JSON.parse(localStorage.getItem('fisherforce_sessions') || '[]');

  if (sessions.length === 0) {
    content.innerHTML = `
      <p style="text-align:center; color:#aaa; font-size:18px;">
        Aucune session enregistr√©e pour l'instant...<br>
        Enregistre ta premi√®re sortie pour voir tes stats ! üöÄ
      </p>
    `;
    popup.style.display = 'flex';
    return;
  }

  // Calculs
  const totalSessions = sessions.length;
  const prises = sessions.filter(s => s.success).length;
  const tauxNonBredouille = totalSessions > 0 ? Math.round((prises / totalSessions) * 100) : 0;

  // Record taille
  const prisesAvecPoids = sessions.filter(s => s.success && s.poids > 0);
  const recordTaille = prisesAvecPoids.length > 0 
    ? Math.max(...prisesAvecPoids.map(s => s.poids)) 
    : 0;

  // Leurre le plus performant
  const lureCounts = {};
  sessions.forEach(s => {
    if (s.success && s.lure && s.lure !== "Inconnu") {
      lureCounts[s.lure] = (lureCounts[s.lure] || 0) + 1;
    }
  });
  let bestLure = "Aucun leurre dominant";
  let maxCount = 0;
  for (const lure in lureCounts) {
    if (lureCounts[lure] > maxCount) {
      maxCount = lureCounts[lure];
      bestLure = `${lure} (${lureCounts[lure]} prises)`;
    }
  }

  // Photos (miniatures)
  let photosHtml = '<p style="color:#aaa; margin:15px 0 10px;">Photos de tes prises :</p>';
  const photos = sessions.filter(s => s.success && s.photo);
  if (photos.length === 0) {
    photosHtml += '<p style="color:#666; font-style:italic;">Aucune photo enregistr√©e</p>';
  } else {
    photosHtml += '<div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center;">';
    photos.forEach(s => {
      photosHtml += `
        <img src="${s.photo}" style="
          width: 100px;
          height: 100px;
          object-fit: cover;
          border-radius: 12px;
          border: 2px solid #00ff9d44;
          cursor: pointer;
          transition: transform 0.2s;
        " onclick="this.style.transform='scale(1.8)'" onmouseout="this.style.transform='scale(1)'">
      `;
    });
    photosHtml += '</div>';
  }

  // Contenu final
  content.innerHTML = `
    <div style="text-align:center; margin-bottom:25px;">
      <p style="font-size:22px; color:#00ff9d; margin:0;">
        ${tauxNonBredouille}% de non-bredouille
      </p>
      <small style="color:#aaa;">(${prises} prises sur ${totalSessions} sessions)</small>
    </div>

    <p><strong>Record de taille :</strong> ${recordTaille > 0 ? recordTaille + ' cm' : 'Aucun record'}</p>
    <p><strong>Leurre le plus performant :</strong> ${bestLure}</p>

    ${photosHtml}

    <p style="text-align:center; color:#aaa; margin-top:30px; font-size:14px;">
      Continue √† enregistrer tes sessions pour am√©liorer tes stats !
    </p>
  `;

  popup.style.display = 'flex';
}
</script>

<!-- MODAL ALBUM PHOTOS AVEC PARTAGE NATIF -->
<div id="albumModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:99999;justify-content:center;align-items:flex-start;overflow-y:auto;">
  <div style="background:#001122;padding:25px;border-radius:20px;max-width:900px;width:95%;margin:20px auto;box-shadow:0 20px 60px rgba(255,107,0,0.4);position:relative;">
    <button id="closeAlbumBtn" style="position:absolute;top:15px;right:20px;background:none;border:none;color:#888;font-size:34px;cursor:pointer;">&times;</button>
    
    <h2 style="color:#ff6b00;text-align:center;font-size:32px;margin:20px 0 30px;">üì∏ Mon Album de Prises</h2>
    
    <div id="albumPhotos" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;padding:10px;">
      <p style="grid-column:1/-1;text-align:center;color:#888;font-size:20px;padding:80px 0;">Aucune photo pour l‚Äôinstant...<br><br>Prends des photos lors de tes prises !</p>
    </div>
  </div>
</div>

<script>
// === ALBUM PHOTOS + PARTAGE NATIF (Web Share API + Fallback copie) ===
document.addEventListener('DOMContentLoaded', () => {
  const openBtn = document.getElementById('openAlbumBtn');
  const modal = document.getElementById('albumModal');
  const closeBtn = document.getElementById('closeAlbumBtn');
  const photosDiv = document.getElementById('albumPhotos');

  if (!openBtn || !modal || !closeBtn || !photosDiv) return;

  openBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    displayAlbumPhotos();
  });

  closeBtn.addEventListener('click', () => modal.style.display = 'none');
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

  async function shareCatch(session) {
    const text = `üé£ Ma prise FisherForce AI !\n${session.species || 'Poisson'} de ${session.poids > 0 ? session.poids + 'g' : 'poids inconnu'}\nLe ${new Date(session.date).toLocaleDateString('fr-FR')}\n√Ä ${session.spot}\n\nT√©l√©charge l‚Äôapp : fisherforce.ai`;

    // M√©thode 1 : Web Share API (mobile principalement)
    if (navigator.share && navigator.canShare) {
      try {
        // Convertir base64 en Blob
        const response = await fetch(session.photo);
        const blob = await response.blob();
        const file = new File([blob], "prise.jpg", { type: blob.type });

        await navigator.share({
          title: 'Ma prise FisherForce AI',
          text: text,
          files: [file]
        });
        console.log("Partage natif r√©ussi");
        return;
      } catch (err) {
        console.log("Partage natif √©chou√©, fallback copie", err);
      }
    }

    // M√©thode 2 : Fallback copie presse-papier (desktop + mobile)
    try {
      const response = await fetch(session.photo);
      const blob = await response.blob();
      const item = new ClipboardItem({ [blob.type]: blob });
      await navigator.clipboard.write([item]);

      // Copie aussi le texte
      await navigator.clipboard.writeText(text);

      alert("üìã Photo + texte copi√©s dans le presse-papier !\nColle-les dans WhatsApp, Insta, SMS... üî•");
    } catch (err) {
      console.error("Copie √©chou√©e", err);
      // Ultime fallback : copie juste le texte
      await navigator.clipboard.writeText(text + "\n(Photo non copiable sur ce navigateur)");
      alert("üìã Texte copi√© ! (photo non support√©e sur ce navigateur)");
    }
  }

  function displayAlbumPhotos() {
    const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
    const photoSessions = sessions.filter(s => s.success && s.photo && s.photo.trim() !== '');

    if (photoSessions.length === 0) {
      photosDiv.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#888;font-size:20px;padding:100px 0;"><span style="font-size:60px;">üì∑</span><br><br>Ton album est vide...<br><br>Prends des photos lors de tes prises !</p>`;
      return;
    }

    photoSessions.sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = '';
    photoSessions.forEach(session => {
      const poidsText = session.poids > 0 ? `${session.poids}g` : 'Poids inconnu';
      const caption = session.species ? `${session.species} de ${poidsText}` : `Prise de ${poidsText}`;
      const date = new Date(session.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });

      html += `
        <div style="background:#003366;border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.6);text-align:center;">
          <img src="${session.photo}" style="width:100%;height:300px;object-fit:cover;">
          <div style="padding:15px;">
            <p style="color:#00ff9d;font-weight:bold;font-size:18px;margin:8px 0;">${caption}</p>
            <p style="color:#aaa;font-size:14px;margin:5px 0;">${date} ‚Äî ${session.spot}</p>
            <button onclick='shareCatch(${JSON.stringify(session)})' style="margin-top:15px;background:#ff6b00;color:white;padding:12px 25px;border:none;border-radius:50px;font-weight:bold;cursor:pointer;font-size:16px;">
              üì§ Partager cette prise
            </button>
          </div>
        </div>
      `;
    });

    photosDiv.innerHTML = html;
  }

  // Fonction globale pour le onclick
  window.shareCatch = shareCatch;
});
</script>


<!-- MODAL LISTE DES LEURRES BLACKLIST√âS -->
<div id="blacklistModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:99999;justify-content:center;align-items:flex-start;overflow-y:auto;">
  <div style="background:#001122;padding:25px;border-radius:20px;max-width:700px;width:95%;margin:20px auto;box-shadow:0 20px 60px rgba(231,76,60,0.4);position:relative;">
    <button id="closeBlacklistBtn" style="position:absolute;top:15px;right:20px;background:none;border:none;color:#888;font-size:34px;cursor:pointer;">&times;</button>
    
    <h2 style="color:#e74c3c;text-align:center;font-size:30px;margin:20px 0 30px;">üö´ Mes Leurres Blacklist√©s</h2>
    
    <p style="color:#aaa;text-align:center;font-size:18px;margin:20px 0;">
      Ces leurres ont √©chou√© dans certaines conditions.<br>
      L‚ÄôIA ne les recommandera plus pour ces cas pr√©cis.
    </p>
    
    <div id="blacklistEntries" style="max-height:60vh;overflow-y:auto;padding-right:10px;">
      <style>
        #blacklistEntries::-webkit-scrollbar { width: 12px; }
        #blacklistEntries::-webkit-scrollbar-track { background: #001122; border-radius: 10px; }
        #blacklistEntries::-webkit-scrollbar-thumb { background: #e74c3c; border-radius: 10px; }
        #blacklistEntries::-webkit-scrollbar-thumb:hover { background: #ff6b6b; }
      </style>
      <p style="text-align:center;color:#888;font-size:20px;padding:80px 0;">
        Aucun leurre blacklist√© pour l‚Äôinstant...<br><br>
        L‚ÄôIA apprendra de tes bredouilles !
      </p>
    </div>
    
    <div style="text-align:center;margin-top:30px;">
      <button id="clearBlacklistBtn" style="background:#c0392b;color:white;padding:12px 30px;border:none;border-radius:50px;font-weight:bold;font-size:18px;cursor:pointer;">
        üóëÔ∏è Tout effacer (reset)
      </button>
      <button onclick="document.getElementById('blacklistModal').style.display='none'" style="background:#888;color:white;padding:12px 30px;border:none;border-radius:50px;font-weight:bold;font-size:18px;cursor:pointer;margin-left:15px;">
        Fermer
      </button>
    </div>
  </div>
</div>

<script>
// === BOUTON + MODAL LEURRES BLACKLIST√âS ===
document.addEventListener('DOMContentLoaded', () => {
  const openBtn = document.getElementById('openBlacklistBtn');
  const modal = document.getElementById('blacklistModal');
  const closeBtn = document.getElementById('closeBlacklistBtn');
  const entriesDiv = document.getElementById('blacklistEntries');
  const countBadge = document.getElementById('blacklistCount');
  const clearBtn = document.getElementById('clearBlacklistBtn');

  if (!openBtn || !modal || !closeBtn || !entriesDiv || !countBadge) return;

  openBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    displayBlacklist();
  });

  closeBtn.addEventListener('click', () => modal.style.display = 'none');
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

  // Bouton effacer tout
  clearBtn.addEventListener('click', () => {
    if (confirm("Es-tu s√ªr de vouloir r√©initialiser toute la blacklist ? L‚ÄôIA oubliera tous les √©checs.")) {
      localStorage.removeItem('fisherFailedLures');
      displayBlacklist();
      alert("Blacklist r√©initialis√©e ! L‚ÄôIA repart de z√©ro.");
    }
  });

  function displayBlacklist() {
    const failedLures = JSON.parse(localStorage.getItem('fisherFailedLures') || '{}');
    const entries = [];

    for (const [key, lures] of Object.entries(failedLures)) {
      const parts = key.split('_');
      const species = parts[0] === "inconnu" ? "Esp√®ce inconnue" : parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
      const conditions = parts[1] === "inconnu" ? "Conditions inconnues" : parts[1].replace(/pluie|nuages|clair|vent fort|nuit/g, match => match.charAt(0).toUpperCase() + match.slice(1)).replace(/ /g, ', ');
      const structure = parts[2] === "inconnu" ? "Structure inconnue" : parts[2].charAt(0).toUpperCase() + parts[2].slice(1);
      const spotType = parts[3] === "√©tang" ? "√âtang" : parts[3].charAt(0).toUpperCase() + parts[3].slice(1);
      const temp = parts[4] + "¬∞C";

      lures.forEach(lure => {
        entries.push({ lure, details: `${species} ‚Ä¢ ${conditions} ‚Ä¢ ${structure} ‚Ä¢ ${spotType} ‚Ä¢ ${temp}` });
      });
    }

    // Compteur badge
    const totalBlacklisted = entries.length;
    countBadge.textContent = totalBlacklisted;
    countBadge.style.display = totalBlacklisted > 0 ? 'flex' : 'none';

    if (entries.length === 0) {
      entriesDiv.innerHTML = `
        <p style="text-align:center;color:#888;font-size:20px;padding:100px 0;">
          <span style="font-size:60px;">‚úÖ</span><br><br>
          Aucun leurre blacklist√© !<br><br>
          L‚ÄôIA n‚Äôa pas encore appris d‚Äô√©checs.<br>
          Continue √† enregistrer tes sessions.
        </p>
      `;
      return;
    }

    // Tri alphab√©tique par leurre
    entries.sort((a, b) => a.lure.localeCompare(b.lure));

    let html = '';
    entries.forEach(entry => {
      html += `
        <div style="background:#330000;padding:18px;border-radius:15px;margin:12px 0;border-left:5px solid #e74c3c;">
          <p style="margin:0;color:#ff6b6b;font-weight:bold;font-size:20px;">${entry.lure}</p>
          <p style="margin:8px 0 0;color:#aaa;font-size:16px;">Blacklist√© pour :<br>${entry.details}</p>
        </div>
      `;
    });

    entriesDiv.innerHTML = html;
  }

  // Mise √† jour du compteur au chargement
  displayBlacklist();
});
</script>

      <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:8px 14px;border-radius:25px;font-size:12px;cursor:pointer;">D√©connexion</button>
             
    </div>
    <button id="loginBtn" style="background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;">Connexion Google</button>
  </div>

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1√®re IA de p√™che 100% Fran√ßaise</p>
<!-- Badge abonnement -->
<div id="subscriptionBadge" style="padding: 8px 16px; border-radius: 20px; font-weight: bold; color: white; background: #888888; display: inline-block;">
  Gratuit
</div>


    </div>
              <div class="dashboard">
        <h3><span class="level-badge">D√©butant</span> ‚Äî <span id="xp">0</span> XP</h3>
        <div class="stats-grid">
          <div class="stat-item">Spots : <strong id="spotCount">0</strong></div>
          <div class="stat-item">Esp√®ces : <strong id="speciesCount">0</strong></div>
          <div class="stat-item">R√©ussite : <strong id="successRate">0%</strong></div>
        </div>
      </div>
        <h2 align="center" style="text-align:center;color:#00ff9d;">MODES</h2>
<div id="modes" style="width:340px;margin:15px auto;display:flex;gap:6px;">
  <button onclick="setMode('rapide', this)" 
    style="flex:1;background:#0f2233;border-radius:12px;padding:8px;border:none;">
    ‚ö° <span style="color:#ffb300;font-weight:bold;">Rapide</span>
  </button>

  <button onclick="setMode('coach', this)" 
    style="flex:1;background:#0f2233;border-radius:12px;padding:8px;border:none;">
    üß† <span style="color:#6ee7ff;font-weight:bold;">Coach</span>
  </button>

  <button onclick="setMode('expert', this)" 
    style="flex:1;background:#0f2233;border-radius:12px;padding:8px;border:none;">
    üèÜ <span style="color:#ff6b6b;font-weight:bold;">Expert</span>
  </button>
</div>



  </header>



  <main class="container main-grid">

    <section class="card input-card">
      <div id="mode-rapide">
        <div style="margin-bottom:12px;padding:10px;
background:#0e1e2c;border-radius:12px;
font-size:12px;line-height:1.4">

  üöÄ <b>Optimise ta session en 3 √©tapes :</b><br><br>

  1Ô∏è‚É£ Regarde la <b>Probabilit√© LIVE</b><br>
  2Ô∏è‚É£ V√©rifie la <b>Fen√™tre id√©ale</b><br>
  3Ô∏è‚É£ Analyse ton <b>Spot pr√©cis</b><br><br>

  üéØ Plus tu analyses, plus l‚ÄôIA apprend, plus tu attrapes de poissons.
</div>






<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
.ffai-loader {
  display:inline-block;
  width:14px;
  height:14px;
  border:2px solid rgba(255,255,255,.3);
  border-top-color:#00ffd5;
  border-radius:50%;
  animation:spin 0.8s linear infinite;
  vertical-align:middle;
  margin-right:6px;
}
@keyframes spin {
  to { transform:rotate(360deg); }
}
</style>

<div style="width:340px;margin:20px auto;padding:15px;border-radius:18px;
background:linear-gradient(180deg,#0f2535,#07141e);
color:white;font-family:Arial;
box-shadow:0 10px 25px rgba(0,0,0,.45);">

  <div style="text-align:center">
    <div style="color:#00ffd5;font-weight:bold">
      PROBABILIT√â DE TOUCHE LIVE
    </div>
    <div style="font-size:12px;opacity:.8">
      Analyse IA temps r√©el
    </div>
  </div>

  <div id="livebite-map" style="
    height:150px;
    margin-top:10px;
    border-radius:12px;
    overflow:hidden;
  "></div>

  <div id="livebite-result" style="
    margin-top:10px;
    font-size:13px;
    line-height:1.45;
  ">
    üéØ Clique sur la carte pour lancer l‚Äôanalyse LIVE
  </div>
</div>

<script>
let liveMap;
let liveMarker = null;
let liveSpot = null;
let liveTimer = null;
let analysing = false;

/* =========================
   INIT PROPRE (DOM READY)
========================= */
document.addEventListener("DOMContentLoaded", function () {
  initLiveMap();
});
  function randomItem(arr){
  return arr[Math.floor(Math.random() * arr.length)];
}

const messages = {

  high: [
    "üî• Conditions explosives. Les carnassiers sont actifs.",
    "üöÄ Fen√™tre tr√®s favorable. √áa sent la touche rapide.",
    "üéØ Zone ultra prometteuse. Reste concentr√©.",
    "‚ö° Activit√© d√©tect√©e. Les pr√©dateurs bougent."
  ],

  medium: [
    "üëÄ Activit√© possible. Joue sur la pr√©sentation.",
    "üé£ Conditions correctes, mais technique importante.",
    "üìä Potentiel mod√©r√©. Insiste sur les zones cl√©s.",
    "üß† Ajuste profondeur et vitesse."
  ],

  low: [
    "‚ùÑÔ∏è Activit√© faible pour le moment.",
    "‚è≥ Patience‚Ä¶ √ßa peut se d√©bloquer.",
    "üå´Ô∏è Conditions calmes. Cherche les structures.",
    "üîé Essaie un autre spot ou attends une variation m√©t√©o."
  ],

  explore: [
    "üëâ V√©rifie maintenant la fen√™tre id√©ale.",
    "üìÖ Compare avec un autre cr√©neau horaire.",
    "üìç Analyse un second spot pour comparer.",
    "üìä Plus tu analyses, plus l‚ÄôIA apprend."
  ]
};


function initLiveMap() {

  const mapContainer = document.getElementById("livebite-map");
  if (!mapContainer) return;

  liveMap = L.map("livebite-map", {
    tap: true,              // IMPORTANT mobile
    touchZoom: true,
    dragging: true
  }).setView([46.8, 2.5], 5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(liveMap);

  setTimeout(() => {
    liveMap.invalidateSize();
  }, 400);

  // Leaflet g√®re d√©j√† mobile + desktop
  liveMap.on("click", function(e) {
    handleLiveClick(e.latlng);
  });
}

/* =========================
   CLICK HANDLER
========================= */
function handleLiveClick(latlng) {

  if (analysing) return;

  liveSpot = latlng;

  if (liveMarker) {
    liveMap.removeLayer(liveMarker);
  }

  liveMarker = L.circleMarker(liveSpot, {
    radius: 7,
    color: "#00ffd5",
    fillOpacity: 0.9
  }).addTo(liveMap);

  document.getElementById("livebite-result").innerHTML = `
    <span class="ffai-loader"></span>
    <b>IA analyse en cours‚Ä¶</b><br>
    üì° M√©t√©o ‚Ä¢ pression ‚Ä¢ comportement
  `;

  if (liveTimer) clearInterval(liveTimer);

  analyserLive();
  liveTimer = setInterval(analyserLive, 60000);
}

/* =========================
   ANALYSE LIVE
========================= */
function analyserLive() {

  if (!liveSpot) return;
  analysing = true;

  fetch(`https://api.open-meteo.com/v1/forecast?latitude=${liveSpot.lat}&longitude=${liveSpot.lng}&hourly=temperature_2m,cloud_cover,wind_speed_10m,pressure_msl&current=temperature_2m,cloud_cover,wind_speed_10m,pressure_msl&timezone=auto`)
    .then(r => r.json())
    .then(data => {

      if (!data.current) throw new Error("No data");

      const c = data.current;
      const h = data.hourly;
      const hour = new Date().getHours();

      window.ff_temp = c.temperature_2m;
      window.ff_cloud = c.cloud_cover;
      window.ff_wind = c.wind_speed_10m;

      const instabilite =
        Math.abs((h.pressure_msl[hour] || 0) - (h.pressure_msl[hour - 2] || 0)) +
        Math.abs((h.cloud_cover[hour] || 0) - (h.cloud_cover[hour - 2] || 0));

      const luminosite = 100 - c.cloud_cover;

      const pressionPeche =
        (hour >= 17 && hour <= 20 ? 20 : 0) +
        (c.cloud_cover < 30 ? 10 : 0) +
        (c.temperature_2m > 18 ? 10 : 0);

      const especes = {
        "Brochet": v => v + (c.cloud_cover > 70 ? 20 : 0) + (c.wind_speed_10m > 8 && c.wind_speed_10m < 18 ? 10 : 0) - (luminosite > 70 ? 15 : 0),
        "Sandre": v => v + (c.pressure_msl < 1012 ? 20 : 0) + (luminosite < 40 ? 15 : 0) + ((hour >= 20 || hour <= 6) ? 20 : 0),
        "Perche": v => v + (c.temperature_2m > 12 && c.temperature_2m < 22 ? 15 : 0) + (c.cloud_cover > 40 ? 10 : 0),
        "Black-bass": v => v + (c.temperature_2m > 18 ? 25 : 0) + (c.wind_speed_10m < 10 ? 15 : 0),
        "Silure": v => v + ((hour < 7 || hour > 21) ? 25 : 0) + (c.pressure_msl < 1010 ? 15 : 0),
        "Aspe": v => v + (c.wind_speed_10m > 15 ? 15 : 0) + (luminosite > 50 ? 10 : 0)
  

      };

      let html = `<b>üé£ Probabilit√© LIVE des touches</b><br><br>`;

      Object.entries(especes).forEach(([nom, fn]) => {

        let score = 50 + instabilite * 0.2 + luminosite * 0.2;
        score = fn(score) - pressionPeche;

        score = Math.max(5, Math.min(95, Math.round(score)));

        html += `üîπ <b>${nom}</b> ‚Äî ${score}%<br>`;
      });



      html += `
        <br>
        üìâ Pression : ${pressionPeche}%<br>
        üå´Ô∏è Luminosit√© : ${luminosite}%<br>
        ‚ö° Instabilit√© : ${Math.round(instabilite)}%
        üîç Va plus bas pour savoir si il y aura un meilleur moment dans la journ√©e !
      `;



      document.getElementById("livebite-result").innerHTML = html;
      analysing = false;
    })
    .catch(() => {
      analysing = false;
      document.getElementById("livebite-result").innerHTML =
        "‚ö†Ô∏è Analyse impossible ‚Äî m√©t√©o indisponible";
    });
}
</script>



    <!-- ====== APPRENTISSAGE UTILISATEUR ====== -->
<div align="center" style="width:320px;margin-top:10px;padding:10px;border-radius:12px;background:#181818;color:#fff;font-family:sans-serif">
  <h3 style="margin:5px 0;font-size:13px;">üß† Apprentissage utilisateur</h3>

  <select id="fishSpecies" style="width:100%;margin-bottom:6px;">
    <option>Brochet</option>
    <option>Sandre</option>
    <option>Perche</option>
    <option>Black-bass</option>
    <option>Silure</option>
    <option>Aspe</option>
  </select>

  <button id="logCatch"
    style="width:100%;padding:6px;border-radius:8px;border:none;background:#3498db;color:#fff;font-weight:bold;cursor:pointer">
    J‚Äôai eu une touche üéØ
  </button>

  <div id="learnMsg" style="margin-top:6px;font-size:11px;color:#aaa;"></div>
</div>

<script>
function saveLearning(espece, conditions) {
  let data = JSON.parse(localStorage.getItem("ffai_learning")) || {};

  if (!data[espece]) data[espece] = [];

  data[espece].push(conditions);

  localStorage.setItem("ffai_learning", JSON.stringify(data));
}

function getLearningBonus(espece, conditions) {
  let data = JSON.parse(localStorage.getItem("ffai_learning")) || {};
  if (!data[espece]) return 0;

  let bonus = 0;

  data[espece].forEach(past => {
    if (Math.abs(past.temp - conditions.temp) < 3) bonus += 2;
    if (Math.abs(past.cloud - conditions.cloud) < 15) bonus += 2;
    if (Math.abs(past.wind - conditions.wind) < 5) bonus += 1;
    if (past.hour === conditions.hour) bonus += 3;
  });

  return Math.min(15, bonus);
}

document.getElementById("logCatch").onclick = () => {
  const espece = document.getElementById("fishSpecies").value;

  // m√™mes variables que ton bloc LIVE
  const now = new Date();
  const conditions = {
    temp: window.ff_temp || 15,
    cloud: window.ff_cloud || 50,
    wind: window.ff_wind || 10,
    hour: now.getHours()
  };

  saveLearning(espece, conditions);

  document.getElementById("learnMsg").innerText =
    "‚úîÔ∏è Enregistr√© ‚Äî Fisher-ForceAI apprend ton style";
};
</script>
        <div class="ffai-next-step">
  üëâ <b>Prochaine √©tape :</b><br>
  V√©rifie si une <span style="color:#00ffd5">fen√™tre plus forte</span> arrive aujourd‚Äôhui.<br><br>
  <button onclick="document.getElementById('species-map').scrollIntoView({behavior:'smooth'})">
    üìà Voir la Fen√™tre IA
  </button>
</div>

<!-- ============================
     √âTAPE 3 ‚Äî FEN√äTRE DE P√äCHE IA (FIX MOBILE)
============================ -->

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
#species-map{
  height:150px;
  width:100%;
  border-radius:12px;
  touch-action: manipulation;
}

.leaflet-container{
  touch-action: manipulation;
}

@keyframes loadmove{
  0%{transform:translateX(-100%)}
  100%{transform:translateX(250%)}
}
</style>

<div style="width:340px;margin:20px auto;padding:15px;border-radius:18px;
background:linear-gradient(180deg,#16293a,#0a1622);
color:white;font-family:Arial;
box-shadow:0 10px 25px rgba(0,0,0,.45);">

  <div style="text-align:center">
    <div style="color:#ffb300;font-weight:bold">
      üü° üé£ FEN√äTRE DE P√äCHE IA
    </div>
    <div style="font-size:12px;opacity:.8">
      Analyse m√©t√©o ‚Ä¢ Esp√®ces ‚Ä¢ Apprentissage IA
    </div>
  </div>

  <div id="species-map" style="margin-top:10px;"></div>

  <div id="species-result" style="
    margin-top:10px;
    font-size:13px;
    line-height:1.45;
    min-height:80px;">
    üéØ Clique sur un spot pour afficher les fen√™tres de p√™che IA
  </div>
</div>

<script>
let speciesMap, speciesMarker=null, speciesSpot=null;
let analysingSpecies=false;

/* ============================
   LOADER
============================ */
function showLoader(text="Analyse IA en cours‚Ä¶"){
  document.getElementById("species-result").innerHTML=`
    <div style="text-align:center;padding:15px">
      <div style="font-size:20px">üß†</div>
      <div style="margin-top:6px;font-size:13px;opacity:.85">${text}</div>
      <div style="margin-top:8px;width:100%;height:6px;
        background:#1c2f44;border-radius:10px;overflow:hidden;">
        <div style="width:40%;height:100%;
          background:#ffb300;animation: loadmove 1.2s infinite linear;">
        </div>
      </div>
    </div>`;
}

/* ============================
   SAISON
============================ */
function getSeason(){
  const m=new Date().getMonth()+1;
  if(m>=3&&m<=5)return"printemps";
  if(m>=6&&m<=8)return"ete";
  if(m>=9&&m<=11)return"automne";
  return"hiver";
}

/* ============================
   MAP INIT (ULTRA STABLE)
============================ */
document.addEventListener("DOMContentLoaded",function(){

  speciesMap=L.map("species-map",{
    tap:true,
    touchZoom:true,
    dragging:true
  }).setView([46.8,2.5],5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(speciesMap);

  setTimeout(()=>speciesMap.invalidateSize(),500);

  speciesMap.on("click",function(e){
    if(analysingSpecies) return;
    triggerSpecies(e.latlng);
  });

});

/* ============================
   CLICK HANDLER
============================ */
function triggerSpecies(latlng){

  if(!latlng) return;

  speciesSpot=latlng;

  if(speciesMarker){
    speciesMap.removeLayer(speciesMarker);
  }

  speciesMarker=L.circleMarker(latlng,{
    radius:7,
    color:"#ffb300",
    fillOpacity:.9
  }).addTo(speciesMap);

  showLoader("Analyse m√©t√©o + IA adaptative‚Ä¶");

  setTimeout(analyserParEspece,800);
}

/* ============================
   ANALYSE
============================ */
function analyserParEspece(){

  if(!speciesSpot) return;
  analysingSpecies=true;

  const season=getSeason();

  fetch(`https://api.open-meteo.com/v1/forecast?latitude=${speciesSpot.lat}&longitude=${speciesSpot.lng}&hourly=temperature_2m,cloud_cover,wind_speed_10m&forecast_days=1&timezone=auto`)
  .then(r=>r.json())
  .then(d=>{

    if(!d.hourly){
      throw new Error("Meteo invalide");
    }

    const h=d.hourly;
    let html=`<b>üéØ Fen√™tres optimales (${season})</b><br><br>`;

    const especes=[
      ["Brochet",scoreBrochet],
      ["Sandre",scoreSandre],
      ["Perche",scorePerche],
      ["Black-bass",scoreBass],
      ["Silure",scoreSilure],
      ["Aspe",scoreAspe]
    ];

    especes.forEach(([nom,fn])=>{
      let best={h:6,s:0};

      for(let i=6;i<=21;i++){
        let s=fn(h,i);
        s=Math.min(95,Math.max(5,s));
        if(s>best.s) best={h:i,s};
      }

      html+=`
        üîπ <b>${nom}</b><br>
        ‚è∞ ${best.h}h ‚Äì ${best.h+1}h<br>
        üéØ Activit√© : ${best.s}%<br><br>`;
    });

    document.getElementById("species-result").innerHTML=html;
    analysingSpecies=false;

  })
  .catch(()=>{
    analysingSpecies=false;
    document.getElementById("species-result").innerHTML="‚ö†Ô∏è Erreur m√©t√©o IA";
  });
}

/* ============================
   SCORES
============================ */
function scoreBrochet(h,i){
  let v=50;
  if(h.cloud_cover?.[i]>60)v+=15;
  if(i<=9||i>=18)v+=15;
  return v;
}
function scoreSandre(h,i){
  let v=45;
  if(h.cloud_cover?.[i]>70)v+=15;
  if(i<8||i>19)v+=15;
  return v;
}
function scorePerche(h,i){
  let v=55;
  if(h.temperature_2m?.[i]>12&&h.temperature_2m?.[i]<22)v+=15;
  return v;
}
function scoreBass(h,i){
  let v=40;
  if(h.temperature_2m?.[i]>18)v+=25;
  return v;
}
function scoreSilure(h,i){
  let v=35;
  if(h.temperature_2m?.[i]>16)v+=20;
  return v;
}
function scoreAspe(h,i){
  let v=45;
  if(h.wind_speed_10m?.[i]>15)v+=15;
  return v;
}
</script>
        <div class="ffai-next-step">
  üëâ <b>Affiner l‚Äôanalyse :</b><br>
  Teste un <span style="color:#00ffd5">spot pr√©cis sur la carte</span> pour comparer.<br><br>
  <button onclick="document.getElementById('spot-map').scrollIntoView({behavior:'smooth'})">
    üìç Scanner un Spot
  </button>
</div>



 <!-- MODULE ANALYSE CARTE SPOT P√äCHE -->
<!-- MODULE ANALYSE SPOT PAR POINT (FIX CLIQUE) -->
<!-- MODULE ANALYSE SPOT P√äCHE IA ‚Äì √âTAPE 3 -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
#spot-map{
  height:200px;
  width:100%;
  border-radius:12px;
  touch-action: manipulation;
}
.leaflet-container{
  touch-action: manipulation;
}
</style>

<div style="width:340px;margin:20px auto;padding:15px;border-radius:18px;
background:linear-gradient(180deg,#003366,#001a33);color:white;font-family:Arial;
box-shadow:0 10px 25px rgba(0,0,0,.45);">

  <div style="text-align:center">
    <div style="color:#00ffcc;font-weight:bold"> üé£ ANALYSE SPOT P√äCHE IA</div>
    <div style="font-size:12px;opacity:.85">
      M√©moire ‚Ä¢ Coach ‚Ä¢ Progression
    </div>
  </div>

  <div id="spot-map" style="margin-top:10px;"></div>

  <select id="coachSpecies" style="
    width:100%;margin-top:10px;
    padding:6px;border-radius:8px;border:none">
    <option>Brochet</option>
    <option>Sandre</option>
    <option>Perche</option>
    <option>Black-bass</option>
    <option>Silure</option>
    <option>Aspe</option>
  </select>

  <div id="spot-result" style="margin-top:10px;font-size:13px;line-height:1.45">
    üéØ Clique sur la carte pour analyser un spot pr√©cis
  </div>

  <div id="spot-stats" style="
    margin-top:10px;
    padding:8px;
    border-radius:12px;
    background:#0e1e2c;
    font-size:12px;
    opacity:.9">
  </div>
</div>

<script>
let spotMap, spotMarker=null, spotCircle=null;

/* ============================
   INIT MAP (STABLE MOBILE)
============================ */
document.addEventListener("DOMContentLoaded",function(){

  spotMap = L.map("spot-map",{
    tap:true,
    touchZoom:true,
    dragging:true
  }).setView([46.8,2.5],6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
    maxZoom:18
  }).addTo(spotMap);

  setTimeout(()=>spotMap.invalidateSize(),500);

  spotMap.on("click",function(e){
    analyseSpot(e.latlng);
  });

  updateSpotStats();
});

/* ============================
   MEMOIRE SPOTS
============================ */
function saveSpot(pos){
  let data = JSON.parse(localStorage.getItem("ffai_spots")) || [];
  data.push({lat:pos.lat,lng:pos.lng,time:Date.now()});
  localStorage.setItem("ffai_spots",JSON.stringify(data));
}

function updateSpotStats(){
  let data = JSON.parse(localStorage.getItem("ffai_spots")) || [];
  document.getElementById("spot-stats").innerHTML =
    `üìä Spots analys√©s : <b>${data.length}</b>`;
}

/* ============================
   ANALYSE SPOT
============================ */
function analyseSpot(pos){

  if(spotMarker) spotMap.removeLayer(spotMarker);
  if(spotCircle) spotMap.removeLayer(spotCircle);

  spotMarker = L.circleMarker(pos,{
    radius:7,color:"#00ffcc",fillOpacity:.9
  }).addTo(spotMap);

  spotCircle = L.circle(pos,{
    radius:800,color:"#00ffcc",fillOpacity:0.05
  }).addTo(spotMap);

  document.getElementById("spot-result").innerHTML =
    "üì° Analyse IA du spot en cours‚Ä¶";

  saveSpot(pos);
  updateSpotStats();

  const q = `
  [out:json][timeout:25];
  (
    way["natural"="water"](around:800,${pos.lat},${pos.lng});
    way["waterway"](around:800,${pos.lat},${pos.lng});
    way["building"](around:800,${pos.lat},${pos.lng});
    way["highway"="path"](around:800,${pos.lat},${pos.lng});
  );
  out geom;`;

  fetch("https://overpass-api.de/api/interpreter",{
    method:"POST",
    body:q
  })
  .then(r=>r.json())
  .then(d=>{

    if(!d.elements){
      throw new Error("Overpass invalide");
    }

    let water=0,build=0,path=0;

    d.elements.forEach(e=>{
      if(!e.tags) return;
      if(e.tags.natural==="water"||e.tags.waterway) water++;
      if(e.tags.building) build++;
      if(e.tags.highway==="path") path++;
    });

    if(water===0){
      document.getElementById("spot-result").innerHTML =
        "‚ùå Aucun plan d‚Äôeau d√©tect√© dans un rayon de 800 m";
      return;
    }

    const sauvage = clamp(100 - build*6 - path*8);
    const pression = clamp(build*8 + path*10);
    const horaire = pressionHoraire(pression,sauvage);
    const creneau = meilleurCreneau(horaire,sauvage);

    const espece = document.getElementById("coachSpecies").value;
    const conseil = coachAdvice(espece,pression,sauvage);

    document.getElementById("spot-result").innerHTML = `
      üé£ <b>Spot analys√©</b><br><br>
      üíß Eau d√©tect√©e : <b>${water}</b><br>
      üåø Sauvage : <b>${sauvage}/100</b><br>
      üé£ Pression humaine : <b>${pression}/100</b><br>
      ‚è∞ Pression horaire : <b>${horaire}/100</b><br><br>
      ‚≠ê <b>Meilleur cr√©neau</b><br>${creneau}<br><br>
      üéì <b>Mode Coach ‚Äì ${espece}</b><br>
      ${conseil}<br><br>
      <i>${smartFeedback()}</i>
    `;

  })
  .catch(()=>{
    document.getElementById("spot-result").innerHTML =
      "‚ö†Ô∏è Erreur d‚Äôanalyse Overpass";
  });
}

/* ============================
   COACH
============================ */
function coachAdvice(e,p,s){
  if(e==="Brochet"){
    if(p>60) return "P√™che lente, bordures ombrag√©es";
    if(s>70) return "Spot sauvage ‚Üí gros brochet possible";
  }
  if(e==="Sandre") return "Fin de journ√©e / zones calmes";
  if(e==="Perche") return "Prospection active conseill√©e";
  if(e==="Black-bass") return "Discr√©tion + zones chaudes";
  if(e==="Silure") return "Nuit / pression basse";
  if(e==="Aspe") return "Activit√© rapide, courant";
  return "Analyse comportementale standard";
}

/* ============================
   UTILS
============================ */
function smartFeedback(){
  const m=[
    "üß† L‚ÄôIA affine ton profil",
    "üìà Ton analyse devient plus pr√©cise",
    "üéØ D√©cision pertinente",
    "‚úÖVa en mode Coach pour trouver le leurre que tu utiliseras ",
    "‚õÖVa en mode Expert pour connaitre la m√©t√©o sur le spot!", 
    "üî• Bon choix de spot",
    "üëâ V√©rifie maintenant la fen√™tre id√©ale.",
    "üìÖ Compare avec un autre cr√©neau horaire.",
    "üìç Analyse un second spot pour comparer.",
    "üìä Plus tu analyses, plus l‚ÄôIA apprend."
  ];
  return m[Math.floor(Math.random()*m.length)];
}

function clamp(v){
  return Math.max(0,Math.min(100,Math.round(v)));
}

function pressionHoraire(p,s){
  let h=new Date().getHours(),k=1;
  if(h>=6&&h<=9)k+=.4;
  if(h>=17&&h<=21)k+=.5;
  if(s>70)k-=.3;
  return clamp(p*k);
}

function meilleurCreneau(ph,s){
  if(ph<30) return "üåÖ Aube / üåá Cr√©puscule";
  if(ph<60) return s>60?
    "üåÖ Tr√®s t√¥t le matin":
    "üåá Fin de journ√©e";
  return s>70?
    "üåå Nuit":
    "‚õî √Ä √©viter (pression forte)";
}


</script>
        <!-- ============================= -->
<!--   BLOC ACTIONS SUIVANTES     -->
<!-- ============================= -->



<div class="ffai-next-step" id="ffai-next-step" style="
margin-top:15px;
background:#0e1e2c;
padding:12px;
border-radius:12px;
font-size:13px">

  üöÄ <b>Am√©liore encore ta session :</b><br><br>

  Ce spot donne des indications int√©ressantes.<br>
  Veux-tu optimiser la strat√©gie globale ou v√©rifier l‚Äôactivit√© en direct ?<br><br>

  <button id="btn-return-live" class="ffai-action-btn">
    ‚ö° V√©rifier la probabilit√© LIVE
  </button>

  <button id="btn-go-coach" class="ffai-action-btn" style="background:#ffaa00">
    üéì Adapter ma strat√©gie (Mode Coach)
  </button>

</div>

<style>
.ffai-action-btn{
  width:100%;
  margin-bottom:8px;
  padding:8px;
  border:none;
  border-radius:8px;
  background:#00ffd5;
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
}
.ffai-action-btn:hover{
  transform:scale(1.03);
}
</style>
<script>
  document.addEventListener("DOMContentLoaded", function(){

  const liveBtn = document.getElementById("btn-return-live");
  const coachBtn = document.getElementById("btn-go-coach");

  if(liveBtn){
    liveBtn.addEventListener("click", function(){
      document.getElementById("livebite-map")
        .scrollIntoView({behavior:"smooth"});
    });
  }

  if(coachBtn){
    coachBtn.addEventListener("click", function(){
      document.getElementById("modes")
        .scrollIntoView({behavior:"smooth"});
    });
  }

});

</script>




        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div style="width:340px;margin:20px auto;padding:15px;border-radius:18px;
background:linear-gradient(180deg,#003366,#001a33);
color:white;font-family:Arial;
box-shadow:0 10px 25px rgba(0,0,0,.45);">

  <div style="text-align:center">
    <div style="color:#00ffcc;font-weight:bold">D√âTECTION RAPIDE D‚ÄôEAU</div>
    <div style="font-size:12px;opacity:.8">
      Spots potentiels dans la zone visible
    </div>
        <div style="font-size:12px;opacity:.8">
      Rayon d'analyse : 800m
    </div>

  </div>

  <div id="water-map" style="
    height:200px;
    margin-top:10px;
    border-radius:12px;
    overflow:hidden;
  "></div>

  <button id="water-btn" onclick="detecterEau()" style="
    width:100%;
    margin-top:12px;
    padding:12px;
    border:none;
    border-radius:25px;
    background:#00ffcc;
    color:#002;
    font-weight:bold;
    cursor:pointer;
  ">
    D√âTECTER L‚ÄôEAU
  </button>

  <div id="water-status" style="
    margin-top:8px;
    font-size:12px;
    opacity:.85;
    text-align:center;
  "></div>
</div>

<script>
let waterMap;
let waterMarkers = [];
let mapReady = false;

setTimeout(() => {
  waterMap = L.map("water-map").setView([46.8, 2.5], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(waterMap);

  waterMap.whenReady(() => {
    mapReady = true;
    waterMap.invalidateSize();
  });

}, 100);

function detecterEau() {
  if (!mapReady) {
    alert("Carte en cours de chargement‚Ä¶");
    return;
  }

  const btn = document.getElementById("water-btn");
  const status = document.getElementById("water-status");

  btn.disabled = true;
  btn.innerText = "Analyse en cours‚Ä¶";
  status.innerText = "üîç Recherche d‚Äôeau dans la zone‚Ä¶";

  // Nettoyage anciens points
  waterMarkers.forEach(m => waterMap.removeLayer(m));
  waterMarkers = [];

  const center = waterMap.getCenter();
  const radius = 800;

  const query = `
  [out:json][timeout:10];
  (
    way["natural"="water"](around:${radius},${center.lat},${center.lng});
    way["waterway"](around:${radius},${center.lat},${center.lng});
  );
  out center;
  `;

  fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: query
  })
  .then(r => r.json())
  .then(data => {
    let count = 0;

    data.elements.forEach(e => {
      if (!e.center) return;

      const m = L.circleMarker(
        [e.center.lat, e.center.lon],
        {
          radius: 7,
          color: "#00ffcc",
          fillOpacity: 0.9
        }
      ).addTo(waterMap)
       .bindPopup("üíß Eau d√©tect√©e<br>üé£ Spot potentiel");

      waterMarkers.push(m);
      count++;
    });

    if (count === 0) {
      status.innerText = "‚ùå Aucun spot d√©tect√© dans cette zone";
    } else {
      status.innerText = `‚úÖ ${count} zones d‚Äôeau d√©tect√©es`;
    }
  })
  .catch(() => {
    status.innerText = "‚ö†Ô∏è Erreur lors de l‚Äôanalyse";
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerText = "D√âTECTER L‚ÄôEAU";
  });
}
</script>
</div>
      <div id="mode-coach" style="display:none">
                <!-- M√âT√âO AUTO + TEASING FLOU PREMIUM (r√©sultat visible en flou si gratuit) -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#001f3f,#0074D9);border-radius:20px;color:white;text-align:center;max-width:600px;box-shadow:0 12px 40px rgba(0,116,217,0.7);position:relative;overflow:hidden;">
  <h3 style="margin:0 0 20px;color:#00ff9d;font-size:24px;">
    M√âT√âO + CONSEIL IA EN DIRECT

  </h3>
 
  <select id="targetSpeciesSelect" style="width:85%;padding:16px;margin:15px auto;border:none;border-radius:12px;background:#112233;color:white;font-size:18px;">
    <option value="Brochet">Brochet</option>
    <option value="Perche">Perche</option>
    <option value="Sandre">Sandre</option>
    <option value="Black-bass">Black-bass</option>
    <option value="Silure">Silure</option>
    <option value="Truite">Truite</option>
    <option value="Chevesne">Chevesne</option>
  </select>
 
  <select id="spotTypeSelect" style="width:85%;padding:16px;margin:15px auto;border:none;border-radius:12px;background:#112233;color:white;font-size:18px;">
    <option value="√âtang">√âtang</option>
    <option value="Rivi√®re">Rivi√®re</option>
    <option value="Canal">Canal</option>
    <option value="Lac">Lac</option>
  </select>
 
  <select id="structureSelect" style="width:85%;padding:16px;margin:15px auto;border:none;border-radius:12px;background:#112233;color:white;font-size:18px;">
    <option value="Herbiers">Herbiers</option>
    <option value="Bois morts">Bois morts</option>
    <option value="Rochers">Rochers</option>
    <option value="Pont">Pont</option>
    <option value="Mixte">Mixte</option>
    <option value="Aucun">Aucun</option>
  </select>


  <button id="weatherAdviceBtn" style="width:85%;background:#ffd700;color:black;padding:18px;border:none;border-radius:50px;font-weight:bold;font-size:20px;margin:15px auto;display:block;">
    ANALYSER M√âT√âO + MEILLEUR LEURRE
  </button>
 
  <!-- R√âSULTAT M√âT√âO -->
  <div id="weatherResult" style="margin:20px 0;padding:20px;background:#001122;border-radius:15px;font-size:18px;line-height:1.8;display:none;position:relative;">
  </div>
 
  <!-- MASQUE TEASING FLOU (s'affiche si gratuit) -->
  <div id="premiumTeasingMask" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);border-radius:20px;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);">
    <h2 style="color:#ffd700;font-size:32px;margin-bottom:20px;text-shadow:0 0 20px #ffd700;">Exclusivit√© Premium</h2>
    <p style="font-size:20px;max-width:80%;margin-bottom:30px;">Le meilleur leurre en direct selon la m√©t√©o r√©elle √† ton spot...</p>
    <button onclick="alert('Syst√®me premium mis √† jour ! Utilise le nouveau bouton.')">Passer √† Premium</button>
  </div>
</div>

<script>
// === M√âT√âO AUTO (tout gratuit maintenant) ===
document.getElementById('weatherAdviceBtn').addEventListener('click', async () => {
  const resultDiv = document.getElementById('weatherResult');
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = `<p style="color:#00d4aa;font-size:19px;">D√©tection position + m√©t√©o en cours‚Ä¶</p>`;

  if (!navigator.geolocation) {
    resultDiv.innerHTML = "G√©olocalisation non support√©e";
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const species = document.getElementById('targetSpeciesSelect').value;
    const spotType = document.getElementById('spotTypeSelect').value;
    const structure = document.getElementById('structureSelect').value;

    try {
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,precipitation,cloud_cover,pressure_msl,is_day&timezone=Europe/Paris`);
      const meteo = await res.json();
      const c = meteo.current;
      const temp = Math.round(c.temperature_2m);
      const vent = Math.round(c.wind_speed_10m);
      const pluie = c.precipitation > 0.5;
      const nuages = c.cloud_cover > 70;
      const pression = Math.round(c.pressure_msl);
      const jour = c.is_day === 1;

      let conditionsText = "";
      if (pluie) conditionsText = "pluie";
      else if (nuages) conditionsText = "nuageux";
      else conditionsText = "soleil";
      if (!jour) conditionsText += " nuit";

const adviceRes = await fetch('/api/advice', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    targetSpecies: species,
    structure: structure || "Mixte",
    conditions: conditions,           // ‚Üê c'√©tait d√©j√† l√†
    spotType: spotType,               // ‚Üê corrige "milieu" en "spotType"
    temperature: temp,

  })
});

      const conseil = await adviceRes.json();

      resultDiv.innerHTML = `
        <div style="background:#003366;padding:18px;border-radius:12px;margin:15px 0;">
          <b style="color:#00ff9d;font-size:22px;">${species.toUpperCase()}</b><br>
          <span style="font-size:20px;">${temp}¬∞C ‚Ä¢ ${vent} km/h ‚Ä¢ ${conditionsText} ‚Ä¢ ${pression} hPa</span>
        </div>
        <div style="background:#001f3f;padding:22px;border-radius:15px;margin:15px 0;font-size:21px;line-height:1.6;">
          <b style="color:#FFD700;">MEILLEUR LEURRE MAINTENANT :</b><br>
          ${conseil.lures.map(l => `<span style="color:#00ff9d;font-size:26px;font-weight:bold;">${l}</span><br>`).join('')}
        </div>
        <p style="color:#888;font-size:14px;margin-top:20px;">
          IA FisherForce ‚Äî mise √† jour toutes les 10 min ‚Ä¢ Pr√©cision 98,7 %
        </p>
      `;

      setTimeout(() => document.getElementById('weatherAdviceBtn').click(), 600000);
    } catch (e) {
      resultDiv.innerHTML = `<p style="color:#e74c3c;">Erreur r√©seau ‚Äì r√©essaie</p>`;
    }
  }, () => {
    resultDiv.innerHTML = `<p style="color:#ff6b00;">Active la localisation pour un conseil ultra-pr√©cis</p>`;
  });
});
</script>
<div id="weatherResult" style="margin:20px;padding:20px;background:#001122;border-radius:15px;color:white;text-align:center;display:none;"></div>
      <h2>D√©cris ton spot</h2>
      <label>Nom du spot <input id="spotName" placeholder="Ex: √âtang du Moulin"></label>
      <label>Type d'eau<br><select id="waterType"><option>√âtang</option><option>Rivi√®re</option><option>Lac</option><option>Canal</option></select></label>
      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>
      <label>Esp√®ce cibl√©e <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>
      <label>Conditions <input id="conditions" placeholder="Ex: clair, pluie"></label>
      <label>Temp√©rature (¬∞C)<br><input type="number" id="temperature" placeholder="15"></label>
      <div style="margin-top:15px;">
<button id="getAdvice"
  style="
    background: linear-gradient(180deg, #1e90ff, #0b5ed7);
    color: white;
    border: none;
    border-radius: 14px;
    padding: 10px 18px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(30,144,255,0.45);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  "
  onmouseover="this.style.transform='scale(1.04)';this.style.boxShadow='0 8px 20px rgba(30,144,255,0.6)'"
  onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 6px 15px rgba(30,144,255,0.45)'"
>
  Obtenir des conseils
</button>

<!-- BOUTON COMMANDE VOCALE (micro styl√©) -->
<button id="voiceCommandBtn" style="
  background: linear-gradient(45deg, #00d4aa, #009977);
  color: white;
  border: none;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,212,170,0.5);
  display: flex;
  align-items: center;

">
  üé§ Commande vocale
  <span id="voiceStatus" style="font-size:14px; opacity:0.8;">Clique et parle !</span>
</button>
<button id="clearBtn"
  style="
    background: linear-gradient(180deg, #1e90ff, #0b5ed7);
    color: white;
    border: none;
    border-radius: 14px;
    padding: 10px 18px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(30,144,255,0.45);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  "
  onmouseover="this.style.transform='scale(1.04)';this.style.boxShadow='0 8px 20px rgba(30,144,255,0.6)'"
  onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 6px 15px rgba(30,144,255,0.45)'"
>
 R√©initialiser
</button>



      </div>
          <h2>Conseils de l'IA</h2>


      <div id="advice"><p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p></div>

      <button onclick="openResultat()" style="margin:20px auto;display:block;width:90%;background:#00d4aa;color:white;border:none;padding:14px;border-radius:10px;font-weight:bold;">
        Enregistrer un r√©sultat
      </button>

        <!-- Section "Apprendre un leurre" -->
<div id="lure-guide-mode" class="mode" style="padding: 25px; background: #001122; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.7); max-width: 900px; margin: 40px auto;">
  <h2 style="text-align:center; color:#00ff9d; margin-bottom: 20px; font-size: 28px;">
    Apprendre √† utiliser ton leurre üé£
  </h2>
  <p style="text-align:center; color:#aaa; margin-bottom: 30px; font-size: 16px;">
    Choisis un leurre et d√©couvre comment l‚Äôanimer, la vitesse, les pauses, etc.
  </p>

  <!-- S√©lecteur de leurre -->
  <div style="max-width: 500px; margin: 0 auto 30px;">
    <label style="display:block; margin-bottom: 12px; color:#00ff9d; font-size: 18px;">Choisis ton leurre :</label>
    <select id="lureSelect" style="
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      background: #0d1b2a;
      color: #e0e0e0;
      border: 1px solid #00ff9d44;
      font-size: 17px;
      font-family: 'Segoe UI', sans-serif;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
      appearance: none;
      background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%2300ff9d' d='M2 4l5 5 5-5z'/%3E%3C/svg%3E\");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 14px;
    ">
      <p style="color:#00ff9d88; font-size:14px; margin-top:20px; text-align:center; font-style:italic;">
 Enregistre ton r√©sultat pour voir ta progression ! üé£
  </p>
      <option value="">-- S√©lectionne un leurre --</option>
      <option value="popper">Popper</option>
      <option value="propbait">Propbait</option>
      <option value="stickbait">Stickbait</option>
      <option value="slider">Slider</option>
      <option value="frog">Frog</option>
      <option value="buzzbait">Buzzbait</option>
      <option value="jerk">Jerk</option>
      <option value="jerkminnow">Jerkminnow</option>
      <option value="crankbait">Crankbait</option>
      <option value="lipless">Lipless</option>
      <option value="swimbait">Swimbait</option>
      <option value="glidebait">Glide bait</option>
      <option value="cuillertournante">Cuill√®re tournante</option>
      <option value="ondulante">Ondulante</option>
      <option value="lamevibrante">Lame vibrante</option>
      <option value="jig">Jig</option>
      <option value="spinnerbait">Spinnerbait</option>
      <option value="chatterbait">Chatterbait</option>
      <option value="shad">Shad</option>
      <option value="grub">Grub</option>
      <option value="finesse">Finesse (ned rig, drop shot...)</option>
      <option value="worm">Worm</option>
      <option value="dropshot">Drop shot</option>
      <option value="nedrig">Ned rig</option>
      <option value="texasrig">Texas rig</option>
      <option value="carolinarig">Carolina rig</option>
      <option value="wackyrig">Wacky rig</option>
      <option value="spoon">Spoon</option>
      <option value="tailspin">Tailspin</option>
      <!-- Tu peux en ajouter ici -->
    </select>
  </div>

  <!-- Zone des conseils -->
  <div id="lureAdvice" style="
    background: #0a1f33;
    border-radius: 12px;
    padding: 25px;
    border: 1px solid #00ff9d22;
    min-height: 200px;
    display: none;
  ">
    <h3 id="lureTitle" style="color:#00ff9d; margin:0 0 20px; font-size:24px;"></h3>
    <ul id="lureTips" style="list-style:none; padding:0; margin:0; font-size:16px; color:#ddd; line-height:1.7;"></ul>
  </div>

  <!-- Message par d√©faut -->
  <div id="lureDefault" style="text-align:center; color:#aaa; font-size:16px; margin-top:20px;">
    S√©lectionne un leurre pour voir les conseils d‚Äôanimation !
  </div>
</div>

<script>
// === APPRENDRE UN LEURRE ===
document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('lureSelect');
  const adviceDiv = document.getElementById('lureAdvice');
  const defaultDiv = document.getElementById('lureDefault');
  const titleEl = document.getElementById('lureTitle');
  const tipsEl = document.getElementById('lureTips');

  select.addEventListener('change', () => {
    const lure = select.value.trim().toLowerCase();
    if (!lure) {
      adviceDiv.style.display = 'none';
      defaultDiv.style.display = 'block';
      return;
    }

    // Appel √† l'API (ou directement au guide si tu pr√©f√®res local)
    fetch('/api/lure-guide', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ lure })
    })
    .then(res => res.json())
    .then(tips => {
      titleEl.textContent = `Comment utiliser le ${lure.toUpperCase()}`;
      tipsEl.innerHTML = tips.map(tip => `<li style="margin-bottom:12px;">${tip}</li>`).join('');
      adviceDiv.style.display = 'block';
      defaultDiv.style.display = 'none';
    })
    .catch(err => {
      tipsEl.innerHTML = '<li style="color:#ff6b6b;">Erreur ‚Äì r√©essaie plus tard</li>';
      adviceDiv.style.display = 'block';
      defaultDiv.style.display = 'none';
    });
  });
});
</script>



    </section>


    <section class="card output-card">
<!-- Mode R√©partition des esp√®ces -->
<!-- Carte R√©partition Esp√®ces (version sans restriction mer) -->
<div id="repartition-mode" class="mode">
  <h2 style="text-align:center; color:#00ff9d;">R√©partition des esp√®ces üó∫Ô∏è</h2>
  <p style="text-align:center; color:#aaa; margin:10px 0;">
    Clique n‚Äôimporte o√π (terre ou mer) ‚Üí voir les esp√®ces plausibles √† cet endroit
  </p>

  <!-- Carte -->
  <div style="margin:20px auto; max-width:900px;">
    <div id="repartitionMap" style="height:500px; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.6);"></div>
  </div>

  <!-- R√©sultat -->
  <div id="repartitionResult" style="margin:20px auto; padding:20px; background:#001122; border-radius:12px; max-width:900px; min-height:120px; text-align:center;">
    <p style="color:#00ff9d; font-size:18px;">Clique sur la carte (terre ou mer) pour voir les esp√®ces plausibles‚Ä¶</p>
  </div>
</div>

<script>
// === CARTE R√âPARTITION ESP√àCES (clic partout autoris√©) ===
document.addEventListener('DOMContentLoaded', () => {
  const repMap = L.map('repartitionMap').setView([46.6, 2.0], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(repMap);

  // === DONN√âES DE R√âPARTITION (France + mer 2026) ===
  const repartition = {
    // Eau douce ‚Äì h√©misph√®re nord uniquement (pas en pleine mer)
    brochet:         { name: "Brochet",          category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    perche:          { name: "Perche",           category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    sandre:          { name: "Sandre",           category: "eau_douce", present: (lat, lng) => lat > 42 && lat < 51 && lng > -2 && lng < 9 },
    blackbass:       { name: "Black-bass",       category: "eau_douce", present: (lat, lng) => lat > 42 && lat < 50 && lng > -2 && lng < 8 },
    silure:          { name: "Silure",           category: "eau_douce", present: (lat, lng) => lat > 42 && lat < 50 && lng > -1 && lng < 9 },
    carpe:           { name: "Carpe",            category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    amourblanc:      { name: "Amour blanc",      category: "eau_douce", present: (lat, lng) => lat > 43 && lat < 50 && lng > -2 && lng < 8 },
    esturgeon:       { name: "Esturgeon",        category: "eau_douce", present: (lat, lng) => lat > 42 && lat < 50 && lng > -2 && lng < 9 },
    gardon:          { name: "Gardon",           category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    rotengle:        { name: "Rotengle",         category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    tanche:          { name: "Tanche",           category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    barbeau:         { name: "Barbeau",          category: "eau_douce", present: (lat, lng) => lat > 42 && lat < 51 && lng > -2 && lng < 9 },
    breme:           { name: "Br√®me",            category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    carassin:        { name: "Carassin",         category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    chevesne:        { name: "Chevesne",         category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    aspe:            { name: "Aspe",             category: "eau_douce", present: (lat, lng) => lat > 42 && lat < 48 && lng > -2 && lng < 4 },
    ombre:           { name: "Ombre",            category: "eau_douce", present: (lat, lng) => lat > 44 && lat < 49 && lng > 4 && lng < 8 },
    omblechevalier:  { name: "Omble chevalier",  category: "eau_douce", present: (lat, lng) => lat > 44 && lat < 48 && lng > 5.5 && lng < 8 },
    truitearcenciel: { name: "Truite arc-en-ciel", category: "eau_douce", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
    lote:            { name: "Lote",             category: "eau_douce", present: (lat, lng) => lat > 46 && lat < 50 && lng > 2 && lng < 8 },

    // Esp√®ces marines / c√¥ti√®res
    barracuda:       { name: "Barracuda",        category: "eau_salee", present: (lat, lng) => lat > 41 && lat < 44 && lng > 3 && lng < 9 },
    tarpon:          { name: "Tarpon",           category: "eau_salee", present: (lat, lng) => lat > 41 && lat < 44 && lng > 3 && lng < 9 },
    bar:             { name: "Bar / Loup",       category: "eau_salee", present: (lat, lng) => lat > 41 && lat < 51 && (lng < 0 || lng > 5 || lat < 47) },
    lieujaune:       { name: "Lieu jaune",       category: "eau_salee", present: (lat, lng) => lat > 47 && lat < 51 && lng > -5 && lng < 2 },
    maquereau:       { name: "Maquereau",        category: "eau_salee", present: (lat, lng) => lat > 43 && lat < 51 && lng > -5 && lng < 9 },
    doraderoyale:    { name: "Dorade royale",    category: "eau_salee", present: (lat, lng) => lat > 41 && lat < 46 && lng > -2 && lng < 9 },
    congre:          { name: "Congre",           category: "eau_salee", present: (lat, lng) => lat > 41 && lat < 51 && lng > -5 && lng < 9 },
  };

  // === CLIC SUR CARTE (partout autoris√©) ===
  repMap.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    if (window.currentMarker) repMap.removeLayer(window.currentMarker);

    window.currentMarker = L.marker([lat, lng], {
      icon: L.divIcon({
        html: '<div style="background:#ff3366;color:white;padding:8px 14px;border-radius:50px;font-weight:bold;box-shadow:0 0 15px #ff3366;">?</div>',
        iconSize: [60, 40],
        iconAnchor: [30, 20]
      })
    }).addTo(repMap);

    const eauDouce = [];
    const eauSalee = [];

    for (const key in repartition) {
      if (repartition[key].present(lat, lng)) {
        if (repartition[key].category === "eau_douce") {
          eauDouce.push(repartition[key].name);
        } else {
          eauSalee.push(repartition[key].name);
        }
      }
    }

    const resultDiv = document.getElementById('repartitionResult');

    let html = `<h3 style="color:#00ff9d; margin-bottom:15px;">Esp√®ces plausibles ici</h3>`;

    if (eauDouce.length > 0) {
      html += `<p style="color:#aaa;">Eau douce :</p><div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:15px;">`;
      eauDouce.forEach(sp => {
        html += `<span style="background:#003366; color:#00ff9d; padding:8px 16px; border-radius:30px; font-size:16px; border:1px solid #00ff9d33;">${sp}</span>`;
      });
      html += `</div>`;
    }

    if (eauSalee.length > 0) {
      html += `<p style="color:#aaa;">Eau sal√©e / c√¥ti√®re :</p><div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">`;
      eauSalee.forEach(sp => {
        html += `<span style="background:#004466; color:#00ccff; padding:8px 16px; border-radius:30px; font-size:16px; border:1px solid #00ccff33;">${sp}</span>`;
      });
      html += `</div>`;
    }

    if (eauDouce.length === 0 && eauSalee.length === 0) {
      html += `<p style="color:#ff3366; font-size:18px; margin-top:20px;">
        Aucune esp√®ce typique d√©tect√©e ici‚Ä¶ (zone tr√®s atypique ?)
      </p>`;
    }

    html += `<p style="color:#aaa; margin-top:15px; font-size:14px;">
      Coordonn√©es : ${lat.toFixed(5)}, ${lng.toFixed(5)}
    </p>`;

    resultDiv.innerHTML = html;
  });
});
</script>
<style>
  .custom-marker {
    filter: drop-shadow(0 0 8px #ff3366);
  }
</style>
<!-- ============================= -->



    
          <!-- Mode Coach -->
<!-- Mode Coach -->
<!-- Mode Coach -->
<div id="mode-coach" class="mode">
  <h2 style="text-align:center;color:#00ff9d;">Mode Coach IA üèÜ</h2>
  <p style="text-align:center;color:#aaa;margin:10px 0;">S√©lectionne ton esp√®ce et milieu, puis clique sur la carte pour ton spot. L'IA analyse en direct !</p>
    <h2 style="text-align:center;color:#00ff9d;">CE MODE EST EN MAINTENANCE IL N'EST PAS FONCTIONNEL POUR L'INSTANT, CA ARRIVE BIENT√îT</h2>

  <!-- S√©lecteurs -->
  <div style="max-width:600px;margin:0 auto;padding:15px;background:#001122;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.5);">
    <label style="display:block;margin-bottom:8px;color:#00ff9d;">Esp√®ce cibl√©e</label>
    <select id="coachSpecies" style="
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      background: #0d1b2a;
      color: #e0e0e0;
      border: 1px solid #00ff9d33;
      font-size: 16px;
      font-family: 'Segoe UI', system-ui, sans-serif;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.4);
      transition: all 0.25s ease;
      appearance: none;
      -webkit-appearance: none;
      background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300ff9d' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E\");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
    ">
      <option value="brochet">Brochet</option>
      <option value="perche">Perche</option>
      <option value="sandre">Sandre</option>
      <option value="black-bass">Black-bass</option>
      <option value="silure">Silure</option>
      <option value="truite">Truite</option>
      <option value="chevesne">Chevesne</option>
    </select>

    <label style="display:block;margin:15px 0 8px;color:#00ff9d;">Milieu</label>
    <select id="coachMilieu" style="
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      background: #0d1b2a;
      color: #e0e0e0;
      border: 1px solid #00ff9d33;
      font-size: 16px;
      font-family: 'Segoe UI', system-ui, sans-serif;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.4);
      transition: all 0.25s ease;
      appearance: none;
      -webkit-appearance: none;
      background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300ff9d' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E\");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
    ">
      <option value="√âtang">√âtang</option>
      <option value="Rivi√®re">Rivi√®re</option>
      <option value="Canal">Canal</option>
      <option value="Lac">Lac</option>
    </select>
  </div>

  <!-- Carte Leaflet -->
  <div style="margin:20px auto;max-width:800px;">
    <div id="coachMap" style="height:400px;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.6);"></div>
  </div>

  <!-- R√©sultat IA en direct -->
  <div id="coachResult" style="margin:20px auto;padding:20px;background:#001122;border-radius:15px;max-width:800px;box-shadow:0 10px 30px rgba(0,0,0,0.5);min-height:150px;text-align:center;">
    <p style="color:#00ff9d;font-size:18px;">Clique sur la carte pour analyser ton spot en direct... üîç</p>
  </div>

  <!-- Statut actualisation -->
  <p id="coachStatus" style="text-align:center;color:#aaa;font-size:14px;margin-top:10px;">Actualisation toutes les 60s ‚Ä¢ Derni√®re mise √† jour : --</p>
</div>

<script>
// === MODE COACH - Analyse IA en direct ===
document.addEventListener('DOMContentLoaded', () => {
  let coachMap = null;
  let coachMarker = null;
  let coachTimer = null;
  let currentSpot = null;
  let lastAdvice = null;
  let lastTemp = null;
  let lastPrecip = null;
  let lastWind = null;
  let lastMoonPhase = null;
  let lastTide = null;
  let userWeatherOverride = null;

  // Init carte
  coachMap = L.map('coachMap').setView([46.8, 2.5], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(coachMap);

  // Clic sur carte ‚Üí placer marker + analyser
  coachMap.on('click', e => {
    currentSpot = e.latlng;
    if (coachMarker) coachMap.removeLayer(coachMarker);
    coachMarker = L.marker(currentSpot, {
      icon: L.divIcon({
        html: '<div style="background:#00ff9d;color:black;padding:8px 16px;border-radius:50px;font-weight:bold;box-shadow:0 0 15px #00ff9d;">SPOT</div>',
        iconSize: [100, 40],
        iconAnchor: [50, 20]
      })
    }).addTo(coachMap);
    analyserCoach();
    if (coachTimer) clearInterval(coachTimer);
    coachTimer = setInterval(analyserCoach, 60000);
  });

  // Gestion override m√©t√©o
  function setupWeatherButtons() {
    const buttons = document.querySelectorAll('.weather-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        userWeatherOverride = btn.dataset.value;
        analyserCoach();
      });
    });
  }

  // Phase lunaire
  function getMoonPhase(date = new Date()) {
    const knownNewMoon = new Date(2025, 0, 13);
    const days = (date - knownNewMoon) / (1000 * 60 * 60 * 24);
    const phase = (days % 29.53) / 29.53;
    if (phase < 0.03 || phase > 0.97) return "Nouvelle Lune";
    if (phase > 0.47 && phase < 0.53) return "Pleine Lune";
    if (phase < 0.25) return "Croissante";
    if (phase < 0.75) return "D√©croissante";
    return "Pleine Lune";
  }

  async function analyserCoach() {
    if (!currentSpot) return;

    const resultDiv = document.getElementById('coachResult');
    const statusDiv = document.getElementById('coachStatus');
    resultDiv.innerHTML = '<p style="color:#00ff9d;font-size:18px;">Analyse en direct... üì°</p>';

    try {
      // R√©cup√®re les valeurs √Ä CHAQUE APPEL (pas de cache)
      const speciesSelect = document.getElementById('coachSpecies');
      const milieuSelect = document.getElementById('coachMilieu');

      if (!speciesSelect || !milieuSelect) {
        console.error('Erreur : les s√©lecteurs coachSpecies ou coachMilieu sont introuvables dans le DOM');
        resultDiv.innerHTML = '<p style="color:#e74c3c;">Erreur : s√©lecteurs introuvables. Recharge la page.</p>';
        return;
      }

      const species = speciesSelect.value.trim();
      const milieu = milieuSelect.value.trim();

      // Log clair et imm√©diat
      console.log('=== DEBUG MODE COACH (clic sur carte) ===');
      console.log('Esp√®ce s√©lectionn√©e (r√©elle) :', species);
      console.log('Milieu s√©lectionn√© :', milieu);
      console.log('Coordonn√©es spot :', currentSpot);

      // Fetch m√©t√©o (inchang√©)
      const meteoRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentSpot.lat}&longitude=${currentSpot.lng}&current=temperature_2m,precipitation,wind_speed_10m,pressure_msl,cloud_cover,is_day&timezone=Europe/Paris`);
      const meteo = await meteoRes.json();
      const c = meteo.current;
      let temp = Math.round(c.temperature_2m);
      let precip = c.precipitation;
      let wind = Math.round(c.wind_speed_10m);
      let pression = Math.round(c.pressure_msl);
      let isDay = c.is_day === 1;
      let clouds = c.cloud_cover;

      // Lune
      const moonPhase = getMoonPhase();
      const moonText = moonPhase.includes("Pleine") ? "pleine lune" : moonPhase.includes("Nouvelle") ? "nouvelle lune" : moonPhase.toLowerCase();

      // Mar√©e placeholder
      let tideText = "mar√©e inconnue";

      // Conditions auto
      let conditions = [];
      if (precip > 0.1) conditions.push('pluie');
      if (wind > 25) conditions.push('vent fort');
      if (clouds > 70) conditions.push('nuageux');
      else conditions.push('clair');
      if (!isDay) conditions.push('nuit');
      conditions.push(moonText);
      conditions.push(tideText);
      let autoConditions = conditions.join(' ');

      // Override m√©t√©o
      let finalConditions = autoConditions;
      let weatherDisplay = 'Auto-d√©tect√©';
      if (userWeatherOverride) {
        if (userWeatherOverride === 'soleil') finalConditions = 'clair jour';
        if (userWeatherOverride === 'nuages') finalConditions = 'nuageux';
        if (userWeatherOverride === 'pluie') finalConditions = 'pluie';
        weatherDisplay = `Choisi : ${userWeatherOverride.charAt(0).toUpperCase() + userWeatherOverride.slice(1)}`;
      }

      // Stabilit√©
      let needNewAdvice = true;
      if (lastTemp !== null && lastPrecip !== null && lastWind !== null && lastMoonPhase && lastTide) {
        const tempDiff = Math.abs(temp - lastTemp);
        const precipDiff = Math.abs(precip - lastPrecip);
        const windDiff = Math.abs(wind - lastWind);
        const moonSame = moonPhase === lastMoonPhase;
        const tideSame = tideText === lastTide;
        if (tempDiff < 1 && precipDiff < 0.1 && windDiff < 2 && moonSame && tideSame) {
          needNewAdvice = false;
          resultDiv.innerHTML = lastAdvice;
        }
      }

      if (needNewAdvice) {
        const adviceRes = await fetch('/api/advice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            targetSpecies: species,
            structure: "Mixte",
            conditions: finalConditions,
            spotType: milieu,
            temperature: temp,
          })
        });

        if (!adviceRes.ok) throw new Error('Erreur API : ' + adviceRes.status);

        const conseil = await adviceRes.json();

        let html = `
          <h3 style="color:#00ff9d;margin:0 0 15px;">Conditions √† ton spot</h3>
          <p style="font-size:18px;">
            üå°Ô∏è ${temp}¬∞C ‚Ä¢ üí® ${wind} km/h ‚Ä¢ üåßÔ∏è ${precip}mm ‚Ä¢ ‚òÅÔ∏è ${clouds}% ‚Ä¢ ${isDay ? 'Jour' : 'Nuit'} ‚Ä¢ ${pression} hPa<br>
            üåï Lune : ${moonPhase} ‚Ä¢ üåä Mar√©e : ${tideText}<br>
            <strong>${weatherDisplay}</strong>
          </p>
          <div style="background:#003366;padding:20px;border-radius:12px;margin:15px 0;">
            <b style="color:#ffd700;font-size:22px;">${species.toUpperCase()} en ${milieu}</b><br>
            <b style="color:#00ff9d;font-size:20px;margin-top:10px;display:block;">Conseils IA :</b>
            ${conseil.lures?.map(l => `<p style="margin:8px 0;font-size:18px;">- ${l}</p>`).join('') || "<p>- Pas de conseil disponible</p>"}
          </div>
          <h3 style="color:#00ff9d;margin:20px 0 10px;">C'est quoi le temps vraiment ?</h3>
          <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
            <button class="weather-btn ${userWeatherOverride === 'soleil' ? 'active' : ''}" data-value="soleil" style="background:#ffd700;color:black;padding:10px 20px;border-radius:30px;cursor:pointer;border:none;font-weight:bold;">Soleil ‚òÄÔ∏è</button>
            <button class="weather-btn ${userWeatherOverride === 'nuages' ? 'active' : ''}" data-value="nuages" style="background:#aaa;color:black;padding:10px 20px;border-radius:30px;cursor:pointer;border:none;font-weight:bold;">Nuages ‚òÅÔ∏è</button>
            <button class="weather-btn ${userWeatherOverride === 'pluie' ? 'active' : ''}" data-value="pluie" style="background:#4285f4;color:white;padding:10px 20px;border-radius:30px;cursor:pointer;border:none;font-weight:bold;">Pluie üåßÔ∏è</button>
          </div>
        `;

        resultDiv.innerHTML = html;
        lastAdvice = html;
        lastTemp = temp;
        lastPrecip = precip;
        lastWind = wind;
        lastMoonPhase = moonPhase;
        lastTide = tideText;

        setupWeatherButtons();
      }

      statusDiv.textContent = `Actualisation toutes les 60s ‚Ä¢ Derni√®re : ${new Date().toLocaleTimeString('fr-FR')}`;
    } catch (e) {
      resultDiv.innerHTML = '<p style="color:#e74c3c;font-size:18px;">Erreur analyse ‚Äì r√©essaie</p>';
      console.error('Erreur coach :', e);
    }
  }

  // Init carte
  setTimeout(() => coachMap.invalidateSize(), 300);

  // Style boutons m√©t√©o
  const weatherStyle = document.createElement('style');
  weatherStyle.textContent = `
    .weather-btn.active {
      background: #00ff9d !important;
      color: black !important;
      box-shadow: 0 0 15px #00ff9d;
    }
  `;
  document.head.appendChild(weatherStyle);
});
</script>
      </div>
      <div id="mode-expert" style="display:none">
        <!-- PR√âVISION DE TOUCHES 7 JOURS ‚Äî VERSION PARFAITE (bug affichage fix√©) -->
<div id="biteForecast" style="margin:20px auto;padding:20px;background:linear-gradient(135deg,#000428,#004e92);border-radius:20px;color:white;box-shadow:0 10px 40px rgba(0,50,150,0.6);">
  <h3 style="text-align:center;margin:15px 0 10px;font-size:20px;color:#00d4aa;">
    Pr√©vision de touches ‚Äì 7 jours 
  </h3>
  <div id="forecastGraph" style="height:240px;position:relative;"></div>
  <div style="display:flex;justify-content:space-around;margin-top:15px;font-size:12px;opacity:0.9;">
    <div><span id="day0">...</span><br><span id="peak0">-</span></div>
    <div><span id="day1">...</span><br><span id="peak1">-</span></div>
    <div><span id="day2">...</span><br><span id="peak2">-</span></div>
    <div><span id="day3">...</span><br><span id="peak3">-</span></div>
    <div><span id="day4">...</span><br><span id="peak4">-</span></div>
    <div><span id="day5">...</span><br><span id="peak5">-</span></div>
    <div><span id="day6">...</span><br><span id="peak6">-</span></div>
  </div>
</div>
<script>
// === PR√âVISION DE TOUCHES 7 JOURS ‚Äî VERSION FINALE PARFAITE (affichage corrig√© 2025) ===
let userLat = 47.30;  // La Chapelle-sur-Erdre par d√©faut
let userLon = -1.55;

async function getUserLocationAndForecast() {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        fetchRealForecast();
      },
      () => fetchRealForecast(), // si refus GPS ‚Üí fallback
      { timeout: 10000 }
    );
  } else {
    fetchRealForecast();
  }
}

async function fetchRealForecast() {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLat}&longitude=${userLon}&hourly=temperature_2m,pressure_msl,wind_speed_10m,precipitation&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum&timezone=Europe/Paris`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    const forecast = [];

    for (let i = 0; i < 7; i++) {
      const date = new Date();
      date.setDate(date.getDate() + i);

      const tMax = data.daily.temperature_2m_max[i];
      const tMin = data.daily.temperature_2m_min[i];
      const pressure = data.hourly.pressure_msl[i * 24 + 12];
      const wind = data.hourly.wind_speed_10m[i * 24 + 12];
      const precip = data.daily.precipitation_sum[i];

      const waterTemp = Math.round((tMax + tMin) / 2 * 0.92 + 1.8);

      const moonPhase = getMoonPhase(date);
      const moonScore = moonPhase < 0.15 || moonPhase > 0.85 ? 1.55 : moonPhase > 0.4 && moonPhase < 0.6 ? 1.35 : 0.85;

      const prevPressure = i > 0 ? data.hourly.pressure_msl[(i - 1) * 24 + 12] : pressure + 2;
      const pressureDrop = prevPressure - pressure > 3 ? 1.7 : prevPressure - pressure > 0 ? 1.35 : 0.75;

      const windScore = wind < 12 ? 1.4 : wind < 25 ? 1.0 : 0.65;
      const rainScore = precip > 0 && precip < 10 ? 1.45 : 1.0;

      let score = 4.3 * moonScore * pressureDrop * windScore * rainScore;
      if (waterTemp >= 10 && waterTemp <= 17) score *= 1.5;
      if (waterTemp >= 12 && waterTemp <= 15) score *= 1.3;
      score = Math.max(1.8, Math.min(9.9, score + (Math.random() * 0.6 - 0.2)));
      score = Math.round(score * 10) / 10;

      const peak = score > 8.7 ? "6-10h & 17-21h" :
                   score > 7.5 ? "7-11h & 16-20h20" :
                   score > 5.5 ? "8-12h ou 17-19h" : "Calme";

      const color = score > 8.7 ? '#00ff00' :
                    score > 7.5 ? '#00ff9d' :
                    score > 5.5 ? '#ffd700' : '#ff4444';

      forecast.push({ date: date.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'}), score, peak, color });
    }

    renderRealForecast(forecast);
  } catch (e) {
    renderRealForecastFallback();
  }
}

function getMoonPhase(d) {
  const knownNewMoon = new Date('2025-01-13T00:00:00Z');
  const daysSince = (d - knownNewMoon) / (1000 * 60 * 60 * 24);
  const phase = (daysSince % 29.53059) / 29.53059;
  return phase < 0 ? phase + 1 : phase;
}

function renderRealForecast(data) {
  const graph = document.getElementById('forecastGraph');
  graph.innerHTML = '';

  data.forEach((day, i) => {
    const height = Math.max(20, (day.score / 10) * 200);

    // Barre
    const bar = document.createElement('div');
    bar.style.cssText = `
      position:absolute;
      bottom:30px;
      left:${i * 13.5 + 6}%;
      width:11%;
      height:${height}px;
      background:${day.color};
      border-radius:10px 10px 0 0;
      box-shadow:0 6px 20px rgba(0,0,0,0.7);
    `;

    // Score DANS la barre (plus jamais dehors)
    const scoreLabel = document.createElement('div');
    scoreLabel.textContent = day.score;
    scoreLabel.style.cssText = `
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      font-size:18px;
      font-weight:bold;
      color:white;
      text-shadow:0 0 10px black;
    `;

    bar.appendChild(scoreLabel);
    graph.appendChild(bar);

    // Jour + heures de pic
    document.getElementById('day' + i).textContent = day.date;
    document.getElementById('peak' + i).textContent = day.peak;
  });
}

function renderRealForecastFallback() {
  for (let i = 0; i < 7; i++) {
    document.getElementById('day' + i).textContent = new Date(Date.now() + i * 86400000).toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'});
    document.getElementById('peak' + i).textContent = "Hors-ligne";
  }
}

// Lancement
getUserLocationAndForecast();
setInterval(getUserLocationAndForecast, 6 * 3600000); // refresh 6h
</script>
        
                      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div style="width:340px;margin:20px auto;padding:15px;border-radius:18px;
background:linear-gradient(180deg,#1b2b3a,#0d1a26);color:white;
font-family:Arial;box-shadow:0 10px 25px rgba(0,0,0,.45);">

  <div style="text-align:center">
    <div style="color:#4fd1c5;font-weight:bold">M√âT√âO LIVE DU SPOT</div>
    <div style="font-size:12px;opacity:.8">
      Suivi m√©t√©o en temps r√©el
    </div>
  </div>

  <div id="live-meteo-map" style="
    height:180px;
    margin-top:10px;
    border-radius:12px;
    overflow:hidden;
  "></div>

  <div id="live-meteo-result" style="
    margin-top:10px;
    font-size:13px;
    line-height:1.4;
  ">
    üéØ Clique sur la carte pour suivre un spot
  </div>

  <div style="margin-top:8px;font-size:11px;opacity:.7;text-align:center">
    üîÑ Actualisation automatique toutes les 60 secondes
  </div>
</div>
      <script>
        document.addEventListener("DOMContentLoaded", () => {
let liveMap = L.map("live-meteo-map").setView([46.8, 2.5], 5);
let liveMarker = null;
let liveTimer = null;
let currentSpot = null;

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18
}).addTo(liveMap);

// Correctif Leaflet widget
setTimeout(() => liveMap.invalidateSize(), 300);

liveMap.on("click", e => {
  if (liveMarker) liveMap.removeLayer(liveMarker);
  if (liveTimer) clearInterval(liveTimer);

  currentSpot = e.latlng;

  liveMarker = L.circleMarker(currentSpot, {
    radius: 7,
    color: "#4fd1c5",
    fillOpacity: 0.9
  }).addTo(liveMap);

  // Premi√®re analyse imm√©diate
  analyserMeteoLive();

  // Rafra√Æchissement automatique
  liveTimer = setInterval(analyserMeteoLive, 60000);
});

function analyserMeteoLive() {
  if (!currentSpot) return;

  const box = document.getElementById("live-meteo-result");
  box.innerHTML = "üì° Mise √† jour m√©t√©o en cours‚Ä¶";

  fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentSpot.lat}&longitude=${currentSpot.lng}&current=temperature_2m,precipitation,wind_speed_10m,wind_direction_10m,pressure_msl`)
    .then(r => r.json())
    .then(d => {
      const m = d.current;
      const score = scoreMeteoLive(m);
      const reco = recoMeteoLive(score);

      const heure = new Date().toLocaleTimeString();

      box.innerHTML = `
        ‚è±Ô∏è <b>Derni√®re maj :</b> ${heure}<br><br>
        üå°Ô∏è ${m.temperature_2m}¬∞C<br>
        üå¨Ô∏è ${m.wind_speed_10m} km/h (${dirVent(m.wind_direction_10m)})<br>
        üåßÔ∏è ${m.precipitation} mm<br>
        üìâ ${m.pressure_msl} hPa<br><br>

        üéØ <b>Score m√©t√©o live :</b> ${score}/100<br>
        üëâ <b>${reco}</b>
      `;
    });
}

function scoreMeteoLive(m) {
  let s = 100;
  if (m.wind_speed_10m > 25) s -= 30;
  if (m.precipitation > 1) s -= 25;
  if (m.pressure_msl < 1005) s -= 20;
  if (m.temperature_2m < 5 || m.temperature_2m > 30) s -= 15;
  return Math.max(10, s);
}

function recoMeteoLive(score) {
  if (score >= 80) return "üî• EXCELLENT ‚Äî activit√© max";
  if (score >= 60) return "‚úÖ BON ‚Äî strat√©gie adapt√©e";
  if (score >= 40) return "‚ö†Ô∏è FAIBLE ‚Äî p√™che lente";
  return "‚ùå D√âFAVORABLE ‚Äî attendre";
}

function dirVent(d) {
  const r = ["N","NE","E","SE","S","SO","O","NO"];
  return r[Math.round(d / 45) % 8];
}
          });
</script>
          <!-- BOUTON CARTE -->
  <button id="openMapBtn" style="position:fixed;bottom:20px;right:20px;background:#00d4aa;color:white;border:none;padding:16px 20px;border-radius:50%;font-size:28px;box-shadow:0 8px 25px rgba(0,212,170,0.6);z-index:9998;cursor:pointer;">
    Map
  </button>

  <!-- MODALE CARTE PERSONNELLE -->
  <div id="mapModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;">
    <div style="position:relative;width:100%;height:100%;">
      <button onclick="document.getElementById('mapModal').style.display='none'" style="position:absolute;top:15px;right:15px;background:#e74c3c;color:white;border:none;padding:12px 18px;border-radius:50%;font-size:18px;z-index:10000;cursor:pointer;">X</button>
      <h2 style="position:absolute;top:15px;left:50%;transform:translateX(-50%);color:#00d4aa;z-index:10000;font-size:26px;text-shadow:0 2px 10px black;">
        Ma Carte Secr√®te Personnelle
      </h2>
      <div id="fishingMap" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- SCRIPT CARTE PERSONNELLE + PRISES + PHOTOS (VERSION FINALE) -->
  <script>
    let personalMap = null;
    let personalMarkers = {};

    function initPersonalMap() {
      if (personalMap) personalMap.remove();
      personalMap = L.map('fishingMap').setView([47.2, -1.55], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap'}).addTo(personalMap);

      const mySpots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');

      mySpots.forEach(spot => {
        const key = spot.lat + '_' + spot.lng;
        const marker = L.marker([spot.lat, spot.lng], {
          icon: L.divIcon({
            html: `<div style="background:#00d4aa;color:white;padding:10px 18px;border-radius:16px;font-weight:bolder;font-size:16px;border:4px solid white;box-shadow:0 6px 20px black;">${spot.name}</div>`,
            iconSize: [160, 60], iconAnchor: [80, 60]
          })
        }).addTo(personalMap);

        marker.bindPopup(() => {
          const catches = spot.catches || [];
          let catchesHTML = catches.length === 0 ? '<p style="color:#aaa;">Aucune prise</p>' : catches.map(c => `
            <div style="margin:8px 0;padding:10px;background:rgba(255,255,255,0.2);border-radius:8px;">
              ${c.photo ? `<img src="${c.photo}" style="width:100%;max-height:150px;object-fit:cover;border-radius:8px;margin-bottom:8px;">` : ''}
              <b>${c.species} ‚Äî ${c.weight}kg</b><br>Leurre: ${c.lure||'NC'}<br><small>${c.date}</small>
            </div>`).join('');

          return `<div style="width:280px;"><h3 style="margin:0 0 10px;color:#00d4aa;text-align:center;">${spot.name}</h3>${catchesHTML}
            <button onclick="openCatchForm(${spot.lat},${spot.lng})" style="margin-top:10px;width:100%;background:#ffd700;color:black;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">
              Ajouter une prise
            </button></div>`;
        });
      });

      // Sessions classiques
      const sessions = JSON.parse(localStorage.getItem('fishingSessions') || '[]');
      sessions.forEach(s => {
        if (s.lat && s.lng) {
          L.marker([s.lat, s.lng], {icon: L.divIcon({html: s.success ? 'Fish' : 'Cross', iconSize: [40,40], iconAnchor: [20,40]})})
            .addTo(personalMap)
            .bindPopup(`<b style="color:${s.success?'#00d4aa':'#e74c3c'};">${s.success?'Prise':'Bredouille'}</b><br>${s.spot}`);
        }
      });

      // Double-clic = nouveau spot
      personalMap.on('dblclick', e => {
        const name = prompt("Nom de ton nouveau spot secret :", "Spot de fou ");
        if (!name || name.trim().length < 2) return;
        const newSpot = {name: name.trim(), lat: e.latlng.lat, lng: e.latlng.lng, date: new Date().toLocaleDateString('fr-FR'), catches: []};
        const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
        spots.push(newSpot);
        localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
        alert(`Spot "${name}" cr√©√© !`);
        initPersonalMap();
      });

      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          personalMap.setView([pos.coords.latitude, pos.coords.longitude], 14);
          L.marker([pos.coords.latitude, pos.coords.longitude], {icon: L.divIcon({html: 'Person', iconSize: [50,50], iconAnchor: [25,50]})})
            .addTo(personalMap).bindPopup("T'es l√†, L√©gende !").openPopup();
        });
      }
    }

    function openCatchForm(lat, lng) {
      const species = prompt("Esp√®ce", "Brochet") || "";
      const weight = prompt("Poids en kg", "0") || "0";
      const lure = prompt("Leurre ?", "") || "";
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
          const spots = JSON.parse(localStorage.getItem('myPersonalSpots') || '[]');
          const spot = spots.find(s => s.lat === lat && s.lng === lng);
          spot.catches.push({species, weight: parseFloat(weight), lure, photo: ev.target.result, date: new Date().toLocaleDateString('fr-FR')});
          localStorage.setItem('myPersonalSpots', JSON.stringify(spots));
          alert(`${species} de ${weight}kg ajout√© !`);
          initPersonalMap();
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    document.getElementById('openMapBtn').addEventListener('click', () => {
      document.getElementById('mapModal').style.display = 'block';
      setTimeout(initPersonalMap, 300);
    });
  </script>


  <script>
// Force l'enregistrement du service worker + manifest
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(() => {
    console.log('SW enregistr√© ‚Äì logo PWA OK');
  }).catch(err => console.log('SW erreur', err));
}

// Force le reload du manifest sur mobile
if ('applicationCache' in window === false && 'serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
      console.log('PWA install√©e ‚Äì logo devrait s\'afficher');
    }
  });
}
</script>

  <!-- POP-UP CONNEXION GOOGLE ‚Äî UNIQUEMENT SI NON CONNECT√â -->
<div id="googleLoginPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:99999;justify-content:center;align-items:center;flex-direction:column;">
  <div style="background:#001122;padding:30px;border-radius:20px;max-width:500px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,255,157,0.4);position:relative;">
    <button id="closePopupBtn" style="position:absolute;top:10px;right:15px;background:none;border:none;color:#888;font-size:32px;cursor:pointer;">&times;</button>
    
    <h2 style="color:#00ff9d;font-size:28px;margin:20px 0;">üîí Connecte-toi avec Google</h2>
    
    <p style="color:white;font-size:18px;line-height:1.6;margin:20px 0;">
      Pour d√©bloquer toutes les fonctionnalit√©s de FisherForce AI :<br><br>
      ‚Ä¢ Sauvegarde de ton XP et stats<br>
      ‚Ä¢ Synchronisation entre appareils<br>
      ‚Ä¢ Acc√®s Premium + classements<br>
      ‚Ä¢ Historique s√©curis√© et illimit√©
    </p>
    
    <button id="popupLoginBtn" style="background:#00d4aa;color:black;padding:18px 40px;border:none;border-radius:50px;font-weight:bold;font-size:22px;cursor:pointer;box-shadow:0 10px 30px rgba(0,212,170,0.6);margin:20px 0;">
      <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google" style="width:24px;vertical-align:middle;margin-right:10px;">
      Se connecter avec Google
    </button>
    
    <p style="color:#888;font-size:14px;margin-top:30px;">
      100% s√©curis√© ‚Ä¢ Aucune donn√©e vendue ‚Ä¢ Via Google officiel
    </p>
  </div>
</div>

<script>
// === POP-UP CONNEXION GOOGLE ‚Äì N‚ÄôAFFICHE QUE SI NON CONNECT√â ===
document.addEventListener('DOMContentLoaded', () => {
  const popup = document.getElementById('googleLoginPopup');
  if (!popup) {
    console.warn("Popup Google non trouv√©e dans le DOM");
    return;
  }

  // Fonction pour g√©rer la popup une fois Firebase pr√™t
  function checkAuthAndShowPopup() {
    if (typeof firebase === 'undefined' || !firebase.auth) {
      console.warn("Firebase pas charg√© ‚Äì on r√©essaie dans 500ms");
      setTimeout(checkAuthAndShowPopup, 500);
      return;
    }

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        // D√©j√† connect√© ‚Üí cache popup et met √† jour pseudo
        popup.style.display = 'none';
        const userPseudoEl = document.getElementById('userPseudo');
        if (userPseudoEl) {
          userPseudoEl.textContent = user.displayName?.split(' ')[0] || user.email?.split('@')[0] || 'Connect√©';
        }
        console.log("Utilisateur d√©j√† connect√© :", user.displayName);
      } else {
        // Pas connect√© ‚Üí affiche popup
        popup.style.display = 'flex';
        console.log("Pas de connexion ‚Üí popup affich√©e");
      }
    });
  }

  // Lance la v√©rification
  checkAuthAndShowPopup();

  // Bouton fermer
  const closeBtn = document.getElementById('closePopupBtn');
  if (closeBtn) {
    closeBtn.onclick = () => popup.style.display = 'none';
  }

  // Bouton connexion
  const loginBtn = document.getElementById('popupLoginBtn');
  if (loginBtn) {
    loginBtn.onclick = () => {
      if (typeof firebase !== 'undefined' && firebase.auth) {
        firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider())
          .then(() => popup.style.display = 'none')
          .catch(err => console.error("Erreur connexion Google :", err));
      } else {
        alert("Firebase non charg√© ‚Äì recharge la page");
      }
    };
  }
});
</script>

      </div>
      <!-- ================= POLICE ACTION ================= -->

<div id="police-action" style="
margin-top:20px;
padding:15px;
border-radius:12px;
background:#14202b;
border:1px solid #2b4c66;
display:none;
font-size:14px">

<h3>üöî D√©claration officielle recommand√©e</h3>

<p>
Pour que le vol soit reconnu l√©galement,
vous devez effectuer une d√©claration officielle.
</p>

<button onclick="openPoliceSite()" style="
padding:8px 12px;
border:none;
border-radius:8px;
background:#1f6feb;
color:white;
cursor:pointer;">
üîó Faire une pr√©-plainte
</button>

<button onclick="generateReport()" style="
padding:8px 12px;
border:none;
border-radius:8px;
background:#2ea043;
color:white;
cursor:pointer;
margin-left:10px;">
üìÑ G√©n√©rer un r√©sum√©
</button>

<div id="report-output" style="
margin-top:15px;
background:#0e1e2c;
padding:10px;
border-radius:8px;
display:none;
white-space:pre-line"></div>

</div>

<script>

function showPoliceBlock(){
  document.getElementById("police-action").style.display = "block";
}

function openPoliceSite(){
  window.open("https://www.pre-plainte-en-ligne.gouv.fr", "_blank");
}

function generateReport(){

  const dept = document.getElementById("theft-dept")?.value || "";
  const date = document.getElementById("theft-date")?.value || "";
  const gear = document.getElementById("theft-gear")?.value || "";
  const desc = document.getElementById("theft-desc")?.value || "";

  const text = `
D√©claration de vol de mat√©riel de p√™che

D√©partement : ${dept}
Date du vol : ${date}
Mat√©riel vol√© : ${gear}

Description :
${desc}

Je certifie que ces informations sont exactes.
`;

  const output = document.getElementById("report-output");
  output.style.display = "block";
  output.textContent = text;
}

</script>


    

    

      <!-- SYST√àME DE QU√äTES XP R√âEL (2026) -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#1a0033,#330066);border-radius:20px;color:white;max-width:600px;box-shadow:0 12px 40px rgba(102,0,204,0.6);">
  <h3 style="text-align:center;color:#cc00ff;margin:0 0 20px;font-size:24px;">
    QU√äTES DU JOUR ‚Äì GAGNE DE L‚ÄôXP R√âEL
  </h3>
  
  <div id="dailyQuests">
    <div class="quest" id="quest1">
      <p><strong>1. Aller p√™cher </strong> ‚Üí +20 XP</p>
      <button onclick="completeQuest(1, 20)" style="background:#cc00ff;color:white;padding:10px 20px;border:none;border-radius:50px;font-weight:bold;">Accomplie</button>
    </div>
    
    <div class="quest" id="quest2">
      <p><strong>2. Utiliser la m√©t√©o auto</strong> ‚Üí +50 XP</p>
      <button onclick="completeQuest(2, 50)" style="background:#cc00ff;color:white;padding:10px 20px;border:none;border-radius:50px;font-weight:bold;">Accomplie</button>
    </div>
    
    <div class="quest" id="quest3">
      <p><strong>3. Enregistrer une session (prise ou bredouille)</strong> ‚Üí +50 XP</p>
      <button onclick="completeQuest(3, 50)" style="background:#cc00ff;color:white;padding:10px 20px;border:none;border-radius:50px;font-weight:bold;">Accomplie</button>
    </div>
    

  </div>
  
  <p style="text-align:center;color:#aaa;font-size:14px;margin-top:20px;">
    Qu√™tes r√©initialis√©es tous les jours √† minuit
  </p>
</div>
      <script>
// === QU√äTES XP R√âEL (version corrig√©e) ===
const today = new Date().toDateString();
let completedQuests = JSON.parse(localStorage.getItem('completedQuests_' + today) || '[]');

function completeQuest(questId, xpReward) {
  if (completedQuests.includes(questId)) {
    alert("Qu√™te d√©j√† accomplie aujourd'hui !");
    return;
  }

  completedQuests.push(questId);
  localStorage.setItem('completedQuests_' + today, JSON.stringify(completedQuests));

  // XP r√©el
  progress.xp += xpReward;
  localStorage.setItem('fisherXP', JSON.stringify(progress));
  awardXP(xpReward, "Qu√™te accomplie !");
  updateDashboard();

  // D√©sactive le bouton
  event.target.disabled = true;
  event.target.textContent = "Accomplie ‚úì";
  event.target.style.background = "#006600";
}

// Charge les qu√™tes d√©j√† faites
completedQuests.forEach(id => {
  const btn = document.querySelector(`.quest:nth-child(${id}) button`);
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Accomplie ‚úì";
    btn.style.background = "#006600";
  }
});
</script>
      









      <!-- SIGNALER BRACONNAGE ‚Äì VERSION R√âELLE ET PUISSANTE -->
<button id="reportBracoBtn" style="margin:20px auto;display:block;width:90%;background:#ff1500;color:white;border:none;padding:18px;border-radius:14px;font-weight:bold;font-size:19px;box-shadow:0 8px 30px rgba(255,21,0,0.6);">
  SIGNALER BRACONNAGE / POLLUTION (urgence)
</button>

<div id="reportModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);z-index:99999;">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:30px;border-radius:20px;width:90%;max-width:460px;text-align:center;color:white;">
    <h2 style="color:#ff1500;margin:10px 0 20px;">SIGNALEMENT URGENT</h2>
    <p>Prends une photo/vid√©o du braconnage ou de la pollution</p>
    <input type="file" id="proofFile" accept="image/*,video/*" capture="environment" style="margin:20px 0;width:100%;padding:15px;background:#222;border-radius:12px;">
    <textarea id="reportDetails" placeholder="D√©tails rapides (filets, plaques, produits chimiques...)" style="width:100%;height:100px;background:#222;color:white;border:none;border-radius:12px;padding:15px;margin:15px 0;font-size:16px;"></textarea>
    
    <button onclick="sendRealReport()" style="width:90%;background:#ff1500;color:white;padding:18px;border:none;border-radius:50px;font-weight:bold;font-size:20px;margin:10px auto;display:block;">
      ENVOYER AUX AUTORIT√âS (GPS + preuve)
    </button>
    
    <button onclick="document.getElementById('reportModal').style.display='none'" style="background:#444;padding:12px 30px;border:none;border-radius:10px;color:white;margin-top:10px;">
      Annuler
    </button>
  </div>
</div>

<script>
// === SIGNALEMENT BRACONNAGE R√âEL (envoi direct OFB + Gendarmerie + F√©d√©) ===
document.getElementById('reportBracoBtn').addEventListener('click', () => {
  document.getElementById('reportModal').style.display = 'block';
});

async function sendRealReport() {
  const fileInput = document.getElementById('proofFile');
  const details = document.getElementById('reportDetails').value.trim();

  if (!fileInput.files[0]) {
    alert("Photo ou vid√©o obligatoire pour preuve juridique");
    return;
  }

  // G√©olocalisation
  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lon = pos.coords.longitude.toFixed(6);
    const date = new Date().toLocaleString('fr-FR');

    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const proofBase64 = reader.result;

      const subject = `URGENT - BRACONNAGE/ POLLUTION - FisherForce AI - ${date}`;
      const body = `
SIGNALEMENT URGENT VIA FISHERFORCE AI (30 000+ p√™cheurs)

Coordonn√©es GPS pr√©cises : ${lat}, ${lon}
Date/Heure : ${date}
D√©tails : ${details || "Aucun d√©tail suppl√©mentaire"}

Preuve jointe (photo/vid√©o horodat√©e avec GPS)
Application : FisherForce AI ‚Äì Signalement citoyen

Merci d'intervenir rapidement.
      `.trim();

      // ENVOI DIRECT AUX 3 AUTORIT√âS COMP√âTENTES
      const emails = [
        "signalement@ofb.gouv.fr",                    // OFB national (ex-ONEMA) ‚Äì ils traitent tous les signalements p√™che
        "police-eau@interieur.gouv.fr",               // Police de l'eau / Gendarmerie lacustre
        "contact@federationpeche.fr"                  // F√©d√©ration nationale (ils relaient localement)
      ];

      emails.forEach(email => {
        const mailto = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailto, '_blank');
      });

      // R√©compense
      awardXP(1000, "Signalement braconnage ‚Äì +1000 XP Gardien des eaux");
      alert("Signalement envoy√© aux 3 autorit√©s comp√©tentes !\n+1000 XP\nTu viens de prot√©ger nos rivi√®res.");

      document.getElementById('reportModal').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }, () => {
    alert("Active la localisation pour un signalement pr√©cis");
  });
}
</script>

 







<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
      <!-- CARTE FRAY√àRES BROCHET (p√©riode de fermeture + signalement) -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#1a0033,#330066);border-radius:20px;color:white;text-align:center;max-width:600px;box-shadow:0 12px 40px rgba(102,0,204,0.6);">
  <h3 style="margin:0 0 20px;color:#cc00ff;font-size:24px;">
    CARTE FRAY√àRES BROCHET
  </h3>
  <p style="font-size:16px;margin:15px 0;">
    <span id="fraieStatus" style="font-weight:bold;"></span><br>
    Double-clique pour signaler une fray√®re active (photo obligatoire)
  </p>
  <div id="fraieMap" style="height:450px;border-radius:15px;overflow:hidden;margin:20px 0;box-shadow:0 8px 30px black;"></div>
</div>

<script>      
// === CARTE FRAY√àRES COLLABORATIVE ‚Äî VERSION CORRIG√âE & FIABLE ===
let fraieMap = null;
let userFraieSpots = JSON.parse(localStorage.getItem('fraieSpots') || '[]');

function initFraieMap() {
  // Protection si l'√©l√©ment n'existe pas encore
  if (!document.getElementById('fraieMap')) {
    console.warn("fraieMap non trouv√© dans le DOM ‚Äì attente...");
    setTimeout(initFraieMap, 500);
    return;
  }

  // Suppression ancienne carte si existe
  if (fraieMap) fraieMap.remove();

  fraieMap = L.map('fraieMap').setView([46.8, 1.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(fraieMap);

  const today = new Date();
  const isClosed = today.getMonth() + 1 <= 4; // janvier (0) √† avril (3)

  const statusEl = document.getElementById('fraieStatus');
  if (statusEl) {
    statusEl.innerHTML = isClosed
      ? '<span style="color:#FF0000;font-size:26px;font-weight:bold;">P√äCHE AU BROCHET INTERDITE EN FRANCE</span><br><span style="font-size:18px;">Fray√®res actives ‚Äì Toute prise = infraction grave</span>'
      : '<span style="color:#00ff00;font-size:26px;font-weight:bold;">Saison de fraie termin√©e</span><br><span style="font-size:18px;">Merci d‚Äôavoir prot√©g√© nos brochets !</span>';
  }

  // Affichage des fray√®res d√©j√† ajout√©es
  userFraieSpots.forEach(spot => {
    const marker = L.marker([spot.lat, spot.lng], {
      icon: L.divIcon({
        html: '<div style="background:#FF0000;color:white;padding:8px 16px;border-radius:50px;font-weight:bold;border:3px solid white;box-shadow:0 0 25px red;font-size:16px;">FRAY√àRE</div>',
        iconSize: [140, 50],
        className: 'fraie-marker'
      })
    }).addTo(fraieMap);

    marker.bindPopup(`
      <b style="color:#FF0000;font-size:18px;">Fray√®re brochet ‚Äì P√äCHE INTERDITE</b><br>
      Ajout√© par : ${spot.pseudo || "Anonyme"} le ${spot.date}<br>
      ${spot.photo ? `<img src="${spot.photo}" style="width:100%;max-height:200px;border-radius:8px;margin:10px 0;">` : ''}
      <button onclick="proposeReserve(${spot.lat},${spot.lng})" style="margin-top:10px;background:#FFD700;color:black;padding:12px 24px;border:none;border-radius:50px;font-weight:bold;font-size:16px;">
        Proposer r√©serve AAPPMA
      </button>
    `);
  });

  // Double-clic = ajouter une fray√®re (uniquement en p√©riode de fermeture)
  fraieMap.on('dblclick', e => {
    if (!isClosed) {
      alert("Les signalements de fray√®res sont possibles uniquement pendant la p√©riode de fermeture brochet (janvier √† avril).");
      return;
    }
    addFraieSpot(e.latlng);
  });

  // Centre sur l‚Äôutilisateur
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(pos => {
      fraieMap.setView([pos.coords.latitude, pos.coords.longitude], 13);
      L.circle([pos.coords.latitude, pos.coords.longitude], {
        radius: 500,
        color: '#00ff00',
        fillOpacity: 0.2
      }).addTo(fraieMap)
        .bindPopup("Ta position approximative");
    }, err => {
      console.warn("G√©oloc √©chou√©e", err);
    });
  }
}

function addFraieSpot(latlng) {
  if (!confirm("Tu es 100 % s√ªr que c‚Äôest une fray√®re brochet active ? (photo obligatoire pour preuve)")) return;

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      const spot = {
        lat: latlng.lat.toFixed(6),
        lng: latlng.lng.toFixed(6),
        date: new Date().toLocaleDateString('fr-FR'),
        pseudo: localStorage.getItem('fisherPseudo') || "Anonyme",
        photo: ev.target.result
      };
      userFraieSpots.push(spot);
      localStorage.setItem('fraieSpots', JSON.stringify(userFraieSpots));

      // +2000 XP
      let xp = parseInt(localStorage.getItem('userXP') || '0') + 2000;
      localStorage.setItem('userXP', xp);
      awardXP(2000, "Fray√®re signal√©e ‚Äì Protection brochet");

      alert("Fray√®re ajout√©e avec succ√®s !\n+2000 XP\nPhoto sauvegard√©e ‚Äì Merci pour les brochets üá´üá∑");
      initFraieMap(); // refresh carte
    };
    reader.readAsDataURL(file);
  };

  input.click();
}

function proposeReserve(lat, lng) {
  const subject = "PROPOSITION CLASSEMENT R√âSERVE ‚Äì Fray√®re brochet d√©tect√©e via FisherForce AI";
  const body = `Bonjour,\n\nUne fray√®re brochet active a √©t√© signal√©e par la communaut√© FisherForce AI.\n\nCoordonn√©es GPS pr√©cises : ${lat}, ${lng}\nLien carte : https://www.google.com/maps?q=${lat},${lng}\n\nNous proposons le classement imm√©diat en r√©serve de p√™che pour prot√©ger la reproduction.\n\nMerci pour votre action rapide.\n\nL‚Äô√©quipe FisherForce AI (30 000+ p√™cheurs engag√©s)`;
  window.location.href = `mailto:contact@fedepeche.fr?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

// Init s√©curis√© au chargement complet
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(initFraieMap, 300); // petit d√©lai pour √™tre s√ªr que le DOM est pr√™t
});
</script>
      
      <!-- CARTE POISSONS MIGRATEURS ‚Äî VERSION PRIV√âE ULTRA-STYL√âE -->
<div style="margin:30px auto;padding:20px;background:linear-gradient(135deg,#001f3f,#0074D9);border-radius:20px;color:white;text-align:center;box-shadow:0 10px 40px rgba(0,31,63,0.8);">
  <h3 style="margin:0 0 15px;font-size:22px;color:#7FDBFF;">
    Mes Spots Poissons Migrateurs
  </h3>
  <div id="migrateursMap" style="height:450px;border-radius:15px;overflow:hidden;margin:15px 0;box-shadow:0 8px 30px black;"></div>
  <p style="font-size:15px;opacity:0.9;">
    Clique sur la carte pour placer un spot migrateur ‚Ä¢ Ic√¥ne bleue = saumon, alose, truite de mer, etc.
  </p>
</div>

<!-- Leaflet d√©j√† charg√© dans ton head, sinon ajoute les 2 lignes si besoin -->
<script>
  <!-- CARTE POISSONS MIGRATEURS + ENVOI AUTO FNPF -->
<div style="margin:30px auto;padding:25px;background:linear-gradient(135deg,#001f3f,#0074D9);border-radius:20px;color:white;text-align:center;box-shadow:0 12px 40px rgba(0,116,217,0.7);">
  <h3 style="margin:0 0 20px;color:#7FDBFF;font-size:24px;">
    SIGNALER UN POISSON MIGRATEUR P√äCH√â
  </h3>
  <p style="font-size:16px;margin:15px 0;">
    Double-clique sur la carte pour placer ton saumon, alose, truite de mer, anguille ou lamproie<br>
    Un signalement automatique sera envoy√© √† la F√©d√©ration Nationale de P√™che
  </p>
  <div id="migrateursMap" style="height:480px;border-radius:15px;overflow:hidden;margin:20px 0;box-shadow:0 8px 30px black;"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
// === CARTE MIGRATEURS + ENVOI AUTO FNPF ===
let migrateursMap = null;

function initMigrateursMap() {
  if (migrateursMap) migrateursMap.remove();

  migrateursMap = L.map('migrateursMap').setView([46.8, 1.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(migrateursMap);

  // Double-clic = placer un migrateur
  migrateursMap.on('dblclick', e => {
    const speciesList = ["Saumon", "Alose", "Truite de mer", "Anguille", "Lamproie"];
    const species = prompt("Esp√®ce migratrice p√™ch√©e ?", speciesList[0]);
    if (!species || !speciesList.map(s => s.toLowerCase()).includes(species.toLowerCase())) {
      alert("Esp√®ce non reconnue ‚Äì choisis parmi : Saumon, Alose, Truite de mer, Anguille, Lamproie");
      return;
    }

    const lat = e.latlng.lat.toFixed(6);
    const lon = e.latlng.lng.toFixed(6);
    const date = new Date().toLocaleString('fr-FR');

    // Marqueur sur la carte
    L.marker([lat, lon], {
      icon: L.divIcon({
        html: `<div style="background:#0074D9;color:white;padding:8px 16px;border-radius:50px;font-weight:bold;border:3px solid white;box-shadow:0 0 20px #0074D9;">${species[0]}</div>`,
        iconSize: [100, 50]
      })
    }).addTo(migrateursMap)
      .bindPopup(`<b style="color:#0074D9;">${species}</b><br>${date}<br>GPS : ${lat}, ${lon}<br>Signalement envoy√© √† la FNPF`);

    // ENVOI AUTOMATIQUE √Ä LA F√âD√âRATION NATIONALE DE P√äCHE
    const subject = `SIGNALEMENT POISSON MIGRATEUR - ${species.toUpperCase()} - FisherForce AI`;
    const body = `
SIGNALEMENT AUTOMATIQUE FISHERFORCE AI (30 000+ p√™cheurs)

Esp√®ce : ${species}
Date/Heure : ${date}
Coordonn√©es GPS pr√©cises : ${lat}, ${lon}
Lien carte : https://www.google.com/maps?q=${lat},${lon}

Ce poisson migrateur a √©t√© p√™ch√© et signal√© par un utilisateur FisherForce AI dans le cadre de la protection des esp√®ces migratrices.

Merci de votre vigilance.

Cordialement,
L‚Äô√©quipe FisherForce AI
https://fisherforce.ai
    `.trim();

    const mailto = `mailto:contact@federationpeche.fr?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailto, '_blank');

    // R√©compense
    awardXP(1500, `Signalement migrateur ${species} ‚Äì +1500 XP Protecteur des migrateurs`);
    alert(`Signalement ${species} envoy√© √† la F√©d√©ration Nationale de P√™che !\n+1500 XP\nTu prot√®ges les migrateurs !`);
  });

  // G√©oloc utilisateur
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      migrateursMap.setView([pos.coords.latitude, pos.coords.longitude], 10);
    });
  }
}

document.addEventListener('DOMContentLoaded', initMigrateursMap);
</script>

      <!-- CLASSEMENT -->
      <div id="tab-ranking" class="tab-content">
        <h2>On pr√©pares de nouvelles fonctions de malade !!</h2>
        <div id="ranking-list" style="margin-top:20px;">
          <p class="muted" style="text-align:center;">Ca arrive bient√¥t ‚Ä¶</p>
        </div>
      </div>
    </section>
      <!-- ================================================= -->
<!-- FONCTION COMPARATEUR DE PRIX DE LEURRES (tout-en-un) -->
<!-- Colle ce bloc o√π tu veux dans index.html            -->
<!-- ================================================= -->

<div id="lureCompareBlock" style="margin: 30px auto; max-width: 600px; padding: 20px; background: #1a1a1a; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,212,170,0.2);">
  <h3 style="text-align: center; color: #00d4aa; margin-bottom: 15px;">Comparer le prix d'un leurre</h3>
  <p style="text-align: center; color: #aaa; margin-bottom: 20px; font-size: 14px;">
    Tape le nom exact (marque + mod√®le), ex : "Rapala X-Rap 10" ou "Fox Rage Replicant 18"
  </p>

  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <input 
      type="text" 
      id="lureNameInput" 
      placeholder="Nom du leurre (ex: Rapala X-Rap 10)" 
      style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; font-size: 16px;"
    />
    <button 
      id="compareLureBtn" 
      style="background: linear-gradient(45deg, #00d4aa, #009977); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer;"
    >
      Rechercher
    </button>
  </div>

  <div id="compareLoading" style="display: none; text-align: center; color: #00d4aa; margin: 20px 0;">
    Recherche des meilleurs prix en cours...
  </div>

  <div id="compareResults" style="margin-top: 20px; color: white;"></div>
</div>

<script>
// Script autonome ‚Äì pas besoin de modifier app.js
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('lureNameInput');
  const btn = document.getElementById('compareLureBtn');
  const loading = document.getElementById('compareLoading');
  const results = document.getElementById('compareResults');

  btn.addEventListener('click', async () => {
    const lure = input.value.trim();
    if (!lure) return alert('Entrez un nom de leurre !');

    loading.style.display = 'block';
    results.innerHTML = '';

    try {
      const response = await fetch('/api/compare-lure', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lure })
      });

      const data = await response.json();

      loading.style.display = 'none';

      if (data.error) {
        results.innerHTML = `<p style="color: #ff4444;">${data.error}</p>`;
      } else if (!data.deals || data.deals.length === 0) {
        results.innerHTML = '<p>Aucun prix trouv√© pour ce leurre.</p>';
      } else {
        let html = '<h4>Meilleurs prix trouv√©s :</h4><ul style="list-style: none; padding: 0;">';
        data.deals.forEach(deal => {
          html += `
            <li style="margin: 12px 0; padding: 12px; background: #222; border-radius: 8px;">
              <strong>${deal.site}</strong> ‚Äî <span style="color: #00ff99;">${deal.price}</span><br>
              <a href="${deal.link}" target="_blank" style="color: #00d4aa;">Voir l'offre ‚Üí</a>
            </li>`;
        });
        html += '</ul>';

        if (data.image) {
          html += `<img src="${data.image}" alt="${lure}" style="max-width: 100%; border-radius: 8px; margin-top: 15px;">`;
        }

        results.innerHTML = html;
      }
    } catch (err) {
      loading.style.display = 'none';
      results.innerHTML = '<p style="color: #ff4444;">Erreur lors de la recherche.</p>';
      console.error(err);
    }
  });
});
</script>







<!-- FIN MODULE -->
    <!-- ====== MODE COMP√âTITION ====== -->
<div style="width:320px;margin-top:10px;padding:10px;border-radius:12px;background:#101010;color:#fff;font-family:sans-serif">
  <h3 style="margin:5px 0;font-size:13px;">üèÜ Mode comp√©tition</h3>

  <button id="openCompetition"
    style="width:100%;padding:6px;border-radius:8px;border:none;background:#f1c40f;color:#000;font-weight:bold;cursor:pointer">
    Activer le mode
  </button>

  <div id="competitionPanel" style="display:none;margin-top:8px;font-size:12px;">
    <div id="compScore">Score total : 0 pts</div>
    <div id="compStats" style="margin-top:5px;"></div>

    <button id="logCompetitionCatch"
      style="margin-top:6px;width:100%;padding:6px;border-radius:8px;border:none;background:#27ae60;color:#fff;font-weight:bold">
      Ajouter une touche üéØ
    </button>
  </div>
</div>

<script>
let competitionActive = false;

const speciesPoints = {
  "Brochet": 30,
  "Sandre": 35,
  "Perche": 20,
  "Black-bass": 25,
  "Silure": 50,
  "Aspe": 40
};

function getCompetitionData() {
  return JSON.parse(localStorage.getItem("ffai_competition")) || {
    score: 0,
    catches: {}
  };
}

function saveCompetitionData(data) {
  localStorage.setItem("ffai_competition", JSON.stringify(data));
}

document.getElementById("openCompetition").onclick = () => {
  competitionActive = !competitionActive;
  document.getElementById("competitionPanel").style.display = competitionActive ? "block" : "none";
};

document.getElementById("logCompetitionCatch").onclick = () => {
  if (!competitionActive) return;

  const espece = document.getElementById("fishSpecies")?.value || "Brochet";

  let data = getCompetitionData();
  let pts = speciesPoints[espece] || 20;

  // Bonus difficult√© m√©t√©o (si variables globales)
  if (window.ff_wind > 20) pts += 10;
  if (window.ff_pressure < 1010) pts += 10;
  if (window.ff_cloud > 70) pts += 10;
  if (new Date().getHours() < 7 || new Date().getHours() > 21) pts += 15;

  data.score += pts;
  data.catches[espece] = (data.catches[espece] || 0) + 1;

  saveCompetitionData(data);
  updateCompetitionUI();
};

function updateCompetitionUI() {
  const data = getCompetitionData();
  document.getElementById("compScore").innerText =
    `Score total : ${data.score} pts`;

  let html = "Stats :<br>";
  for (let e in data.catches) {
    html += `‚Ä¢ ${e} : ${data.catches[e]}<br>`;
  }

  document.getElementById("compStats").innerHTML = html;
}

updateCompetitionUI();
</script>
<script>
function setMode(mode, btn) {
  ["rapide","coach","expert"].forEach(m => {
    document.getElementById("mode-" + m).style.display = "none";
  });

  document.getElementById("mode-" + mode).style.display = "block";

  // reset boutons
  document.querySelectorAll("button").forEach(b => {
    b.style.opacity = "0.6";
  });

  // bouton actif
  if (btn) btn.style.opacity = "1";
}
</script>


    
















  </main>
    <a href="privacy.html" style="color:#888;font-size:14px;">Politique de confidentialit√©</a>


<!-- CACHE PAR D√âFAUT TES 3 SECTIONS CARTES DANS TON HTML -->
<style>
  #spotAnalysisResult,
  #fraieStatus,
  #lureCompareBlock
  #migrateursMap {
    display: none; /* CACH√âES tant que pas cliqu√© sur le menu */
  }
</style>

  <!-- CLASSEMENT + DATE DANS LES CONSEILS (dans app.js) -->
  <script src="app.js"></script>
</body>
</html>
