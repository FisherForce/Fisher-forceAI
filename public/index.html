<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI ‚Äî</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .badge-ia {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #00d4aa;
      color: white;
      padding: 8px 16px;
      border-radius: 50px;
      font-weight: bold;
      font-size: 13px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      z-index: 9999;
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>

  <!-- === BADGE ANIM√â : IA APPRENANTE === -->
  <div class="badge-ia">IA Apprenante</div>

  <!-- === SON AU CHARGEMENT === -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const audio = new Audio('sounds/Part1per 2025-10-22_10-54-30.mp3');
      audio.volume = 0.6;
      const playSound = () => audio.play().catch(() => {});
      playSound();
      document.addEventListener('click', () => { if (audio.paused) audio.play(); }, { once: true });
    });
  </script>

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1√®re IA de p√™che 100% Fran√ßaise</p>
    </div>
  </header>

  <main class="container main-grid">

    <!-- === FORMULAIRE === -->
    <section class="card input-card">
      <h2>D√©cris ton spot</h2>
      <label>Nom du spot <input id="spotName" placeholder="Ex: √âtang du Moulin"></label>
      <label>Type d'eau
        <select id="waterType">
          <option>√âtang</option>
          <option>Rivi√®re</option>
          <option>Lac</option>
          <option>Canal</option>
        </select>
      </label>
      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>
      <label>Fr√©quentation
        <select id="pressure">
          <option value="low">Faible</option>
          <option value="medium" selected>Moyenne</option>
          <option value="high">√âlev√©e</option>
        </select>
      </label>
      <label>Esp√®ce cibl√©e <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>
      <label>Heure / Date pr√©vue <input id="dateTime" type="datetime-local"></label>
      <label>Conditions (br√®ve) <input id="conditions" placeholder="Ex: clair, pluie, vent NE"></label>

      <div class="row">
        <button id="getAdvice">Obtenir des conseils</button>
        <button id="clearBtn" class="secondary">R√©initialiser</button>
      </div>
      <p class="muted">Admin: <a href="/admin">G√©rer sponsors</a></p>
    </section>

    <!-- === CONSEILS + R√âSULTAT + STATS === -->
    <section class="card output-card">
      <h2>Conseils de l'IA</h2>
      <div id="advice">
        <p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p>
      </div>

      <!-- === BOUTON STATS (1 SEUL, PROPRE) === -->
      <div style="margin: 20px 0; text-align: center;">
        <button id="statsBtn" onclick="showStats()"
          style="padding: 12px 24px; font-size: 16px; background: #00d4aa; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: 0.2s;">
          Voir mes stats d'IA
        </button>
        <div id="stats" style="margin-top: 15px; text-align: left; font-family: monospace;"></div>
      </div>

      <!-- === ENREGISTRER R√âSULTAT === -->
      <a href="resultat.html"><button>Enregistrer un r√©sultat</button></a>

      <div id="resultat-section">
        <h3>üìù R√©sultat de ta session</h3>
        <label>Esp√®ce attrap√©e : <input type="text" id="species" placeholder="ex: perche" /></label>
        <label>Leurre utilis√© : <input type="text" id="lure" placeholder="ex: leurre souple" /></label>
        <label>Spot : <input type="text" id="spotType" placeholder="ex: rivi√®re" /></label>
        <label>Conditions m√©t√©o : <input type="text" id="conditions" placeholder="ex: soleil, vent" /></label>
        <label>Temp√©rature : <input type="number" id="temperature" placeholder="en ¬∞C" /></label>
        <p>R√©sultat :</p>
        <label><input type="radio" name="result" value="succ√®s" /> Poisson pris</label>
        <label><input type="radio" name="result" value="bredouille" /> Bredouille</label>
        <br /><br />
        <button onclick="envoyerResultat()">üì§ Envoyer mes donn√©es</button>
      </div>

      <details class="settings">
        <summary>Param√®tres avanc√©s</summary>
        <label>
          <input type="checkbox" id="allowSponsors"> Autoriser r√©f√©rences sponsoris√©es
        </label>
        <p class="muted">Si tu as une cl√© OpenAI, les conseils seront enrichis.</p>
      </details>
    </section>
  </main>

  <!-- === FOOTER === -->
  <footer class="site-footer">
    <div class="container">
      <small>2025 Fisher-ForceAI. Tous droits r√©serv√©s.</small>
      <div style="margin-top:15px; text-align:center;">
        <p>Suivez-moi sur mes r√©seaux :</p>
        <div style="display:flex; justify-content:center; gap:15px; font-size:24px;">
          <a href="https://www.instagram.com/fisherforce/" target="_blank">
            <img src="icons/insta.jpg" alt="Instagram" style="width:32px;height:32px;">
          </a>
          <a href="https://www.youtube.com/channel/UC_gRRbnmfVhiBVgLzQ7xLAw" target="_blank">
            <img src="icons/yt.png" alt="YouTube" style="width:32px;height:32px;">
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- === SCRIPTS === -->
  <script src="app.js"></script>
  <script src="script.js"></script>

  <!-- === FONCTION STATS === -->
  <script>
    async function showStats() {
      const btn = document.getElementById('statsBtn');
      btn.disabled = true;
      btn.innerHTML = "Chargement...";

      try {
        const res = await fetch('/api/learnedPatterns');
        const data = await res.json();

        let total = 0;
        for (const species in data) {
          for (const saison in data[species]) {
            for (const cond in data[species][saison]) {
              for (const spot in data[species][saison][cond]) {
                total += data[species][saison][cond][spot].length;
              }
            }
          }
        }

        document.getElementById('stats').innerHTML = `
          <div style="background:#f0fff9; padding:15px; border-radius:10px; border:2px solid #00d4aa;">
            <h3 style="margin:0; color:#00a085;">IA FisherForce en action !</h3>
            <p style="margin:5px 0;"><strong>Patterns appris :</strong> 
              <span style="color:#00d4aa; font-size:1.2em;">${total}</span>
            </p>
            <pre style="background:#fff; padding:10px; border:1px solid #ddd; border-radius:5px; max-height:300px; overflow:auto; font-size:12px;">
${JSON.stringify(data, null, 2)}
            </pre>
          </div>
        `;
      } catch (e) {
        document.getElementById('stats').innerHTML = '<p style="color:red;">Erreur de connexion</p>';
      }

      btn.disabled = false;
      btn.innerHTML = "Voir mes stats d'IA";
    }

    // === FONCTION ENVOYER R√âSULTAT (manquante avant) ===
    async function envoyerResultat() {
      const species = document.getElementById('species').value.trim();
      const lureUsed = document.getElementById('lure').value.trim();
      const spotType = document.getElementById('spotType').value.trim();
      const conditions = document.getElementById('conditions').value.trim();
      const resultFish = document.querySelector('input[name="result"]:checked')?.value === 'succ√®s';

      if (!species || !spotType || resultFish === undefined) {
        alert("Remplis tous les champs !");
        return;
      }

      const session = { species, spotType, conditions, lureUsed, resultFish };

      try {
        const res = await fetch('/api/learn', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(session)
        });
        const data = await res.json();
        if (data.success) {
          alert("Session enregistr√©e ! L'IA apprend...");
          document.getElementById('resultat-section').reset();
        } else {
          alert("Erreur : " + (data.error || "inconnue"));
        }
      } catch (e) {
        alert("Erreur de connexion");
      }
    }
  </script>
</body>
</html>
