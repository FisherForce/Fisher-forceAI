<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fisher-Force AI —</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .badge-ia { position: fixed; top: 15px; right: 15px; background: #00d4aa; color: white; padding: 8px 16px; border-radius: 50px; font-weight: bold; font-size: 13px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); z-index: 9999; animation: pulse 2s infinite; }
    .live-badge { position: fixed; top: 15px; left: 15px; background: #00d4aa; color: white; padding: 10px 16px; border-radius: 50px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(0,212,170,0.4); z-index: 9999; display: flex; align-items: center; gap: 8px; animation: pulse 2s infinite; }
    .live-dot { width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: blink 1.5s infinite; }
    .dashboard { background: linear-gradient(135deg, #00d4aa, #00a085); color: white; padding: 18px; border-radius: 16px; margin: 20px 0; text-align: center; box-shadow: 0 8px 20px rgba(0,212,170,0.3); }
    .level-badge { background: #ffd700; color: #000; padding: 6px 14px; border-radius: 30px; font-weight: bold; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-top: 12px; }
    .stat-item { background: rgba(255,255,255,0.25); padding: 10px; border-radius: 10px; }
  </style>

  <!-- FIREBASE (compat, sans init) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="live-badge"><span class="live-dot"></span> IA en direct : <span id="patternCount">42</span> patterns appris</div>

  <!-- AUTH UNIFIÉ + PSEUDO + AMIS -->
  <div id="authContainer" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.3);padding:10px 16px;border-radius:30px;">
    <div id="userInfo" style="display:none;color:white;font-weight:bold;align-items:center;gap:10px;">
      <input id="pseudoInput" type="text" placeholder="Ton pseudo" style="padding:6px 10px;border-radius:20px;border:none;font-size:13px;width:100px;">
      <button id="savePseudo" style="background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">OK</button>
      <button id="friendsBtn" style="background:#ffd700;color:#000;border:none;padding:8px 16px;border-radius:25px;font-weight:bold;cursor:pointer;font-size:13px;">Amis</button>
      <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:8px 14px;border-radius:25px;font-size:12px;cursor:pointer;">Déconnexion</button>
    </div>
    <button id="loginBtn" style="background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:25px;font-weight:bold;cursor:pointer;">Connexion Google</button>
  </div>

  <header class="site-header">
    <div class="container">
      <h1>Fisher-Force AI</h1>
      <p class="tagline">La 1ère IA de pêche 100% Française</p>
    </div>
  </header>

  <main class="container main-grid">
    <section class="card input-card">
      <h2>Décris ton spot</h2>
      <label>Nom du spot <input id="spotName" placeholder="Ex: Étang du Moulin"></label>
      <label>Type d'eau<br><select id="waterType"><option>Étang</option><option>Rivière</option><option>Lac</option><option>Canal</option></select></label>
      <label>Fond / Structure <input id="structure" placeholder="Ex: herbiers, rochers"></label>
      <label>Espèce ciblée <input id="targetSpecies" placeholder="Ex: brochet, perche"></label>
      <label>Conditions <input id="conditions" placeholder="Ex: clair, pluie"></label>
      <label>Température (°C)<br><input type="number" id="temperature" placeholder="15"></label>
      <div style="margin-top:15px;">
        <button id="getAdvice">Obtenir des conseils</button>
        <button id="voiceBtn">Commande vocale</button>
        <button id="clearBtn">Réinitialiser</button>
      </div>
    </section>

    <section class="card output-card">
      <h2>Conseils de l'IA</h2>

      <!-- DASHBOARD DE BASE (existe toujours) -->
      <div class="dashboard">
        <h3><span class="level-badge">Débutant</span> — <span id="xp">0</span> XP</h3>
        <div class="stats-grid">
          <div class="stat-item">Spots : <strong>0</strong></div>
          <div class="stat-item">Espèces : <strong>0</strong></div>
          <div class="stat-item">Réussite : <strong>0%</strong></div>
        </div>
      </div>

      <div id="advice"><p class="muted">Remplis le formulaire puis clique sur "Obtenir des conseils".</p></div>

      <button onclick="openResultat()" style="margin:20px auto; display:block; width:90%; background:#00d4aa; color:white; border:none; padding:14px; border-radius:10px; font-weight:bold;">
        Enregistrer un résultat
      </button>

<div id="tab-ranking" class="tab-content">
  <h2>Classement des Pêcheurs</h2>
  <div id="ranking-list" style="margin-top:20px;">
    <p class="muted" style="text-align:center;">Chargement du classement…</p>
  </div>

  <style>
    .player-rank {
      background: #112233;
      margin: 12px 0;
      padding: 16px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      transition: all 0.3s;
    }
    .player-rank.you {
      background: #00d4aa !important;
      color: #000;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(0,212,170,0.6);
    }
    .rank-num {
      font-size: 24px;
      font-weight: bold;
      width: 50px;
      text-align: center;
    }
    .player-name {
      flex: 1;
      margin-left: 15px;
    }
    .player-level {
      font-size: 12px;
      color: #aaa;
      margin-top: 2px;
    }
    .player-xp {
      font-weight: bold;
      color: #ffd700;
    }
    .no-players {
      text-align: center;
      color: #777;
      font-style: italic;
      margin: 30px 0;
    }
  </style>

  <script>
    // === CLASSEMENT EN TEMPS RÉEL ===
    if (typeof firebase !== 'undefined') {
      const db = firebase.firestore();
      const rankingList = document.getElementById('ranking-list');
      let currentUserUid = null;

      // Récupère l'utilisateur connecté
      firebase.auth().onAuthStateChanged(user => {
        currentUserUid = user?.uid || null;
        if (!user) {
          rankingList.innerHTML = `<p class="no-players">Connecte-toi pour voir ton classement !</p>`;
        }
      });

      // Écoute les changements Firestore
      db.collection('users')
        .orderBy('xp', 'desc')
        .limit(50)
        .onSnapshot(snapshot => {
          const players = [];
          let rank = 1;
          let yourRank = null;

          snapshot.docs.forEach(doc => {
            const data = doc.data();
            if (data.xp >= 0 && data.displayName) {
              players.push({ ...data, rank: rank++ });
              if (data.uid === currentUserUid) yourRank = rank - 1;
            }
          });

          renderRanking(players, yourRank);
        });

      function renderRanking(players, yourRank) {
        if (players.length === 0) {
          rankingList.innerHTML = `<p class="no-players">Aucun pêcheur pour l'instant… Sois le premier !</p>`;
          return;
        }

        const top10 = players.slice(0, 10).map(p => `
          <div class="player-rank ${p.uid === currentUserUid ? 'you' : ''}">
            <div class="rank-num">#${p.rank}</div>
            <div class="player-name">
              ${p.displayName}
              <div class="player-level">${getLevel(p.xp)}</div>
            </div>
            <div class="player-xp">${p.xp} XP</div>
          </div>
        `).join('');

        let footer = '';
        if (yourRank && yourRank > 10) {
          const you = players.find(p => p.uid === currentUserUid);
          footer = `
            <div style="margin-top:25px; text-align:center; color:#00d4aa; font-weight:bold;">
              Ta position : #${yourRank}
            </div>
            <div class="player-rank you">
              <div class="rank-num">#${yourRank}</div>
              <div class="player-name">Toi !</div>
              <div class="player-xp">${you.xp} XP</div>
            </div>`;
        }

        rankingList.innerHTML = top10 + footer;
      }

      function getLevel(xp) {
        if (xp < 50) return "Débutant";
        if (xp < 200) return "Traqueur";
        return "Maître du brochet";
      }
    }
  </script>
</div>
    </section>
  </main>

  <!-- app.js (gère Firebase + init + dashboard + XP) -->
  <script src="app.js"></script>
</body>
</html>
