<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FishTok – Le TikTok de la Pêche Française</title>

  <!-- Même style que ton IA -->
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      --primary: #00d4aa;
      --dark: #001f2e;
      --gradient: linear-gradient(135deg, #00d4aa, #007a6b);
    }
    body {margin:0; background:#000; color:white; font-family:system-ui; overflow-x:hidden;}
    .live-badge {position:fixed;top:15px;left:15px;background:var(--primary);color:#000;padding:10px 18px;border-radius:50px;font-weight:bold;z-index:9999;
      box-shadow:0 4px 20px rgba(0,212,170,0.6);animation:pulse 2s infinite;display:flex;align-items:center;gap:8px;}
    .live-dot {width:12px;height:12px;background:white;border-radius:50%;animation:blink 1.5s infinite;}
    @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    @keyframes blink {0%,100%{opacity:1}50%{opacity:0.3}}

    /* ÉCRAN TIKTOK FULLSCREEN */
    .feed {height:100vh; scroll-snap-type:y mandatory; overflow-y:scroll; scrollbar-width:none;}
    .feed::-webkit-scrollbar {display:none;}
    .reel {
      height:100vh; width:100vw; position:relative; scroll-snap-align:start;
      background:#000; display:flex; align-items:center; justify-content:center;
    }
    .reel video {width:100%; height:100%; object-fit:contain;}
    
    /* Overlay droite (comme TikTok) */
    .actions {
      position:absolute; right:15px; bottom:80px; display:flex; flex-direction:column; gap:18px; align-items:center; z-index:10;
    }
    .action-btn {
      width:56px; height:56px; background:rgba(0,0,0,0.5); border-radius:50%; display:flex; align-items:center; justify-content:center;
      backdrop-filter:blur(10px); border:2px solid rgba(255,255,255,0.2);
    }
    .action-btn.heart {font-size:32px; color:white;}
    .action-btn.heart.liked {color:#ff3040; animation:heartBeat 0.6s;}
    @keyframes heartBeat {0%{transform:scale(1)} 50%{transform:scale(1.4)} 100%{transform:scale(1)}}
    .action-count {color:white; font-weight:bold; margin-top:4px; font-size:14px;}

    /* Bas de reel */
    .reel-info {
      position:absolute; left:15px; bottom:100px; max-width:70%;
    }
    .reel-pseudo {
      font-size:20px; font-weight:bold; text-shadow:0 2px 10px black; margin-bottom:4px;
    }
    .reel-caption {
      font-size:16px; background:rgba(0,0,0,0.6); padding:8px 14px; border-radius:20px; display:inline-block;
      text-shadow:0 1px 6px black;
    }
    .hashtags {color:var(--primary); font-weight:bold;}

    /* Header fixe */
    .header {
      position:fixed; top:0; left:0; width:100%; z-index:999;
      background:linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      padding:15px 20px; display:flex; justify-content:space-between; align-items:center;
    }
    .logo {font-size:24px; font-weight:bold; color:var(--primary);}
    .tabs {display:flex; gap:30px;}
    .tab {font-weight:bold; opacity:0.7;}
    .tab.active {opacity:1; border-bottom:3px solid var(--primary); padding-bottom:5px;}

    /* Bouton + pour poster */
    .add-btn {
      position:fixed; bottom:90px; left:50%; transform:translateX(-50%);
      background:var(--gradient); color:white; width:60px; height:60px; border-radius:50%;
      font-size:36px; border:none; box-shadow:0 8px 30px rgba(0,212,170,0.6); z-index:999;
    }
  </style>

  <!-- Firebase (même version que toi) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>

  <div class="live-badge"><div class="live-dot"></div> FISH<mark style="background:none;color:#ffd700">TOK</mark> LIVE • <span id="onlineCount">0</span> en ligne</div>

  <div class="header">
    <div class="logo">FishTok</div>
    <div class="tabs">
      <div class="tab active">Pour toi</div>
      <div class="tab">Abonnements</div>
      <div class="tab">Défis</div>
    </div>
    <div></div>
  </div>

  <div class="feed" id="feed"></div>

  <button class="add-btn" id="addReelBtn">+</button>

  <script>
    // ==== CONFIG FIREBASE (à coller tes clés Fisher-Force) ====
    const firebaseConfig = {
      apiKey: "XXXXXXXXXXXXXXXXXXXXXXXX",
      authDomain: "fisherforce-ai.firebaseapp.com",
      projectId: "fisherforce-ai",
      // etc… tu recopies juste ton config existante
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    let currentUser = null;
    let reels = [];

    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) loadReels();
    });

    // ==== CHARGEMENT DES REELS (triés par date desc) ====
    async function loadReels() {
      const snap = await db.collection('reels')
        .orderBy('timestamp', 'desc')
        .limit(50)
        .get();

      reels = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
      renderReels();
      updateOnlineCount();
    }

    function renderReels() {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';

      reels.forEach(reel => {
        const div = document.createElement('div');
        div.className = 'reel';
        div.innerHTML = `
          <video src="${reel.videoUrl}" loop playsinline></video>

          <div class="actions">
            <div class="action-btn heart" onclick="toggleLike('${reel.id}', this)">
              ${reel.likes?.includes(currentUser?.uid) ? '♥' : '♡'}
            </div>
            <div class="action-count">${reel.likes?.length || 0}</div>

            <div class="action-btn">Comment</div>
            <div class="action-count">${reel.comments?.length || 0}</div>

            <div class="action-btn">Share</div>
          </div>

          <div class="reel-info">
            <div class="reel-pseudo">@${reel.pseudo || 'pêcheur'}</div>
            <div class="reel-caption">${reel.caption || ''} <span class="hashtags">${reel.hashtags?.join(' ') || ''}</span></div>
          </div>
        `;

        // Play/pause au tap
        div.querySelector('video').addEventListener('click', e => {
          e.target.paused ? e.target.play() : e.target.pause();
        });

        // Autoplay quand 80% visible
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.querySelector('video').play();
            else entry.target.querySelector('video').pause();
          });
        }, {threshold: 0.8});
        observer.observe(div);

        feed.appendChild(div);
      });
    }

    // ==== LIKE ====
    window.toggleLike = async (reelId, btn) => {
      if (!currentUser) return alert("Connecte-toi !");

      const reelRef = db.collection('reels').doc(reelId);
      const reel = reels.find(r => r.id === reelId);

      const likes = reel.likes || [];
      const index = likes.indexOf(currentUser.uid);

      if (index === -1) {
        likes.push(currentUser.uid);
        btn.classList.add('liked');
      } else {
        likes.splice(index, 1);
        btn.classList.remove('liked');
      }

      await reelRef.update({likes});
      reel.likes = likes;
      btn.nextElementSibling.textContent = likes.length;
    }

    // ==== POSTER UNE VIDÉO (même style que ton IA) ====
    document.getElementById('addReelBtn').onclick = () => {
      if (!currentUser) return alert("Connecte-toi avec Google d’abord !");

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'video/*';
      input.capture = 'environment';
      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;

        const caption = prompt("Ligne("Légende de ta prise légendaire ?", "#brochet90 #topwater #sunset");
        const hashtags = caption.match(/#[a-zA-Z0-9àéèêôùçâîûäëïöüÀÉÈÊÔÙÇÂÎÛÄËÏÖÜ]+/g) || [];

        const storageRef = storage.ref('reels/' + Date.now() + '.mp4');
        await storageRef.put(file);

        const videoUrl = await storageRef.getDownloadURL();

        await db.collection('reels').add({
          uid: currentUser.uid,
          pseudo: currentUser.displayName || localStorage.getItem('fisherPseudo') || 'Pêcheur',
          photoURL: currentUser.photoURL,
          caption,
          hashtags,
          videoUrl,
          likes: [],
          comments: [],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("Reel posté ! +300 XP");
        loadReels();
      };
      input.click();
    }

    // ==== COMPTEUR EN LIGNE (comme ton badge live) ====
    function updateOnlineCount() {
      db.collection('users').where('online', '==', true).onSnapshot(snap => {
        document.getElementById('onlineCount').textContent = snap.size;
      });
    }

    // Marque l’utilisateur en ligne
    auth.onAuthStateChanged(user => {
      if (user) {
        db.collection('users').doc(user.uid).set({
          online: true,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge: true});

        window.addEventListener('beforeunload', () => {
          db.collection('users').doc(user.uid).update({online: false});
        });
      }
    });
  </script>
</body>
</html>
